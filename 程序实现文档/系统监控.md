# 系统监控

模块取名为 monitor

- 在线用户
  1. 列表
  2. 强制下线
     > 包含这几个字段：
  ```
  序号
  用户名
  登录 IP
  登录地点
  操作系统
  浏览器类型
  登录时间
  ```
- 登录日志
  1. 列表
  2. 清空日志
     包含这几个字段：
  ```
  序号
  用户名
  登录 IP
  登录地点
  操作系统
  浏览器类型
  登录状态
  登录行为
  登录时间
  ```
- 操作日志
  1. 列表
  2. 清空日志
     包含这几个字段：
  ```
  序号
  操作人员
  所属模块
  操作概要
  操作 IP
  操作地点
  操作系统
  浏览器类型
  操作状态
  操作时间
  ```

以上字段都来自于
vue-pure-admin/src/views/monitor
按照这个项目的代码结构来实现 即可
要求 做到跟他一样 UI 效果 它里面还包含批量删除等功能

路由及 views
程序实现文档/frontend/health-manage/src/router/modules/system.ts 按照这里的写法
文件命名按照 vue-pure-admin/src/views/monitor 他里面的命名来
views 文件夹下新建 monitor 文件夹
文件结构如下

```
monitor/
├── src/
│   ├── components/          # 公共组件
│   ├── views/               # 页面组件
│   │   ├── online/          # 在线用户
│   │   │   ├── OnlineList.vue       # 在线用户列表
│   │   │   └── index.vue
│   │   ├── login-log/       # 登录日志
│   │   │   ├── LoginLogList.vue     # 登录日志列表
│   │   │   └── index.vue
│   │   ├── operation-log/   # 操作日志
│   │   │   ├── OperationLogList.vue # 操作日志列表
│   │   │   └── index.vue
│   │   └── index.vue
```

如果数据库缺少字段请帮我整理迁移文件

---

## 实现进度

### 已完成

- ✅ 数据库表创建（migrations/006_create_monitor_tables.sql）

  - login_logs 表（登录日志）
  - online_users 表（在线用户）
  - system_logs 表扩展字段（操作日志）

- ✅ 后端 API 开发

  - src/controllers/monitorController.ts - 监控控制器
  - src/routes/monitorRoutes.ts - 监控路由
  - 已在 src/app.ts 中注册路由
  - API 接口：
    - GET /api/monitor/online-users - 获取在线用户列表
    - DELETE /api/monitor/online-users/:id - 强制下线
    - GET /api/monitor/login-logs - 获取登录日志列表
    - POST /api/monitor/login-logs/batch-delete - 批量删除登录日志
    - DELETE /api/monitor/login-logs/clear - 清空所有登录日志
    - GET /api/monitor/operation-logs - 获取操作日志列表
    - POST /api/monitor/operation-logs/batch-delete - 批量删除操作日志
    - DELETE /api/monitor/operation-logs/clear - 清空所有操作日志

- ✅ 前端 API 接口文件创建

  - src/api/monitor.ts - 监控模块 API 封装

- ✅ 前端类型定义生成

  - 已运行 pnpm run openapi 生成类型

- ✅ 前端路由配置

  - src/router/modules/monitor.ts - 监控模块路由

- ✅ 更新数据库初始化脚本
  - db/init_database.sql - 添加监控模块表

- ✅ 实现在线用户模块（列表、强制下线）
  - ✅ src/views/monitor/online/hook.tsx - 业务逻辑
  - ✅ src/views/monitor/online/index.vue - 页面组件

- ✅ 实现登录日志模块（列表、批量删除、清空日志）
  - ✅ src/views/monitor/login-log/hook.tsx - 业务逻辑
  - ✅ src/views/monitor/login-log/index.vue - 页面组件

- ✅ 实现操作日志模块（列表、批量删除、清空日志）
  - ✅ src/views/monitor/operation-log/hook.tsx - 业务逻辑
  - ✅ src/views/monitor/operation-log/index.vue - 页面组件

- ✅ 修复已发现的问题
  - ✅ 为所有监控控制器添加完整的 Swagger 注解
  - ✅ 重新生成前端 OpenAPI 类型
  - ✅ 创建 @/views/system/hooks.ts 提供 tagStyle 工具函数
  - ✅ 修复 API 调用类型问题（使用 unwrap 函数）
  - ✅ 在 src/api/monitor.ts 中导出简洁的函数名

### 待完成

- ⏳ 完整功能测试
  - 测试在线用户列表和强制下线功能
  - 测试登录日志列表、批量删除、清空日志功能
  - 测试操作日志列表、批量删除、清空日志功能
  - 测试各种筛选条件和分页功能

### 已修复的问题

- ✅ 服务端 Swagger 注解缺失 - 已为所有 API 接口添加完整注解
- ✅ 前端类型不完整 - 已重新生成 OpenAPI 类型
- ✅ API 调用类型错误 - 已使用 unwrap 函数修复


### bug 列表

  1. 请求网址
http://localhost:8848/api/monitor/online-users?page=1&pageSize=10&username=
请求方法
GET
状态代码
500 Internal Server Error
远程地址
127.0.0.1:8848
引荐来源网址政策
strict-origin-when-cross-origin

2. 请求网址
http://localhost:8848/api/monitor/login-logs?page=1&pageSize=10
请求方法
GET
状态代码
500 Internal Server Error
远程地址
127.0.0.1:8848
引荐来源网址政策
strict-origin-when-cross-origin

3. 请求网址
http://localhost:8848/api/monitor/operation-logs?page=1&pageSize=10
请求方法
GET
状态代码
500 Internal Server Error
远程地址
127.0.0.1:8848
引荐来源网址政策
strict-origin-when-cross-origin

### 待完成

- ✅ 用户列表 添加 分析 按钮 跳转到 dashboard 里
  - ✅ 用户列表页面添加"分析"按钮（仅管理员可见）
  - ✅ 后端stats API支持管理员通过userId参数查看其他用户数据
  - ✅ dashboard组件支持接收userId查询参数
  - ✅ 管理员查看其他用户数据时显示返回按钮
  - ✅ 实现流程：
    1. 如果是管理员或者超级管理员登录，点击用户列表的"分析"按钮，进入dashboard并携带参数userId=xxx，显示该用户的分析数据，页面显示返回按钮可返回到用户列表页面
    2. 如果是普通用户登录，直接进入dashboard不携带参数，显示自己的分析数据
    3. 如果是管理员直接进入dashboard不携带参数，显示管理员自己的分析数据