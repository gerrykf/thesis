# 客户端权限控制方案

## 问题描述

系统有两个前端应用共用同一个后端 API：
- **H5 前端**：面向普通用户，不需要严格的管理员权限控制
- **管理后台**：面向管理员，需要严格的权限控制

之前的问题：
- `/api/admin/*` 路由对所有客户端都要求管理员权限
- H5 用户无法访问某些需要的管理接口
- 管理后台和 H5 共用登录接口，但权限需求不同

## 解决方案

### 方案概述

通过 **HTTP 请求头 `X-Client-Type`** 来标识客户端类型，后端根据客户端类型决定是否需要权限验证。

### 实现步骤

#### 1. 后端 - 修改认证中间件

**文件**: `backend/health-backend/src/middleware/auth.ts`

##### 添加客户端类型识别

```typescript
export interface AuthRequest extends Request {
  user?: {
    userId: number;
    username: string;
    role: string;
  };
  clientType?: 'h5' | 'admin'; // 客户端类型
}

export const authenticateToken = async (
  req: AuthRequest,
  res: Response,
  next: NextFunction
): Promise<void> => {
  // ... 原有的 token 验证逻辑 ...

  // 识别客户端类型（通过自定义请求头）
  const clientType = req.headers['x-client-type'] as string;
  req.clientType = clientType === 'h5' ? 'h5' : 'admin';

  next();
};
```

##### 添加客户端类型检查中间件

```typescript
// 要求必须是管理端客户端访问
export const requireAdminClient = (
  req: AuthRequest,
  res: Response,
  next: NextFunction
): void => {
  if (req.clientType !== 'admin') {
    res.status(403).json({
      success: false,
      message: '该接口仅限管理端访问'
    });
    return;
  }
  next();
};
```

#### 2. 后端 - 修改管理端路由

**文件**: `backend/health-backend/src/routes/adminRoutes.ts`

```typescript
import { authenticateToken, requireRole, requireAdminClient } from '../middleware/auth';

// 管理员认证中间件 - 应用到所有admin路由
router.use(authenticateToken);          // 1. 验证 token
router.use(requireAdminClient);          // 2. 要求必须是管理端客户端
router.use(requireRole('admin', 'super_admin')); // 3. 要求管理员角色
```

#### 3. 前端 H5 - 添加客户端标识

**文件**: `frontend/h5-app/src/utils/request.ts`

```typescript
// 请求拦截器
request.interceptors.request.use(
  (config) => {
    // 从本地存储获取 token
    const token = localStorage.getItem("token");
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }

    // 标识客户端类型为 H5
    config.headers["X-Client-Type"] = "h5";

    // 自动携带语言参数
    const locale = localStorage.getItem("locale") || "zh-CN";
    config.headers["Accept-Language"] = locale;

    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);
```

#### 4. 前端管理后台 - 添加客户端标识

**文件**: `frontend/health-manage/src/utils/request.ts`

```typescript
// 请求拦截器
request.interceptors.request.use(
  config => {
    // 从认证系统获取token
    const tokenData = getToken();
    if (tokenData?.accessToken) {
      config.headers.Authorization = `Bearer ${tokenData.accessToken}`;
    }

    // 标识客户端类型为管理端
    config.headers["X-Client-Type"] = "admin";

    return config;
  },
  error => {
    return Promise.reject(error);
  }
);
```

## 工作原理

### 请求流程

1. **前端发起请求**
   - H5 前端：携带 `X-Client-Type: h5`
   - 管理后台：携带 `X-Client-Type: admin`

2. **后端验证流程**（按中间件顺序执行）

   ```
   请求 → authenticateToken → requireAdminClient → requireRole → 业务逻辑
   ```

   - `authenticateToken`: 验证 JWT token，设置 `req.clientType`
   - `requireAdminClient`: 检查 `req.clientType === 'admin'`，如果不是则返回 403
   - `requireRole`: 检查用户角色是否为 `admin` 或 `super_admin`

3. **结果**
   - ✅ 管理后台 + 管理员用户：通过所有验证，可以访问
   - ❌ H5 前端 + 任何用户：在 `requireAdminClient` 被拦截，返回 403
   - ❌ 管理后台 + 普通用户：在 `requireRole` 被拦截，返回 403

## 权限控制矩阵

| 客户端类型 | 用户角色 | 登录接口 | `/api/admin/*` | 其他接口 |
|----------|---------|---------|---------------|---------|
| H5 | 普通用户 | ✅ | ❌ 403 | ✅ |
| H5 | 管理员 | ✅ | ❌ 403 | ✅ |
| 管理后台 | 普通用户 | ❌ 403 | ❌ 403 | ✅ |
| 管理后台 | 管理员 | ✅ | ✅ | ✅ |
| 管理后台 | 超级管理员 | ✅ | ✅ | ✅ |

## 优势

1. **清晰的权限边界**
   - H5 和管理后台的权限完全隔离
   - 即使普通用户拿到 token 也无法通过 H5 访问管理接口

2. **灵活性高**
   - 可以为不同客户端定制不同的权限策略
   - 容易扩展，比如添加新的客户端类型（如小程序、桌面应用）

3. **安全性好**
   - 客户端类型标识无法被轻易篡改（配合 HTTPS）
   - 即使被篡改，仍需要通过角色权限验证

4. **向后兼容**
   - 如果请求头不包含 `X-Client-Type`，默认视为 `admin`
   - 不影响现有的 API 调用

## 登录接口权限控制

为了进一步增强安全性，我们在登录接口中也添加了客户端类型验证：

**文件**: `backend/health-backend/src/controllers/authController.ts`

```typescript
// 在登录接口中，密码验证通过后，生成 token 之前
const clientType = req.headers['x-client-type'] as string;
if (clientType === 'admin') {
  // 管理后台登录：只允许管理员和超级管理员
  if (user.role !== 'admin' && user.role !== 'super_admin') {
    res.status(403).json({
      success: false,
      message: "该账号无权访问管理后台",
    });
    return;
  }
}
```

**作用**：
- 当用户尝试通过管理后台登录时（`X-Client-Type: admin`）
- 如果用户角色是普通用户（`role='user'`），直接在登录阶段就拒绝
- 只有管理员（`admin`）和超级管理员（`super_admin`）才能登录管理后台
- H5 用户不受影响，可以正常登录

## 测试验证

### 登录接口测试

1. **普通用户尝试登录管理后台（应该被拒绝）**
   ```bash
   curl -X POST 'http://localhost:3000/api/auth/login' \
     -H 'Content-Type: application/json' \
     -H 'X-Client-Type: admin' \
     -d '{"username":"testuser","password":"test123456"}'

   # 实际结果: ✅ {"success":false,"message":"该账号无权访问管理后台"}
   ```

2. **管理员登录管理后台（应该成功）**
   ```bash
   curl -X POST 'http://localhost:3000/api/auth/login' \
     -H 'Content-Type: application/json' \
     -H 'X-Client-Type: admin' \
     -d '{"username":"sadmin","password":"sadmin666"}'

   # 实际结果: ✅ {"success":true,"message":"登录成功","data":{...}}
   ```

3. **普通用户登录 H5（应该成功）**
   ```bash
   curl -X POST 'http://localhost:3000/api/auth/login' \
     -H 'Content-Type: application/json' \
     -H 'X-Client-Type: h5' \
     -d '{"username":"testuser","password":"test123456"}'

   # 实际结果: ✅ {"success":true,"message":"登录成功","data":{...}}
   ```

### 管理接口访问测试

1. **H5 前端访问管理接口**
   ```bash
   curl -X GET "http://localhost:8848/api/admin/menus" \
     -H "X-Client-Type: h5" \
     -H "Authorization: Bearer {token}"

   # 预期结果: 403 该接口仅限管理端访问
   ```

2. **管理后台访问管理接口（普通用户）**
   ```bash
   curl -X GET "http://localhost:8848/api/admin/menus" \
     -H "X-Client-Type: admin" \
     -H "Authorization: Bearer {user_token}"

   # 预期结果: 403 需要admin或super_admin权限
   ```

3. **管理后台访问管理接口（管理员）**
   ```bash
   curl -X GET "http://localhost:8848/api/admin/menus" \
     -H "X-Client-Type: admin" \
     -H "Authorization: Bearer {admin_token}"

   # 预期结果: 200 成功返回菜单数据
   ```

## 注意事项

1. **请求头命名**
   - 使用 `X-Client-Type` 作为自定义请求头
   - 值为 `h5` 或 `admin`

2. **默认行为**
   - 如果没有 `X-Client-Type` 请求头，默认视为 `admin`
   - 这样可以保证向后兼容

3. **HTTPS 部署**
   - 生产环境务必使用 HTTPS
   - 防止请求头被中间人攻击篡改

4. **错误消息**
   - 登录时普通用户访问管理后台：`该账号无权访问管理后台`
   - 客户端类型不匹配：`该接口仅限管理端访问`
   - 角色权限不足：`需要admin或super_admin权限`

## 相关文件

- `backend/health-backend/src/middleware/auth.ts` - 认证中间件
- `backend/health-backend/src/controllers/authController.ts` - 登录控制器（包含登录时的客户端类型验证）
- `backend/health-backend/src/routes/adminRoutes.ts` - 管理端路由
- `frontend/h5-app/src/utils/request.ts` - H5 请求配置
- `frontend/health-manage/src/utils/request.ts` - 管理后台请求配置

## 更新日期

2025-10-15
