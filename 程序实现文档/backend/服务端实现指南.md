# å¥åº·ç®¡ç†ç³»ç»ŸæœåŠ¡ç«¯å®ç°æŒ‡å—

## 1. é¡¹ç›®åˆå§‹åŒ–ä¸ç¯å¢ƒæ­å»º

### 1.1 åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
```bash
# åˆ›å»ºé¡¹ç›®æ ¹ç›®å½•
mkdir health-backend
cd health-backend

# åˆå§‹åŒ–npmé¡¹ç›®
npm init -y

# åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
mkdir -p src/{config,controllers,models,routes,middleware,utils,validators}
mkdir -p docs
mkdir -p scripts
mkdir -p logs

# ç›®å½•ç»“æ„è¯´æ˜
health-backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/          # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ controllers/     # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ models/         # æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ routes/         # è·¯ç”±å±‚
â”‚   â”œâ”€â”€ middleware/     # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ validators/     # æ•°æ®éªŒè¯
â”œâ”€â”€ docs/               # APIæ–‡æ¡£
â”œâ”€â”€ scripts/            # è„šæœ¬æ–‡ä»¶
â”œâ”€â”€ logs/              # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ .env               # ç¯å¢ƒå˜é‡
â”œâ”€â”€ .gitignore         # Gitå¿½ç•¥æ–‡ä»¶
â””â”€â”€ README.md          # é¡¹ç›®è¯´æ˜
```

### 1.2 å®‰è£…é¡¹ç›®ä¾èµ–
```bash
# æ ¸å¿ƒæ¡†æ¶å’Œæ•°æ®åº“
npm install express mysql2 bcryptjs jsonwebtoken
npm install cors dotenv helmet morgan
npm install joi express-validator

# å¼€å‘å·¥å…·
npm install -D nodemon @types/node typescript ts-node
npm install -D @types/express @types/bcryptjs @types/jsonwebtoken
npm install -D @types/cors eslint prettier

# APIæ–‡æ¡£å·¥å…·
npm install swagger-jsdoc swagger-ui-express
npm install -D @types/swagger-jsdoc @types/swagger-ui-express
```

### 1.3 é…ç½®package.jsonè„šæœ¬
```json
{
  "name": "health-backend",
  "version": "1.0.0",
  "description": "å¥åº·ç®¡ç†ç³»ç»Ÿåç«¯API",
  "main": "dist/app.js",
  "scripts": {
    "dev": "nodemon --exec ts-node src/app.ts",
    "build": "tsc",
    "start": "node dist/app.js",
    "lint": "eslint src/**/*.ts",
    "format": "prettier --write src/**/*.ts",
    "db:create": "node scripts/createDatabase.js",
    "db:migrate": "node scripts/migrate.js",
    "db:seed": "node scripts/seed.js"
  },
  "keywords": ["health", "api", "express", "mysql"],
  "author": "Your Name",
  "license": "MIT"
}
```

### 1.4 TypeScripté…ç½®
```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "removeComments": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noImplicitThis": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "logs"]
}
```

## 2. æ•°æ®åº“è®¾è®¡ä¸é…ç½®

### 2.1 ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env æ–‡ä»¶
NODE_ENV=development
PORT=3000

# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=health_management

# JWTé…ç½®
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=7d

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FILE=logs/app.log

# CORSé…ç½®
CORS_ORIGIN=http://localhost:5173,http://localhost:8080

# ä¸Šä¼ é…ç½®
UPLOAD_PATH=uploads
MAX_FILE_SIZE=5242880
```

### 2.2 æ•°æ®åº“è¿æ¥é…ç½®
```typescript
// src/config/database.ts
import mysql from 'mysql2/promise';
import dotenv from 'dotenv';

dotenv.config();

const dbConfig = {
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '3306'),
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || '',
  database: process.env.DB_NAME || 'health_management',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
  acquireTimeout: 60000,
  timeout: 60000,
  reconnect: true
};

// åˆ›å»ºè¿æ¥æ± 
export const db = mysql.createPool(dbConfig);

// æµ‹è¯•æ•°æ®åº“è¿æ¥
export const testConnection = async (): Promise<void> => {
  try {
    const connection = await db.getConnection();
    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
    connection.release();
  } catch (error) {
    console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', error);
    process.exit(1);
  }
};

export default db;
```

### 2.3 æ•°æ®åº“è¡¨ç»“æ„
```sql
-- scripts/schema.sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS health_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE health_management;

-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·å',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç (åŠ å¯†)',
    nickname VARCHAR(50) COMMENT 'æ˜µç§°',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    email VARCHAR(100) COMMENT 'é‚®ç®±',
    gender ENUM('male', 'female') COMMENT 'æ€§åˆ«',
    birth_date DATE COMMENT 'å‡ºç”Ÿæ—¥æœŸ',
    height DECIMAL(5,2) COMMENT 'èº«é«˜(cm)',
    target_weight DECIMAL(5,2) COMMENT 'ç›®æ ‡ä½“é‡(kg)',
    avatar VARCHAR(255) COMMENT 'å¤´åƒURL',
    role ENUM('user', 'admin') DEFAULT 'user' COMMENT 'ç”¨æˆ·è§’è‰²',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æ¿€æ´»',
    last_login_at TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone)
) COMMENT 'ç”¨æˆ·è¡¨';

-- å¥åº·è®°å½•è¡¨
CREATE TABLE health_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',
    record_date DATE NOT NULL COMMENT 'è®°å½•æ—¥æœŸ',
    weight DECIMAL(5,2) COMMENT 'ä½“é‡(kg)',
    exercise_duration INT COMMENT 'è¿åŠ¨æ—¶é•¿(åˆ†é’Ÿ)',
    exercise_type VARCHAR(50) COMMENT 'è¿åŠ¨ç±»å‹',
    sleep_hours DECIMAL(4,2) COMMENT 'ç¡çœ æ—¶é•¿(å°æ—¶)',
    sleep_quality ENUM('excellent', 'good', 'fair', 'poor') COMMENT 'ç¡çœ è´¨é‡',
    mood ENUM('excellent', 'good', 'fair', 'poor') COMMENT 'å¿ƒæƒ…çŠ¶æ€',
    notes TEXT COMMENT 'å¤‡æ³¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_date (user_id, record_date),
    INDEX idx_user_date (user_id, record_date),
    INDEX idx_record_date (record_date)
) COMMENT 'å¥åº·è®°å½•è¡¨';

-- é£Ÿç‰©è¡¨
CREATE TABLE foods (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT 'é£Ÿç‰©åç§°',
    name_en VARCHAR(100) COMMENT 'è‹±æ–‡åç§°',
    category VARCHAR(50) NOT NULL COMMENT 'é£Ÿç‰©åˆ†ç±»',
    brand VARCHAR(100) COMMENT 'å“ç‰Œ',
    calories_per_100g DECIMAL(8,2) NOT NULL COMMENT 'æ¯100gçƒ­é‡(kcal)',
    protein_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT 'æ¯100gè›‹ç™½è´¨(g)',
    fat_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT 'æ¯100gè„‚è‚ª(g)',
    carbs_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT 'æ¯100gç¢³æ°´åŒ–åˆç‰©(g)',
    fiber_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT 'æ¯100gçº¤ç»´(g)',
    sodium_per_100g DECIMAL(8,2) DEFAULT 0 COMMENT 'æ¯100gé’ (mg)',
    sugar_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT 'æ¯100gç³–(g)',
    image_url VARCHAR(255) COMMENT 'é£Ÿç‰©å›¾ç‰‡URL',
    barcode VARCHAR(50) COMMENT 'æ¡å½¢ç ',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    created_by INT COMMENT 'åˆ›å»ºè€…ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    INDEX idx_name (name),
    INDEX idx_category (category),
    INDEX idx_barcode (barcode),
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
) COMMENT 'é£Ÿç‰©è¡¨';

-- é¥®é£Ÿè®°å½•è¡¨
CREATE TABLE diet_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',
    food_id INT NOT NULL COMMENT 'é£Ÿç‰©ID',
    record_date DATE NOT NULL COMMENT 'è®°å½•æ—¥æœŸ',
    meal_type ENUM('breakfast', 'lunch', 'dinner', 'snack') NOT NULL COMMENT 'é¤æ¬¡ç±»å‹',
    quantity DECIMAL(8,2) NOT NULL COMMENT 'é£Ÿç”¨é‡(g)',
    calories DECIMAL(8,2) NOT NULL COMMENT 'çƒ­é‡(kcal)',
    protein DECIMAL(6,2) DEFAULT 0 COMMENT 'è›‹ç™½è´¨(g)',
    fat DECIMAL(6,2) DEFAULT 0 COMMENT 'è„‚è‚ª(g)',
    carbs DECIMAL(6,2) DEFAULT 0 COMMENT 'ç¢³æ°´åŒ–åˆç‰©(g)',
    notes VARCHAR(255) COMMENT 'å¤‡æ³¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE RESTRICT,
    INDEX idx_user_date (user_id, record_date),
    INDEX idx_meal_type (meal_type),
    INDEX idx_food_id (food_id)
) COMMENT 'é¥®é£Ÿè®°å½•è¡¨';

-- ç³»ç»Ÿæ—¥å¿—è¡¨
CREATE TABLE system_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT COMMENT 'ç”¨æˆ·ID',
    action VARCHAR(100) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    resource VARCHAR(100) COMMENT 'æ“ä½œèµ„æº',
    resource_id INT COMMENT 'èµ„æºID',
    ip_address VARCHAR(45) COMMENT 'IPåœ°å€',
    user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†',
    request_data JSON COMMENT 'è¯·æ±‚æ•°æ®',
    response_status INT COMMENT 'å“åº”çŠ¶æ€ç ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) COMMENT 'ç³»ç»Ÿæ—¥å¿—è¡¨';
```

## 3. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 3.1 åº”ç”¨ä¸»å…¥å£
```typescript
// src/app.ts
import express, { Application, Request, Response, NextFunction } from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';
import dotenv from 'dotenv';
import path from 'path';
import fs from 'fs';
import swaggerJSDoc from 'swagger-jsdoc';
import swaggerUi from 'swagger-ui-express';

import { testConnection } from './config/database';
import { errorHandler, notFound } from './middleware/errorHandler';
import { requestLogger } from './middleware/logger';

// è·¯ç”±å¯¼å…¥
import authRoutes from './routes/authRoutes';
import healthRoutes from './routes/healthRoutes';
import foodRoutes from './routes/foodRoutes';
import dietRoutes from './routes/dietRoutes';
import adminRoutes from './routes/adminRoutes';
import statsRoutes from './routes/statsRoutes';

// åŠ è½½ç¯å¢ƒå˜é‡
dotenv.config();

const app: Application = express();
const PORT = process.env.PORT || 3000;

// ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
const logsDir = path.join(__dirname, '../logs');
if (!fs.existsSync(logsDir)) {
  fs.mkdirSync(logsDir, { recursive: true });
}

// Swaggeré…ç½®
const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'å¥åº·ç®¡ç†ç³»ç»Ÿ API',
      version: '1.0.0',
      description: 'åŸºäºNode.js+Express+MySQLçš„å¥åº·ç®¡ç†ç³»ç»Ÿåç«¯APIæ–‡æ¡£',
      contact: {
        name: 'APIæ”¯æŒ',
        email: 'support@health-system.com'
      },
      license: {
        name: 'MIT',
        url: 'https://opensource.org/licenses/MIT'
      }
    },
    servers: [
      {
        url: `http://localhost:${PORT}`,
        description: 'å¼€å‘ç¯å¢ƒ'
      },
      {
        url: 'https://api.health-system.com',
        description: 'ç”Ÿäº§ç¯å¢ƒ'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT'
        }
      }
    },
    security: [
      {
        bearerAuth: []
      }
    ]
  },
  apis: ['./src/routes/*.ts', './src/controllers/*.ts'] // Swaggeræ³¨é‡Šæ–‡ä»¶è·¯å¾„
};

const swaggerSpec = swaggerJSDoc(swaggerOptions);

// ä¸­é—´ä»¶é…ç½®
app.use(helmet()); // å®‰å…¨å¤´è®¾ç½®
app.use(cors({
  origin: process.env.CORS_ORIGIN?.split(',') || ['http://localhost:5173'],
  credentials: true
}));

// æ—¥å¿—ä¸­é—´ä»¶
app.use(morgan('combined', {
  stream: fs.createWriteStream(path.join(logsDir, 'access.log'), { flags: 'a' })
}));
app.use(morgan('dev')); // æ§åˆ¶å°æ—¥å¿—

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// é™æ€æ–‡ä»¶æœåŠ¡
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));

// è‡ªå®šä¹‰è¯·æ±‚æ—¥å¿—
app.use(requestLogger);

// APIæ–‡æ¡£è·¯ç”±
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec, {
  explorer: true,
  customCss: '.swagger-ui .topbar { display: none }',
  customSiteTitle: 'å¥åº·ç®¡ç†ç³»ç»Ÿ API æ–‡æ¡£'
}));

// å¥åº·æ£€æŸ¥è·¯ç”±
app.get('/health', (req: Request, res: Response) => {
  res.status(200).json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    environment: process.env.NODE_ENV || 'development',
    version: '1.0.0'
  });
});

// APIè·¯ç”±
app.use('/api/auth', authRoutes);
app.use('/api/health', healthRoutes);
app.use('/api/foods', foodRoutes);
app.use('/api/diet', dietRoutes);
app.use('/api/admin', adminRoutes);
app.use('/api/stats', statsRoutes);

// APIæ ¹è·¯å¾„
app.get('/api', (req: Request, res: Response) => {
  res.json({
    message: 'å¥åº·ç®¡ç†ç³»ç»Ÿ API',
    version: '1.0.0',
    documentation: '/api-docs',
    endpoints: {
      auth: '/api/auth',
      health: '/api/health',
      foods: '/api/foods',
      diet: '/api/diet',
      admin: '/api/admin',
      stats: '/api/stats'
    }
  });
});

// 404å¤„ç†
app.use(notFound);

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use(errorHandler);

// å¯åŠ¨æœåŠ¡å™¨
const startServer = async (): Promise<void> => {
  try {
    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    await testConnection();

    app.listen(PORT, () => {
      console.log(`ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:${PORT}`);
      console.log(`ğŸ“š APIæ–‡æ¡£è®¿é—®: http://localhost:${PORT}/api-docs`);
      console.log(`ğŸ¥ å¥åº·æ£€æŸ¥: http://localhost:${PORT}/health`);
      console.log(`ğŸ“‹ APIæ ¹è·¯å¾„: http://localhost:${PORT}/api`);
      console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV || 'development'}`);
    });
  } catch (error) {
    console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);
    process.exit(1);
  }
};

// ä¼˜é›…å…³é—­
process.on('SIGTERM', () => {
  console.log('ğŸ‘‹ æ”¶åˆ°SIGTERMä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­æœåŠ¡å™¨...');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('ğŸ‘‹ æ”¶åˆ°SIGINTä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­æœåŠ¡å™¨...');
  process.exit(0);
});

// å¯åŠ¨åº”ç”¨
startServer();

export default app;
```

### 3.2 è®¤è¯ä¸­é—´ä»¶
```typescript
// src/middleware/auth.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import { db } from '../config/database';

export interface AuthRequest extends Request {
  user?: {
    userId: number;
    username: string;
    role: string;
  };
}

export const authenticateToken = async (
  req: AuthRequest,
  res: Response,
  next: NextFunction
): Promise<void> => {
  try {
    const authHeader = req.headers.authorization;
    const token = authHeader && authHeader.split(' ')[1];

    if (!token) {
      res.status(401).json({
        success: false,
        message: 'è®¿é—®ä»¤ç‰Œç¼ºå¤±'
      });
      return;
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET as string) as any;

    // éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨ä¸”æ¿€æ´»
    const [rows] = await db.execute(
      'SELECT id, username, role, is_active FROM users WHERE id = ?',
      [decoded.userId]
    );

    const users = rows as any[];
    if (users.length === 0 || !users[0].is_active) {
      res.status(401).json({
        success: false,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨'
      });
      return;
    }

    req.user = {
      userId: decoded.userId,
      username: decoded.username,
      role: users[0].role
    };

    next();
  } catch (error) {
    if (error instanceof jwt.TokenExpiredError) {
      res.status(401).json({
        success: false,
        message: 'ä»¤ç‰Œå·²è¿‡æœŸ'
      });
    } else if (error instanceof jwt.JsonWebTokenError) {
      res.status(401).json({
        success: false,
        message: 'æ— æ•ˆçš„ä»¤ç‰Œ'
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'ä»¤ç‰ŒéªŒè¯å¤±è´¥'
      });
    }
  }
};

export const requireAdmin = (
  req: AuthRequest,
  res: Response,
  next: NextFunction
): void => {
  if (req.user?.role !== 'admin') {
    res.status(403).json({
      success: false,
      message: 'éœ€è¦ç®¡ç†å‘˜æƒé™'
    });
    return;
  }
  next();
};
```

### 3.3 ç”¨æˆ·è®¤è¯æ§åˆ¶å™¨
```typescript
// src/controllers/authController.ts
import { Request, Response } from 'express';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { validationResult } from 'express-validator';
import { db } from '../config/database';
import { AuthRequest } from '../middleware/auth';

/**
 * @swagger
 * components:
 *   schemas:
 *     User:
 *       type: object
 *       properties:
 *         id:
 *           type: integer
 *           description: ç”¨æˆ·ID
 *         username:
 *           type: string
 *           description: ç”¨æˆ·å
 *         nickname:
 *           type: string
 *           description: æ˜µç§°
 *         email:
 *           type: string
 *           description: é‚®ç®±
 *         role:
 *           type: string
 *           enum: [user, admin]
 *           description: ç”¨æˆ·è§’è‰²
 *     LoginRequest:
 *       type: object
 *       required:
 *         - username
 *         - password
 *       properties:
 *         username:
 *           type: string
 *           description: ç”¨æˆ·å
 *         password:
 *           type: string
 *           description: å¯†ç 
 *     RegisterRequest:
 *       type: object
 *       required:
 *         - username
 *         - password
 *         - nickname
 *       properties:
 *         username:
 *           type: string
 *           description: ç”¨æˆ·å
 *         password:
 *           type: string
 *           description: å¯†ç 
 *         nickname:
 *           type: string
 *           description: æ˜µç§°
 *         email:
 *           type: string
 *           description: é‚®ç®±
 */

/**
 * @swagger
 * /api/auth/register:
 *   post:
 *     summary: ç”¨æˆ·æ³¨å†Œ
 *     tags: [ç”¨æˆ·è®¤è¯]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/RegisterRequest'
 *     responses:
 *       201:
 *         description: æ³¨å†ŒæˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 message:
 *                   type: string
 *                 data:
 *                   type: object
 *                   properties:
 *                     userId:
 *                       type: integer
 *       400:
 *         description: è¯·æ±‚å‚æ•°é”™è¯¯
 *       409:
 *         description: ç”¨æˆ·åå·²å­˜åœ¨
 */
export const register = async (req: Request, res: Response): Promise<void> => {
  try {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      res.status(400).json({
        success: false,
        message: 'å‚æ•°éªŒè¯å¤±è´¥',
        errors: errors.array()
      });
      return;
    }

    const { username, password, nickname, email } = req.body;

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    const [existingUsers] = await db.execute(
      'SELECT id FROM users WHERE username = ? OR email = ?',
      [username, email]
    );

    if ((existingUsers as any[]).length > 0) {
      res.status(409).json({
        success: false,
        message: 'ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨'
      });
      return;
    }

    // å¯†ç åŠ å¯†
    const saltRounds = 12;
    const hashedPassword = await bcrypt.hash(password, saltRounds);

    // åˆ›å»ºç”¨æˆ·
    const [result] = await db.execute(
      'INSERT INTO users (username, password, nickname, email) VALUES (?, ?, ?, ?)',
      [username, hashedPassword, nickname, email]
    );

    const userId = (result as any).insertId;

    res.status(201).json({
      success: true,
      message: 'æ³¨å†ŒæˆåŠŸ',
      data: { userId }
    });
  } catch (error) {
    console.error('æ³¨å†Œé”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
};

/**
 * @swagger
 * /api/auth/login:
 *   post:
 *     summary: ç”¨æˆ·ç™»å½•
 *     tags: [ç”¨æˆ·è®¤è¯]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/LoginRequest'
 *     responses:
 *       200:
 *         description: ç™»å½•æˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 message:
 *                   type: string
 *                 data:
 *                   type: object
 *                   properties:
 *                     token:
 *                       type: string
 *                     user:
 *                       $ref: '#/components/schemas/User'
 *       400:
 *         description: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
 *       401:
 *         description: è´¦å·å·²è¢«ç¦ç”¨
 */
export const login = async (req: Request, res: Response): Promise<void> => {
  try {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      res.status(400).json({
        success: false,
        message: 'å‚æ•°éªŒè¯å¤±è´¥',
        errors: errors.array()
      });
      return;
    }

    const { username, password } = req.body;

    // æŸ¥æ‰¾ç”¨æˆ·
    const [rows] = await db.execute(
      'SELECT id, username, password, nickname, email, role, is_active FROM users WHERE username = ?',
      [username]
    );

    const users = rows as any[];
    if (users.length === 0) {
      res.status(400).json({
        success: false,
        message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
      });
      return;
    }

    const user = users[0];

    // æ£€æŸ¥è´¦å·æ˜¯å¦è¢«ç¦ç”¨
    if (!user.is_active) {
      res.status(401).json({
        success: false,
        message: 'è´¦å·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
      });
      return;
    }

    // éªŒè¯å¯†ç 
    const isPasswordValid = await bcrypt.compare(password, user.password);
    if (!isPasswordValid) {
      res.status(400).json({
        success: false,
        message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
      });
      return;
    }

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
    await db.execute(
      'UPDATE users SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?',
      [user.id]
    );

    // ç”ŸæˆJWTä»¤ç‰Œ
    const token = jwt.sign(
      {
        userId: user.id,
        username: user.username,
        role: user.role
      },
      process.env.JWT_SECRET as string,
      { expiresIn: process.env.JWT_EXPIRES_IN || '7d' }
    );

    // è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…å«å¯†ç ï¼‰
    const { password: _, ...userWithoutPassword } = user;

    res.json({
      success: true,
      message: 'ç™»å½•æˆåŠŸ',
      data: {
        token,
        user: userWithoutPassword
      }
    });
  } catch (error) {
    console.error('ç™»å½•é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
};

/**
 * @swagger
 * /api/auth/profile:
 *   get:
 *     summary: è·å–ç”¨æˆ·ä¿¡æ¯
 *     tags: [ç”¨æˆ·è®¤è¯]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: è·å–æˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   $ref: '#/components/schemas/User'
 */
export const getProfile = async (req: AuthRequest, res: Response): Promise<void> => {
  try {
    const [rows] = await db.execute(
      `SELECT id, username, nickname, email, phone, gender, birth_date,
       height, target_weight, avatar, role, created_at, last_login_at
       FROM users WHERE id = ?`,
      [req.user?.userId]
    );

    const users = rows as any[];
    if (users.length === 0) {
      res.status(404).json({
        success: false,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
      return;
    }

    res.json({
      success: true,
      data: users[0]
    });
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
};

/**
 * @swagger
 * /api/auth/profile:
 *   put:
 *     summary: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
 *     tags: [ç”¨æˆ·è®¤è¯]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               nickname:
 *                 type: string
 *               email:
 *                 type: string
 *               phone:
 *                 type: string
 *               gender:
 *                 type: string
 *                 enum: [male, female]
 *               birth_date:
 *                 type: string
 *                 format: date
 *               height:
 *                 type: number
 *               target_weight:
 *                 type: number
 *     responses:
 *       200:
 *         description: æ›´æ–°æˆåŠŸ
 */
export const updateProfile = async (req: AuthRequest, res: Response): Promise<void> => {
  try {
    const allowedFields = ['nickname', 'email', 'phone', 'gender', 'birth_date', 'height', 'target_weight'];
    const updates: string[] = [];
    const values: any[] = [];

    // æ„å»ºåŠ¨æ€æ›´æ–°SQL
    for (const field of allowedFields) {
      if (req.body[field] !== undefined) {
        updates.push(`${field} = ?`);
        values.push(req.body[field]);
      }
    }

    if (updates.length === 0) {
      res.status(400).json({
        success: false,
        message: 'æ²¡æœ‰éœ€è¦æ›´æ–°çš„å­—æ®µ'
      });
      return;
    }

    values.push(req.user?.userId);

    await db.execute(
      `UPDATE users SET ${updates.join(', ')} WHERE id = ?`,
      values
    );

    res.json({
      success: true,
      message: 'ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ'
    });
  } catch (error) {
    console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
};
```

### 3.4 è·¯ç”±é…ç½®
```typescript
// src/routes/authRoutes.ts
import { Router } from 'express';
import { body } from 'express-validator';
import { register, login, getProfile, updateProfile } from '../controllers/authController';
import { authenticateToken } from '../middleware/auth';

const router = Router();

// æ³¨å†ŒéªŒè¯è§„åˆ™
const registerValidation = [
  body('username')
    .isLength({ min: 3, max: 50 })
    .withMessage('ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50å­—ç¬¦ä¹‹é—´')
    .matches(/^[a-zA-Z0-9_]+$/)
    .withMessage('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿'),
  body('password')
    .isLength({ min: 6, max: 50 })
    .withMessage('å¯†ç é•¿åº¦å¿…é¡»åœ¨6-50å­—ç¬¦ä¹‹é—´'),
  body('nickname')
    .isLength({ min: 1, max: 50 })
    .withMessage('æ˜µç§°é•¿åº¦å¿…é¡»åœ¨1-50å­—ç¬¦ä¹‹é—´'),
  body('email')
    .optional()
    .isEmail()
    .withMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€')
];

// ç™»å½•éªŒè¯è§„åˆ™
const loginValidation = [
  body('username').notEmpty().withMessage('ç”¨æˆ·åä¸èƒ½ä¸ºç©º'),
  body('password').notEmpty().withMessage('å¯†ç ä¸èƒ½ä¸ºç©º')
];

// è·¯ç”±å®šä¹‰
router.post('/register', registerValidation, register);
router.post('/login', loginValidation, login);
router.get('/profile', authenticateToken, getProfile);
router.put('/profile', authenticateToken, updateProfile);

export default router;
```

## 4. Swagger APIæ–‡æ¡£é…ç½®

### 4.1 å®Œæ•´çš„Swaggeré…ç½®
```typescript
// src/config/swagger.ts
import swaggerJSDoc from 'swagger-jsdoc';

const swaggerOptions: swaggerJSDoc.Options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'å¥åº·ç®¡ç†ç³»ç»Ÿ API',
      version: '1.0.0',
      description: `
        åŸºäºNode.js+Express+MySQLçš„å¥åº·ç®¡ç†ç³»ç»Ÿåç«¯APIæ–‡æ¡£

        ## åŠŸèƒ½ç‰¹æ€§
        - ç”¨æˆ·è®¤è¯ä¸æˆæƒ
        - å¥åº·æ•°æ®è®°å½•ä¸ç®¡ç†
        - é¥®é£Ÿè®°å½•ä¸è¥å…»åˆ†æ
        - æ•°æ®ç»Ÿè®¡ä¸è¶‹åŠ¿åˆ†æ
        - ç³»ç»Ÿç®¡ç†åŠŸèƒ½

        ## è®¤è¯æ–¹å¼
        ä½¿ç”¨JWT Bearer Tokenè¿›è¡Œè®¤è¯ï¼Œåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ ï¼š
        \`Authorization: Bearer <your-token>\`
      `,
      contact: {
        name: 'APIæ”¯æŒ',
        email: 'support@health-system.com',
        url: 'https://github.com/your-repo'
      },
      license: {
        name: 'MIT',
        url: 'https://opensource.org/licenses/MIT'
      }
    },
    servers: [
      {
        url: 'http://localhost:3000',
        description: 'å¼€å‘ç¯å¢ƒ'
      },
      {
        url: 'https://api.health-system.com',
        description: 'ç”Ÿäº§ç¯å¢ƒ'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
          description: 'JWTè®¤è¯ï¼Œæ ¼å¼ï¼šBearer <token>'
        }
      },
      schemas: {
        Error: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: false
            },
            message: {
              type: 'string',
              example: 'é”™è¯¯æè¿°'
            },
            errors: {
              type: 'array',
              items: {
                type: 'object'
              }
            }
          }
        },
        Success: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: true
            },
            message: {
              type: 'string',
              example: 'æ“ä½œæˆåŠŸ'
            },
            data: {
              type: 'object'
            }
          }
        }
      },
      responses: {
        Unauthorized: {
          description: 'æœªæˆæƒ',
          content: {
            'application/json': {
              schema: {
                $ref: '#/components/schemas/Error'
              }
            }
          }
        },
        Forbidden: {
          description: 'ç¦æ­¢è®¿é—®',
          content: {
            'application/json': {
              schema: {
                $ref: '#/components/schemas/Error'
              }
            }
          }
        },
        NotFound: {
          description: 'èµ„æºä¸å­˜åœ¨',
          content: {
            'application/json': {
              schema: {
                $ref: '#/components/schemas/Error'
              }
            }
          }
        },
        ValidationError: {
          description: 'å‚æ•°éªŒè¯é”™è¯¯',
          content: {
            'application/json': {
              schema: {
                $ref: '#/components/schemas/Error'
              }
            }
          }
        },
        ServerError: {
          description: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
          content: {
            'application/json': {
              schema: {
                $ref: '#/components/schemas/Error'
              }
            }
          }
        }
      }
    },
    security: [
      {
        bearerAuth: []
      }
    ],
    tags: [
      {
        name: 'ç”¨æˆ·è®¤è¯',
        description: 'ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¸ªäººä¿¡æ¯ç®¡ç†'
      },
      {
        name: 'å¥åº·è®°å½•',
        description: 'å¥åº·æ•°æ®çš„è®°å½•ä¸ç®¡ç†'
      },
      {
        name: 'é£Ÿç‰©ç®¡ç†',
        description: 'é£Ÿç‰©æ•°æ®åº“ç®¡ç†'
      },
      {
        name: 'é¥®é£Ÿè®°å½•',
        description: 'é¥®é£Ÿè®°å½•ä¸è¥å…»åˆ†æ'
      },
      {
        name: 'æ•°æ®ç»Ÿè®¡',
        description: 'å¥åº·æ•°æ®ç»Ÿè®¡ä¸åˆ†æ'
      },
      {
        name: 'ç³»ç»Ÿç®¡ç†',
        description: 'ç®¡ç†å‘˜åŠŸèƒ½'
      }
    ]
  },
  apis: [
    './src/routes/*.ts',
    './src/controllers/*.ts',
    './src/models/*.ts'
  ]
};

export const swaggerSpec = swaggerJSDoc(swaggerOptions);
```

### 4.2 å¯åŠ¨è„šæœ¬å’Œéƒ¨ç½²
```bash
# scripts/start.sh
#!/bin/bash

echo "ğŸš€ å¯åŠ¨å¥åº·ç®¡ç†ç³»ç»Ÿåç«¯æœåŠ¡..."

# æ£€æŸ¥Node.jsç‰ˆæœ¬
NODE_VERSION=$(node -v)
echo "ğŸ“¦ Node.jsç‰ˆæœ¬: $NODE_VERSION"

# æ£€æŸ¥ç¯å¢ƒå˜é‡
if [ ! -f .env ]; then
    echo "âŒ .envæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å¤åˆ¶.env.exampleå¹¶é…ç½®"
    exit 1
fi

# å®‰è£…ä¾èµ–
echo "ğŸ“¥ å®‰è£…ä¾èµ–åŒ…..."
npm install

# ç¼–è¯‘TypeScript
echo "ğŸ”§ ç¼–è¯‘TypeScript..."
npm run build

# åˆ›å»ºæ•°æ®åº“å’Œè¡¨
echo "ğŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“..."
npm run db:create
npm run db:migrate

# ç§å­æ•°æ®
echo "ğŸŒ± å¯¼å…¥ç§å­æ•°æ®..."
npm run db:seed

# å¯åŠ¨æœåŠ¡
echo "ğŸ‰ å¯åŠ¨æœåŠ¡..."
if [ "$NODE_ENV" = "production" ]; then
    npm start
else
    npm run dev
fi
```

```javascript
// scripts/createDatabase.js
const mysql = require('mysql2/promise');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

async function createDatabase() {
  const connection = await mysql.createConnection({
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD
  });

  try {
    await connection.execute(`CREATE DATABASE IF NOT EXISTS ${process.env.DB_NAME}`);
    console.log('âœ… æ•°æ®åº“åˆ›å»ºæˆåŠŸ');

    await connection.changeUser({ database: process.env.DB_NAME });

    const schemaSQL = fs.readFileSync(path.join(__dirname, 'schema.sql'), 'utf8');
    const statements = schemaSQL.split(';').filter(stmt => stmt.trim());

    for (const statement of statements) {
      if (statement.trim()) {
        await connection.execute(statement);
      }
    }

    console.log('âœ… æ•°æ®è¡¨åˆ›å»ºæˆåŠŸ');
  } catch (error) {
    console.error('âŒ æ•°æ®åº“åˆ›å»ºå¤±è´¥:', error);
  } finally {
    await connection.end();
  }
}

createDatabase();
```

## 5. æµ‹è¯•ä¸éªŒè¯

### 5.1 å¯åŠ¨æœåŠ¡
```bash
# å¼€å‘ç¯å¢ƒå¯åŠ¨
npm run dev

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
npm run build
npm start
```

### 5.2 APIæµ‹è¯•
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# ç”¨æˆ·æ³¨å†Œ
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456",
    "nickname": "æµ‹è¯•ç”¨æˆ·",
    "email": "test@example.com"
  }'

# ç”¨æˆ·ç™»å½•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456"
  }'
```

### 5.3 è®¿é—®Swaggeræ–‡æ¡£
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3000/api-docs`

## 6. éƒ¨ç½²è¯´æ˜

### 6.1 ç”Ÿäº§ç¯å¢ƒé…ç½®
```bash
# .env.production
NODE_ENV=production
PORT=3000

DB_HOST=your-db-host
DB_PORT=3306
DB_USER=your-db-user
DB_PASSWORD=your-db-password
DB_NAME=health_management

JWT_SECRET=your-production-jwt-secret
JWT_EXPIRES_IN=7d

CORS_ORIGIN=https://your-frontend-domain.com
```

### 6.2 PM2é…ç½®
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'health-backend',
    script: 'dist/app.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development'
    },
    env_production: {
      NODE_ENV: 'production'
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

è¿™ä»½æœåŠ¡ç«¯å®ç°æŒ‡å—æ¶µç›–äº†ä»é¡¹ç›®æ­å»ºåˆ°Swagger APIæ–‡æ¡£é¢„è§ˆçš„å®Œæ•´æµç¨‹ï¼ŒåŒ…å«äº†æ•°æ®åº“è®¾è®¡ã€è®¤è¯ç³»ç»Ÿã€APIæ¥å£å®ç°å’Œæ–‡æ¡£ç”Ÿæˆç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚