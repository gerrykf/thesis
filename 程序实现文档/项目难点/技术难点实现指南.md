# å¥åº·ç®¡ç†ç³»ç»ŸæŠ€æœ¯éš¾ç‚¹å®ç°æŒ‡å—

## 1. å›¾ç‰‡ä¸Šä¼ ä¸MinIOå­˜å‚¨å…¨é“¾è·¯å®ç°

### 1.1 MinIOç¯å¢ƒæ­å»º

#### 1.1.1 Dockeréƒ¨ç½²MinIO
```bash
# åˆ›å»ºMinIOæ•°æ®ç›®å½•
mkdir -p /data/minio/data
mkdir -p /data/minio/config

# ä½¿ç”¨Dockerè¿è¡ŒMinIO
docker run -d \
  --name minio \
  -p 9000:9000 \
  -p 9001:9001 \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin123" \
  -v /data/minio/data:/data \
  -v /data/minio/config:/root/.minio \
  quay.io/minio/minio server /data --console-address ":9001"

# éªŒè¯MinIOå¯åŠ¨
curl http://localhost:9000/minio/health/live
```

#### 1.1.2 MinIOå®¢æˆ·ç«¯é…ç½®
```bash
# å®‰è£…MinIOå®¢æˆ·ç«¯
wget https://dl.min.io/client/mc/release/linux-amd64/mc
chmod +x mc
sudo mv mc /usr/local/bin/

# é…ç½®MinIOå®¢æˆ·ç«¯
mc alias set local http://localhost:9000 minioadmin minioadmin123

# åˆ›å»ºå­˜å‚¨æ¡¶
mc mb local/health-images
mc mb local/user-avatars

# è®¾ç½®æ¡¶ç­–ç•¥ï¼ˆå…¬å…±è¯»å–ï¼‰
mc policy set public local/health-images
mc policy set public local/user-avatars
```

### 1.2 åç«¯MinIOé›†æˆå®ç°

#### 1.2.1 å®‰è£…ä¾èµ–åŒ…
```bash
# å®‰è£…MinIOå’Œæ–‡ä»¶å¤„ç†ç›¸å…³ä¾èµ–
npm install minio multer sharp uuid
npm install -D @types/multer @types/sharp
```

#### 1.2.2 MinIOé…ç½®æ–‡ä»¶
```typescript
// src/config/minio.ts
import { Client } from 'minio';
import dotenv from 'dotenv';

dotenv.config();

export const minioClient = new Client({
  endPoint: process.env.MINIO_ENDPOINT || 'localhost',
  port: parseInt(process.env.MINIO_PORT || '9000'),
  useSSL: process.env.MINIO_USE_SSL === 'true',
  accessKey: process.env.MINIO_ACCESS_KEY || 'minioadmin',
  secretKey: process.env.MINIO_SECRET_KEY || 'minioadmin123'
});

// å­˜å‚¨æ¡¶é…ç½®
export const BUCKETS = {
  USER_AVATARS: 'user-avatars',
  FOOD_IMAGES: 'food-images',
  HEALTH_IMAGES: 'health-images'
};

// åˆå§‹åŒ–å­˜å‚¨æ¡¶
export const initializeBuckets = async (): Promise<void> => {
  try {
    for (const bucketName of Object.values(BUCKETS)) {
      const exists = await minioClient.bucketExists(bucketName);
      if (!exists) {
        await minioClient.makeBucket(bucketName, 'us-east-1');
        console.log(`âœ… åˆ›å»ºå­˜å‚¨æ¡¶: ${bucketName}`);

        // è®¾ç½®å…¬å…±è¯»å–ç­–ç•¥
        const policy = {
          Version: '2012-10-17',
          Statement: [
            {
              Effect: 'Allow',
              Principal: { AWS: ['*'] },
              Action: ['s3:GetObject'],
              Resource: [`arn:aws:s3:::${bucketName}/*`]
            }
          ]
        };
        await minioClient.setBucketPolicy(bucketName, JSON.stringify(policy));
        console.log(`âœ… è®¾ç½®å­˜å‚¨æ¡¶ç­–ç•¥: ${bucketName}`);
      }
    }
  } catch (error) {
    console.error('âŒ MinIOåˆå§‹åŒ–å¤±è´¥:', error);
    throw error;
  }
};
```

#### 1.2.3 æ–‡ä»¶ä¸Šä¼ æœåŠ¡
```typescript
// src/services/uploadService.ts
import { Request } from 'express';
import multer from 'multer';
import sharp from 'sharp';
import { v4 as uuidv4 } from 'uuid';
import path from 'path';
import { minioClient, BUCKETS } from '../config/minio';

// æ–‡ä»¶ç±»å‹é…ç½®
const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

// Multeré…ç½®ï¼ˆå†…å­˜å­˜å‚¨ï¼‰
const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: MAX_FILE_SIZE
  },
  fileFilter: (req: Request, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
    if (!ALLOWED_IMAGE_TYPES.includes(file.mimetype)) {
      return cb(new Error('åªæ”¯æŒ JPEG, PNG, WebP æ ¼å¼çš„å›¾ç‰‡'));
    }
    cb(null, true);
  }
});

// å›¾ç‰‡å¤„ç†å’Œä¸Šä¼ æœåŠ¡ç±»
export class UploadService {
  // ä¸Šä¼ å¤´åƒ
  static async uploadAvatar(
    file: Express.Multer.File,
    userId: number
  ): Promise<string> {
    try {
      // å›¾ç‰‡å¤„ç†ï¼šå‹ç¼©å’Œè°ƒæ•´å°ºå¯¸
      const processedImage = await sharp(file.buffer)
        .resize(200, 200, {
          fit: 'cover',
          position: 'center'
        })
        .jpeg({ quality: 80 })
        .toBuffer();

      // ç”Ÿæˆæ–‡ä»¶å
      const fileName = `avatar-${userId}-${uuidv4()}.jpg`;

      // ä¸Šä¼ åˆ°MinIO
      await minioClient.putObject(
        BUCKETS.USER_AVATARS,
        fileName,
        processedImage,
        processedImage.length,
        {
          'Content-Type': 'image/jpeg',
          'Cache-Control': 'max-age=31536000' // 1å¹´ç¼“å­˜
        }
      );

      // è¿”å›è®¿é—®URL
      const imageUrl = await this.getImageUrl(BUCKETS.USER_AVATARS, fileName);
      return imageUrl;
    } catch (error) {
      console.error('å¤´åƒä¸Šä¼ å¤±è´¥:', error);
      throw new Error('å¤´åƒä¸Šä¼ å¤±è´¥');
    }
  }

  // ä¸Šä¼ é£Ÿç‰©å›¾ç‰‡
  static async uploadFoodImage(
    file: Express.Multer.File,
    foodId: number
  ): Promise<string> {
    try {
      // å›¾ç‰‡å¤„ç†ï¼šå¤šå°ºå¯¸ç”Ÿæˆ
      const originalImage = await sharp(file.buffer)
        .resize(800, 600, {
          fit: 'inside',
          withoutEnlargement: true
        })
        .jpeg({ quality: 85 })
        .toBuffer();

      const thumbnailImage = await sharp(file.buffer)
        .resize(300, 225, {
          fit: 'cover',
          position: 'center'
        })
        .jpeg({ quality: 75 })
        .toBuffer();

      const fileName = `food-${foodId}-${uuidv4()}`;
      const originalFileName = `${fileName}-original.jpg`;
      const thumbnailFileName = `${fileName}-thumb.jpg`;

      // ä¸Šä¼ åŸå›¾
      await minioClient.putObject(
        BUCKETS.FOOD_IMAGES,
        originalFileName,
        originalImage,
        originalImage.length,
        {
          'Content-Type': 'image/jpeg',
          'Cache-Control': 'max-age=31536000'
        }
      );

      // ä¸Šä¼ ç¼©ç•¥å›¾
      await minioClient.putObject(
        BUCKETS.FOOD_IMAGES,
        thumbnailFileName,
        thumbnailImage,
        thumbnailImage.length,
        {
          'Content-Type': 'image/jpeg',
          'Cache-Control': 'max-age=31536000'
        }
      );

      // è¿”å›åŸå›¾URL
      const imageUrl = await this.getImageUrl(BUCKETS.FOOD_IMAGES, originalFileName);
      return imageUrl;
    } catch (error) {
      console.error('é£Ÿç‰©å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
      throw new Error('é£Ÿç‰©å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
    }
  }

  // è·å–å›¾ç‰‡è®¿é—®URL
  static async getImageUrl(bucketName: string, fileName: string): Promise<string> {
    try {
      // ç”Ÿæˆé¢„ç­¾åURLï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰
      const url = await minioClient.presignedUrl('GET', bucketName, fileName, 24 * 60 * 60);
      return url;
    } catch (error) {
      console.error('è·å–å›¾ç‰‡URLå¤±è´¥:', error);
      throw new Error('è·å–å›¾ç‰‡URLå¤±è´¥');
    }
  }

  // åˆ é™¤å›¾ç‰‡
  static async deleteImage(bucketName: string, fileName: string): Promise<void> {
    try {
      await minioClient.removeObject(bucketName, fileName);
      console.log(`âœ… åˆ é™¤å›¾ç‰‡: ${bucketName}/${fileName}`);
    } catch (error) {
      console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
      throw new Error('åˆ é™¤å›¾ç‰‡å¤±è´¥');
    }
  }

  // æ‰¹é‡åˆ é™¤å›¾ç‰‡
  static async deleteImages(bucketName: string, fileNames: string[]): Promise<void> {
    try {
      await minioClient.removeObjects(bucketName, fileNames);
      console.log(`âœ… æ‰¹é‡åˆ é™¤å›¾ç‰‡: ${fileNames.length}å¼ `);
    } catch (error) {
      console.error('æ‰¹é‡åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
      throw new Error('æ‰¹é‡åˆ é™¤å›¾ç‰‡å¤±è´¥');
    }
  }
}

// å¯¼å‡ºmulterä¸­é—´ä»¶
export const uploadSingle = upload.single('image');
export const uploadMultiple = upload.array('images', 5);
```

#### 1.2.4 å›¾ç‰‡ä¸Šä¼ æ§åˆ¶å™¨
```typescript
// src/controllers/uploadController.ts
import { Response } from 'express';
import { AuthRequest } from '../middleware/auth';
import { UploadService } from '../services/uploadService';
import { db } from '../config/database';

/**
 * @swagger
 * /api/upload/avatar:
 *   post:
 *     summary: ä¸Šä¼ ç”¨æˆ·å¤´åƒ
 *     tags: [æ–‡ä»¶ä¸Šä¼ ]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         multipart/form-data:
 *           schema:
 *             type: object
 *             properties:
 *               image:
 *                 type: string
 *                 format: binary
 *                 description: å¤´åƒå›¾ç‰‡æ–‡ä»¶
 *     responses:
 *       200:
 *         description: ä¸Šä¼ æˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 message:
 *                   type: string
 *                 data:
 *                   type: object
 *                   properties:
 *                     imageUrl:
 *                       type: string
 */
export const uploadAvatar = async (req: AuthRequest, res: Response): Promise<void> => {
  try {
    if (!req.file) {
      res.status(400).json({
        success: false,
        message: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶'
      });
      return;
    }

    const userId = req.user!.userId;

    // è·å–ç”¨æˆ·å½“å‰å¤´åƒURLï¼ˆç”¨äºåˆ é™¤æ—§å¤´åƒï¼‰
    const [rows] = await db.execute(
      'SELECT avatar FROM users WHERE id = ?',
      [userId]
    );
    const user = (rows as any[])[0];
    const oldAvatarUrl = user?.avatar;

    // ä¸Šä¼ æ–°å¤´åƒ
    const imageUrl = await UploadService.uploadAvatar(req.file, userId);

    // æ›´æ–°æ•°æ®åº“ä¸­çš„å¤´åƒURL
    await db.execute(
      'UPDATE users SET avatar = ? WHERE id = ?',
      [imageUrl, userId]
    );

    // åˆ é™¤æ—§å¤´åƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (oldAvatarUrl && oldAvatarUrl.includes('minio')) {
      try {
        const oldFileName = oldAvatarUrl.split('/').pop();
        if (oldFileName) {
          await UploadService.deleteImage('user-avatars', oldFileName);
        }
      } catch (error) {
        console.warn('åˆ é™¤æ—§å¤´åƒå¤±è´¥:', error);
      }
    }

    res.json({
      success: true,
      message: 'å¤´åƒä¸Šä¼ æˆåŠŸ',
      data: {
        imageUrl
      }
    });
  } catch (error) {
    console.error('å¤´åƒä¸Šä¼ é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: error instanceof Error ? error.message : 'ä¸Šä¼ å¤±è´¥'
    });
  }
};

/**
 * @swagger
 * /api/upload/food-image:
 *   post:
 *     summary: ä¸Šä¼ é£Ÿç‰©å›¾ç‰‡
 *     tags: [æ–‡ä»¶ä¸Šä¼ ]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         multipart/form-data:
 *           schema:
 *             type: object
 *             properties:
 *               image:
 *                 type: string
 *                 format: binary
 *               foodId:
 *                 type: integer
 *                 description: é£Ÿç‰©ID
 *     responses:
 *       200:
 *         description: ä¸Šä¼ æˆåŠŸ
 */
export const uploadFoodImage = async (req: AuthRequest, res: Response): Promise<void> => {
  try {
    if (!req.file) {
      res.status(400).json({
        success: false,
        message: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶'
      });
      return;
    }

    const { foodId } = req.body;
    if (!foodId) {
      res.status(400).json({
        success: false,
        message: 'é£Ÿç‰©IDä¸èƒ½ä¸ºç©º'
      });
      return;
    }

    // éªŒè¯é£Ÿç‰©æ˜¯å¦å­˜åœ¨
    const [rows] = await db.execute(
      'SELECT id, image_url FROM foods WHERE id = ?',
      [foodId]
    );
    if ((rows as any[]).length === 0) {
      res.status(404).json({
        success: false,
        message: 'é£Ÿç‰©ä¸å­˜åœ¨'
      });
      return;
    }

    const food = (rows as any[])[0];
    const oldImageUrl = food.image_url;

    // ä¸Šä¼ æ–°å›¾ç‰‡
    const imageUrl = await UploadService.uploadFoodImage(req.file, foodId);

    // æ›´æ–°æ•°æ®åº“ä¸­çš„å›¾ç‰‡URL
    await db.execute(
      'UPDATE foods SET image_url = ? WHERE id = ?',
      [imageUrl, foodId]
    );

    // åˆ é™¤æ—§å›¾ç‰‡
    if (oldImageUrl && oldImageUrl.includes('minio')) {
      try {
        const oldFileName = oldImageUrl.split('/').pop();
        if (oldFileName) {
          await UploadService.deleteImage('food-images', oldFileName);
        }
      } catch (error) {
        console.warn('åˆ é™¤æ—§é£Ÿç‰©å›¾ç‰‡å¤±è´¥:', error);
      }
    }

    res.json({
      success: true,
      message: 'é£Ÿç‰©å›¾ç‰‡ä¸Šä¼ æˆåŠŸ',
      data: {
        imageUrl
      }
    });
  } catch (error) {
    console.error('é£Ÿç‰©å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: error instanceof Error ? error.message : 'ä¸Šä¼ å¤±è´¥'
    });
  }
};
```

#### 1.2.5 å›¾ç‰‡ä¸Šä¼ è·¯ç”±
```typescript
// src/routes/uploadRoutes.ts
import { Router } from 'express';
import { uploadAvatar, uploadFoodImage } from '../controllers/uploadController';
import { authenticateToken } from '../middleware/auth';
import { uploadSingle } from '../services/uploadService';

const router = Router();

// ä¸Šä¼ å¤´åƒ
router.post('/avatar', authenticateToken, uploadSingle, uploadAvatar);

// ä¸Šä¼ é£Ÿç‰©å›¾ç‰‡
router.post('/food-image', authenticateToken, uploadSingle, uploadFoodImage);

export default router;
```

### 1.3 å‰ç«¯å›¾ç‰‡ä¸Šä¼ å®ç°

#### 1.3.1 Vue3 + Vantå›¾ç‰‡ä¸Šä¼ ç»„ä»¶
```vue
<!-- src/components/ImageUploader.vue -->
<template>
  <div class="image-uploader">
    <van-uploader
      v-model="fileList"
      :max-count="maxCount"
      :max-size="maxSize"
      :upload="uploadFile"
      :before-upload="beforeUpload"
      :accept="accept"
      :preview-size="previewSize"
      @oversize="onOversize"
      @delete="onDelete"
    >
      <template #default>
        <div class="upload-area">
          <van-icon name="plus" size="24" />
          <div class="upload-text">{{ placeholder }}</div>
        </div>
      </template>
    </van-uploader>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, defineProps, defineEmits } from 'vue';
import { showToast } from 'vant';
import { uploadAPI } from '@/api/upload';

interface Props {
  modelValue?: string[];
  maxCount?: number;
  maxSize?: number;
  accept?: string;
  uploadType?: 'avatar' | 'food';
  placeholder?: string;
  previewSize?: number | string;
  foodId?: number;
}

interface Emits {
  (e: 'update:modelValue', value: string[]): void;
  (e: 'upload-success', url: string): void;
  (e: 'upload-error', error: string): void;
}

const props = withDefaults(defineProps<Props>(), {
  maxCount: 1,
  maxSize: 5 * 1024 * 1024, // 5MB
  accept: 'image/*',
  uploadType: 'avatar',
  placeholder: 'ä¸Šä¼ å›¾ç‰‡',
  previewSize: 80
});

const emit = defineEmits<Emits>();

const fileList = ref<any[]>([]);

// ç›‘å¬å¤–éƒ¨å€¼å˜åŒ–
watch(() => props.modelValue, (newValue) => {
  if (newValue && newValue.length > 0) {
    fileList.value = newValue.map((url, index) => ({
      url,
      isImage: true,
      file: null,
      status: 'done',
      uid: `${index}`
    }));
  } else {
    fileList.value = [];
  }
}, { immediate: true });

// ä¸Šä¼ å‰éªŒè¯
const beforeUpload = (file: File) => {
  const isImage = file.type.startsWith('image/');
  if (!isImage) {
    showToast('è¯·ä¸Šä¼ å›¾ç‰‡æ ¼å¼çš„æ–‡ä»¶');
    return false;
  }

  const isLt5M = file.size < props.maxSize;
  if (!isLt5M) {
    showToast(`å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ ${props.maxSize / 1024 / 1024}MB`);
    return false;
  }

  return true;
};

// æ–‡ä»¶ä¸Šä¼ 
const uploadFile = async (file: File) => {
  try {
    const formData = new FormData();
    formData.append('image', file);

    if (props.uploadType === 'food' && props.foodId) {
      formData.append('foodId', props.foodId.toString());
    }

    let response;
    if (props.uploadType === 'avatar') {
      response = await uploadAPI.uploadAvatar(formData);
    } else {
      response = await uploadAPI.uploadFoodImage(formData);
    }

    const imageUrl = response.data.imageUrl;

    // æ›´æ–°å¤–éƒ¨å€¼
    const newUrls = [...(props.modelValue || []), imageUrl];
    emit('update:modelValue', newUrls);
    emit('upload-success', imageUrl);

    showToast('ä¸Šä¼ æˆåŠŸ');

    return {
      url: imageUrl,
      isImage: true
    };
  } catch (error: any) {
    const errorMessage = error.response?.data?.message || 'ä¸Šä¼ å¤±è´¥';
    showToast(errorMessage);
    emit('upload-error', errorMessage);
    throw error;
  }
};

// æ–‡ä»¶è¶…å‡ºå¤§å°é™åˆ¶
const onOversize = () => {
  showToast(`æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ ${props.maxSize / 1024 / 1024}MB`);
};

// åˆ é™¤æ–‡ä»¶
const onDelete = (file: any, detail: any) => {
  const urls = props.modelValue || [];
  const newUrls = urls.filter((_, index) => index !== detail.index);
  emit('update:modelValue', newUrls);
};
</script>

<style scoped>
.image-uploader {
  width: 100%;
}

.upload-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 80px;
  height: 80px;
  background-color: #fafafa;
  border: 1px dashed #c8c9cc;
  border-radius: 6px;
  color: #c8c9cc;
}

.upload-text {
  margin-top: 4px;
  font-size: 12px;
}
</style>
```

#### 1.3.2 å¤´åƒä¸Šä¼ ä½¿ç”¨ç¤ºä¾‹
```vue
<!-- src/views/Profile.vue -->
<template>
  <div class="profile-page">
    <van-nav-bar title="ä¸ªäººä¿¡æ¯" left-arrow @click-left="$router.go(-1)" />

    <div class="avatar-section">
      <h3>å¤´åƒè®¾ç½®</h3>
      <ImageUploader
        v-model="avatarUrls"
        upload-type="avatar"
        placeholder="ä¸Šä¼ å¤´åƒ"
        :max-count="1"
        @upload-success="onAvatarUploadSuccess"
      />
    </div>

    <van-form @submit="onSubmit">
      <van-cell-group>
        <van-field
          v-model="form.nickname"
          name="nickname"
          label="æ˜µç§°"
          placeholder="è¯·è¾“å…¥æ˜µç§°"
        />
        <van-field
          v-model="form.email"
          name="email"
          label="é‚®ç®±"
          placeholder="è¯·è¾“å…¥é‚®ç®±"
        />
      </van-cell-group>

      <div style="margin: 16px;">
        <van-button
          round
          block
          type="primary"
          native-type="submit"
          :loading="loading"
        >
          ä¿å­˜
        </van-button>
      </div>
    </van-form>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { showToast } from 'vant';
import ImageUploader from '@/components/ImageUploader.vue';
import { useAuthStore } from '@/stores/auth';

const authStore = useAuthStore();
const loading = ref(false);
const avatarUrls = ref<string[]>([]);
const form = ref({
  nickname: '',
  email: ''
});

onMounted(async () => {
  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  const userInfo = await authStore.fetchUser();
  form.value = {
    nickname: userInfo.nickname || '',
    email: userInfo.email || ''
  };

  if (userInfo.avatar) {
    avatarUrls.value = [userInfo.avatar];
  }
});

const onAvatarUploadSuccess = (url: string) => {
  console.log('å¤´åƒä¸Šä¼ æˆåŠŸ:', url);
  // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°ç”¨æˆ·storeä¸­çš„å¤´åƒä¿¡æ¯
  authStore.updateAvatar(url);
};

const onSubmit = async () => {
  loading.value = true;
  try {
    await authStore.updateProfile(form.value);
    showToast('ä¿å­˜æˆåŠŸ');
  } catch (error) {
    showToast('ä¿å­˜å¤±è´¥');
  } finally {
    loading.value = false;
  }
};
</script>
```

### 1.4 å›¾ç‰‡è¯»å–å’Œè®¿é—®ä¼˜åŒ–

#### 1.4.1 CDNé›†æˆ
```typescript
// src/utils/imageUtils.ts
const CDN_BASE_URL = process.env.VUE_APP_CDN_BASE_URL || '';
const MINIO_BASE_URL = process.env.VUE_APP_MINIO_BASE_URL || 'http://localhost:9000';

export class ImageUtils {
  // è·å–ä¼˜åŒ–åçš„å›¾ç‰‡URL
  static getOptimizedImageUrl(
    originalUrl: string,
    options: {
      width?: number;
      height?: number;
      quality?: number;
      format?: 'webp' | 'jpeg' | 'png';
    } = {}
  ): string {
    if (!originalUrl) return '';

    // å¦‚æœæ˜¯MinIO URLä¸”æœ‰CDNé…ç½®ï¼Œä½¿ç”¨CDN
    if (originalUrl.includes('minio') && CDN_BASE_URL) {
      const path = originalUrl.replace(MINIO_BASE_URL, '');
      return `${CDN_BASE_URL}${path}`;
    }

    // å¦‚æœæ”¯æŒå›¾ç‰‡å¤„ç†å‚æ•°
    if (options.width || options.height || options.quality || options.format) {
      const params = new URLSearchParams();
      if (options.width) params.set('w', options.width.toString());
      if (options.height) params.set('h', options.height.toString());
      if (options.quality) params.set('q', options.quality.toString());
      if (options.format) params.set('f', options.format);

      const separator = originalUrl.includes('?') ? '&' : '?';
      return `${originalUrl}${separator}${params.toString()}`;
    }

    return originalUrl;
  }

  // è·å–ç¼©ç•¥å›¾URL
  static getThumbnailUrl(originalUrl: string): string {
    return this.getOptimizedImageUrl(originalUrl, {
      width: 300,
      height: 300,
      quality: 75,
      format: 'webp'
    });
  }

  // é¢„åŠ è½½å›¾ç‰‡
  static preloadImage(url: string): Promise<void> {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve();
      img.onerror = reject;
      img.src = url;
    });
  }
}
```

## 2. é˜¿é‡Œäº‘åŸŸåè´­ä¹°ä¸1Paneléƒ¨ç½²å…¨æµç¨‹

### 2.1 é˜¿é‡Œäº‘åŸŸåè´­ä¹°æµç¨‹

#### 2.1.1 åŸŸåæ³¨å†Œæ­¥éª¤
```bash
# 1. ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
https://ecs.console.aliyun.com/

# 2. è¿›å…¥åŸŸåæœåŠ¡
äº§å“ä¸æœåŠ¡ â†’ åŸŸåä¸ç½‘ç«™ â†’ åŸŸå

# 3. åŸŸåæŸ¥è¯¢ä¸æ³¨å†Œ
- è¾“å…¥æƒ³è¦æ³¨å†Œçš„åŸŸå
- é€‰æ‹©åˆé€‚çš„åç¼€ï¼ˆ.com, .cn, .netç­‰ï¼‰
- æ£€æŸ¥åŸŸåå¯ç”¨æ€§
- é€‰æ‹©æ³¨å†Œå¹´é™ï¼ˆå»ºè®®3-5å¹´ï¼‰
- æ·»åŠ åˆ°è´­ç‰©è½¦å¹¶æ”¯ä»˜

# 4. åŸŸåä¿¡æ¯å®Œå–„
- å¡«å†™åŸŸåæ‰€æœ‰è€…ä¿¡æ¯
- ä¸Šä¼ èº«ä»½è¯æ˜æ–‡ä»¶
- ç­‰å¾…å®¡æ ¸é€šè¿‡ï¼ˆé€šå¸¸1-3ä¸ªå·¥ä½œæ—¥ï¼‰
```

#### 2.1.2 åŸŸåè§£æé…ç½®
```bash
# åŸŸåè§£æè®¾ç½®æ­¥éª¤ï¼š

# 1. è¿›å…¥äº‘è§£æDNS
æ§åˆ¶å° â†’ äº§å“ä¸æœåŠ¡ â†’ åŸŸåä¸ç½‘ç«™ â†’ äº‘è§£æDNS

# 2. æ·»åŠ è§£æè®°å½•
è®°å½•ç±»å‹: A
ä¸»æœºè®°å½•: @ï¼ˆæ ¹åŸŸåï¼‰æˆ– wwwï¼ˆå­åŸŸåï¼‰
è§£æçº¿è·¯: é»˜è®¤
è®°å½•å€¼: æœåŠ¡å™¨å…¬ç½‘IPåœ°å€
TTL: 600ç§’

# 3. å¸¸ç”¨è§£æè®°å½•é…ç½®
@       A    your_server_ip     # æ ¹åŸŸåæŒ‡å‘
www     A    your_server_ip     # wwwå­åŸŸåæŒ‡å‘
api     A    your_server_ip     # APIå­åŸŸåæŒ‡å‘
admin   A    your_server_ip     # ç®¡ç†åå°å­åŸŸåæŒ‡å‘

# 4. éªŒè¯è§£æç”Ÿæ•ˆ
nslookup your-domain.com
ping your-domain.com
```

### 2.2 æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

#### 2.2.1 é˜¿é‡Œäº‘ECSå®ä¾‹é…ç½®
```bash
# æ¨èé…ç½®ï¼š
CPU: 2æ ¸å¿ƒ
å†…å­˜: 4GB
å­˜å‚¨: 40GB SSDäº‘ç›˜
å¸¦å®½: 5Mbps
æ“ä½œç³»ç»Ÿ: CentOS 7.9 æˆ– Ubuntu 20.04 LTS

# å®‰å…¨ç»„é…ç½®
å…¥æ–¹å‘è§„åˆ™:
- HTTP: 80/80, 0.0.0.0/0
- HTTPS: 443/443, 0.0.0.0/0
- SSH: 22/22, 0.0.0.0/0
- 1Panel: 8888/8888, your_ip/32
- è‡ªå®šä¹‰: 3000/3000, 0.0.0.0/0 (åç«¯API)
- è‡ªå®šä¹‰: 9000-9001/9000-9001, 0.0.0.0/0 (MinIO)
```

#### 2.2.2 åŸºç¡€ç¯å¢ƒå®‰è£…
```bash
# è¿æ¥æœåŠ¡å™¨
ssh root@your_server_ip

# æ›´æ–°ç³»ç»Ÿ
yum update -y  # CentOS
# apt update && apt upgrade -y  # Ubuntu

# å®‰è£…åŸºç¡€å·¥å…·
yum install -y wget curl vim git unzip  # CentOS
# apt install -y wget curl vim git unzip  # Ubuntu

# å®‰è£…Docker
curl -fsSL https://get.docker.com | bash
systemctl start docker
systemctl enable docker

# å®‰è£…Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### 2.3 1Panelå®‰è£…ä¸é…ç½®

#### 2.3.1 1Panelå®‰è£…
```bash
# ä¸‹è½½1Panelå®‰è£…è„šæœ¬
curl -sSL https://resource.fit2cloud.com/1panel/package/quick_start.sh -o quick_start.sh

# æ‰§è¡Œå®‰è£…
sudo bash quick_start.sh

# æŸ¥çœ‹é¢æ¿ä¿¡æ¯
1pctl user-info

# 1Panelå®‰è£…å®Œæˆåæ˜¾ç¤ºä¿¡æ¯:
# ==========================================
# 1Panel å®‰è£…å®Œæˆ
# ==========================================
# é¢æ¿åœ°å€: http://your_ip:8888/security_entrance
# ç”¨æˆ·å: admin_username
# å¯†ç : admin_password
# å…¥å£: security_entrance_path
# ==========================================
```

#### 2.3.2 1PanelåŸºç¡€é…ç½®
```bash
# 1. ç™»å½•1Panelç®¡ç†é¢æ¿
æµè§ˆå™¨è®¿é—®: http://your_server_ip:8888/security_entrance

# 2. åˆå§‹åŒ–è®¾ç½®
- ä¿®æ”¹é»˜è®¤å¯†ç 
- è®¾ç½®å®‰å…¨å…¥å£
- é…ç½®SSLè¯ä¹¦
- å¼€å¯é˜²ç«å¢™

# 3. å®‰è£…å¿…è¦åº”ç”¨
åº”ç”¨å•†åº— â†’ æœç´¢å¹¶å®‰è£…:
- OpenResty (WebæœåŠ¡å™¨)
- MySQL (æ•°æ®åº“)
- Redis (ç¼“å­˜)
- MinIO (å¯¹è±¡å­˜å‚¨)
- phpMyAdmin (æ•°æ®åº“ç®¡ç†ï¼Œå¯é€‰)
```

### 2.4 é¡¹ç›®éƒ¨ç½²é…ç½®

#### 2.4.1 åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
```bash
# åœ¨1Panelä¸­åˆ›å»ºç½‘ç«™
ç½‘ç«™ â†’ åˆ›å»ºç½‘ç«™ â†’ é™æ€ç½‘ç«™
åŸŸå: your-domain.com
é¡¹ç›®ç›®å½•: /opt/1panel/apps/openresty/openresty/www/sites/your-domain

# åˆ›å»ºå®Œæ•´ç›®å½•ç»“æ„
mkdir -p /opt/health-system/{frontend,backend,database,storage}
cd /opt/health-system

# ç›®å½•ç»“æ„ï¼š
health-system/
â”œâ”€â”€ frontend/          # å‰ç«¯é™æ€æ–‡ä»¶
â”œâ”€â”€ backend/           # åç«¯APIä»£ç 
â”œâ”€â”€ database/          # æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ storage/           # æ–‡ä»¶å­˜å‚¨
â””â”€â”€ docker-compose.yml # Dockerç¼–æ’æ–‡ä»¶
```

#### 2.4.2 Docker Composeé…ç½®
```yaml
# docker-compose.yml
version: '3.8'

services:
  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    container_name: health-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: your_mysql_root_password
      MYSQL_DATABASE: health_management
      MYSQL_USER: health_app
      MYSQL_PASSWORD: your_mysql_password
    volumes:
      - ./database/data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    networks:
      - health-network

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: health-redis
    restart: unless-stopped
    command: redis-server --requirepass your_redis_password
    volumes:
      - ./database/redis:/data
    ports:
      - "6379:6379"
    networks:
      - health-network

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    image: quay.io/minio/minio:latest
    container_name: health-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: your_minio_password
    volumes:
      - ./storage/minio/data:/data
      - ./storage/minio/config:/root/.minio
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    networks:
      - health-network

  # åç«¯APIæœåŠ¡
  backend:
    build: ./backend
    container_name: health-backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_USER: health_app
      DB_PASSWORD: your_mysql_password
      DB_NAME: health_management
      REDIS_HOST: redis
      REDIS_PASSWORD: your_redis_password
      MINIO_ENDPOINT: minio
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: your_minio_password
      JWT_SECRET: your_jwt_secret
    volumes:
      - ./backend/logs:/app/logs
    ports:
      - "3000:3000"
    depends_on:
      - mysql
      - redis
      - minio
    networks:
      - health-network

networks:
  health-network:
    driver: bridge
```

#### 2.4.3 Nginxåå‘ä»£ç†é…ç½®
```nginx
# /opt/1panel/apps/openresty/openresty/conf/conf.d/your-domain.conf

# å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /opt/1panel/apps/openresty/openresty/ssl/your-domain.com/fullchain.pem;
    ssl_certificate_key /opt/1panel/apps/openresty/openresty/ssl/your-domain.com/privkey.pem;

    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /opt/health-system/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;

        # ç¼“å­˜é™æ€èµ„æº
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # APIä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
        client_max_body_size 10M;
    }

    # MinIOå¯¹è±¡å­˜å‚¨ä»£ç†
    location /storage/ {
        proxy_pass http://127.0.0.1:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORSé…ç½®
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }
}

# ç®¡ç†åå°
server {
    listen 443 ssl http2;
    server_name admin.your-domain.com;

    # SSLè¯ä¹¦é…ç½®ï¼ˆå¯ä»¥ä½¿ç”¨é€šé…ç¬¦è¯ä¹¦ï¼‰
    ssl_certificate /opt/1panel/apps/openresty/openresty/ssl/your-domain.com/fullchain.pem;
    ssl_certificate_key /opt/1panel/apps/openresty/openresty/ssl/your-domain.com/privkey.pem;

    # ç®¡ç†åå°é™æ€æ–‡ä»¶
    location / {
        root /opt/health-system/frontend-admin/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # APIä»£ç†ï¼ˆä¸ä¸»ç«™å…±ç”¨ï¼‰
    location /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 2.5 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

#### 2.5.1 éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# deploy.sh - å¥åº·ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

set -e

PROJECT_DIR="/opt/health-system"
DOMAIN="your-domain.com"
GIT_REPO="https://github.com/your-username/health-system.git"

echo "ğŸš€ å¼€å§‹éƒ¨ç½²å¥åº·ç®¡ç†ç³»ç»Ÿ..."

# 1. æ£€æŸ¥ç¯å¢ƒ
echo "ğŸ“‹ æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ..."
command -v docker >/dev/null 2>&1 || { echo "âŒ Dockeræœªå®‰è£…"; exit 1; }
command -v docker-compose >/dev/null 2>&1 || { echo "âŒ Docker Composeæœªå®‰è£…"; exit 1; }

# 2. åˆ›å»ºé¡¹ç›®ç›®å½•
echo "ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•..."
mkdir -p $PROJECT_DIR
cd $PROJECT_DIR

# 3. å…‹éš†ä»£ç 
echo "ğŸ“¥ å…‹éš†é¡¹ç›®ä»£ç ..."
if [ -d ".git" ]; then
    git pull origin main
else
    git clone $GIT_REPO .
fi

# 4. æ„å»ºå‰ç«¯
echo "ğŸ”¨ æ„å»ºå‰ç«¯é¡¹ç›®..."
cd frontend
npm install
npm run build
cd ..

cd frontend-admin
npm install
npm run build
cd ..

# 5. æ„å»ºåç«¯
echo "ğŸ”¨ æ„å»ºåç«¯é¡¹ç›®..."
cd backend
npm install
npm run build
cd ..

# 6. é…ç½®ç¯å¢ƒå˜é‡
echo "âš™ï¸  é…ç½®ç¯å¢ƒå˜é‡..."
cat > .env << EOF
# æ•°æ®åº“é…ç½®
MYSQL_ROOT_PASSWORD=$(openssl rand -base64 32)
MYSQL_PASSWORD=$(openssl rand -base64 32)

# Redisé…ç½®
REDIS_PASSWORD=$(openssl rand -base64 32)

# MinIOé…ç½®
MINIO_PASSWORD=$(openssl rand -base64 32)

# JWTå¯†é’¥
JWT_SECRET=$(openssl rand -base64 64)

# åŸŸåé…ç½®
DOMAIN=$DOMAIN
EOF

# 7. å¯åŠ¨æœåŠ¡
echo "ğŸ³ å¯åŠ¨DockeræœåŠ¡..."
docker-compose up -d

# 8. ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# 9. åˆå§‹åŒ–æ•°æ®åº“
echo "ğŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“..."
docker-compose exec backend npm run db:migrate
docker-compose exec backend npm run db:seed

# 10. é…ç½®SSLè¯ä¹¦
echo "ğŸ”’ é…ç½®SSLè¯ä¹¦..."
docker run --rm -it \
  -v /opt/1panel/apps/openresty/openresty/ssl:/etc/letsencrypt \
  certbot/certbot certonly \
  --standalone \
  --email your-email@example.com \
  --agree-tos \
  --no-eff-email \
  -d $DOMAIN \
  -d www.$DOMAIN \
  -d admin.$DOMAIN

# 11. é‡è½½Nginxé…ç½®
echo "ğŸ”„ é‡è½½Nginxé…ç½®..."
docker exec openresty nginx -s reload

# 12. æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "===================="
echo "å‰ç«¯åœ°å€: https://$DOMAIN"
echo "ç®¡ç†åå°: https://admin.$DOMAIN"
echo "APIæ–‡æ¡£: https://$DOMAIN/api-docs"
echo "MinIOæ§åˆ¶å°: https://$DOMAIN:9001"
echo "===================="

# 13. æ˜¾ç¤ºé‡è¦ä¿¡æ¯
echo "ğŸ”‘ é‡è¦ä¿¡æ¯ï¼ˆè¯·å¦¥å–„ä¿å­˜ï¼‰ï¼š"
echo "MySQL rootå¯†ç : $(grep MYSQL_ROOT_PASSWORD .env | cut -d'=' -f2)"
echo "MinIOå¯†ç : $(grep MINIO_PASSWORD .env | cut -d'=' -f2)"
echo "Rediså¯†ç : $(grep REDIS_PASSWORD .env | cut -d'=' -f2)"
```

#### 2.5.2 æ›´æ–°éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# update.sh - ç³»ç»Ÿæ›´æ–°è„šæœ¬

PROJECT_DIR="/opt/health-system"
cd $PROJECT_DIR

echo "ğŸ”„ å¼€å§‹æ›´æ–°ç³»ç»Ÿ..."

# 1. å¤‡ä»½æ•°æ®åº“
echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
docker-compose exec mysql mysqldump -u root -p$MYSQL_ROOT_PASSWORD health_management > backup/db_$(date +%Y%m%d_%H%M%S).sql

# 2. æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin main

# 3. é‡æ–°æ„å»ºå‰ç«¯
echo "ğŸ”¨ é‡æ–°æ„å»ºå‰ç«¯..."
cd frontend && npm install && npm run build && cd ..
cd frontend-admin && npm install && npm run build && cd ..

# 4. é‡æ–°æ„å»ºåç«¯
echo "ğŸ”¨ é‡æ–°æ„å»ºåç«¯..."
cd backend && npm install && npm run build && cd ..

# 5. é‡å¯æœåŠ¡
echo "ğŸ”„ é‡å¯æœåŠ¡..."
docker-compose down
docker-compose up -d

echo "âœ… æ›´æ–°å®Œæˆï¼"
```

è¿™ä»½æŠ€æœ¯éš¾ç‚¹å®ç°æŒ‡å—è¯¦ç»†ä»‹ç»äº†å›¾ç‰‡ä¸Šä¼ åˆ°MinIOçš„å®Œæ•´æŠ€æœ¯é“¾è·¯ä»¥åŠé€šè¿‡1Paneléƒ¨ç½²é¡¹ç›®çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…å«äº†æ‰€æœ‰å¿…è¦çš„é…ç½®æ–‡ä»¶å’Œè„šæœ¬ï¼Œå¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€‚