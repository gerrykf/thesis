# 🎯 多语言方案优化说明

## 📋 优化内容

### ✅ 采用标准的 HTTP Header 方式传递语言

**优化前**:
```typescript
// ❌ 同时使用两种方式(冗余)
config.headers["Accept-Language"] = locale;  // Header
config.params.lang = locale;                   // Query String
```

**优化后**:
```typescript
// ✅ 只使用标准的 Accept-Language Header
config.headers["Accept-Language"] = locale;
```

---

## 🎯 为什么这样优化?

### 1. **符合 HTTP 标准** ✅
- `Accept-Language` 是 HTTP 标准请求头
- 用于告知服务器客户端期望的语言
- 所有主流框架和库都支持

### 2. **URL 更简洁** ✅
```bash
# 优化前
GET /api/foods?page=1&limit=20&search=&lang=en-US

# 优化后
GET /api/foods?page=1&limit=20&search=
Headers: Accept-Language: en-US
```

### 3. **减少参数污染** ✅
- Query 参数保留给业务逻辑(page, limit, search)
- 语言这种全局配置用 Header 更合适
- 避免业务代码关心语言参数

### 4. **便于缓存和日志** ✅
- CDN 和代理服务器可以基于 Accept-Language 进行缓存
- 日志记录更清晰,Header 和参数分离

---

## 🔧 实现细节

### 前端实现 (`src/utils/request.ts`)

```typescript
// 请求拦截器
request.interceptors.request.use(
  (config) => {
    // 1. 添加认证 Token
    const token = localStorage.getItem("token");
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }

    // 2. 添加语言设置 (通过标准 HTTP Header)
    const locale = localStorage.getItem("locale") || "zh-CN";
    config.headers["Accept-Language"] = locale;

    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);
```

**效果**:
- 所有请求自动携带 `Accept-Language` header
- 业务代码无感知
- 语言切换后立即生效

---

### 后端实现 (`src/controllers/foodController.ts`)

```typescript
export const getFoods = async (req: AuthRequest, res: Response): Promise<void> => {
  try {
    // 从请求头获取语言设置
    const lang = (req.headers['accept-language'] as string) || 'zh-CN';

    // 根据语言选择对应字段
    const nameField = lang.startsWith('en')
      ? 'COALESCE(name_en, name)'
      : 'name';

    const categoryField = lang.startsWith('en')
      ? 'COALESCE(category_en, category)'
      : 'category';

    // 查询数据...
  }
};
```

**优点**:
- ✅ 统一从 `req.headers['accept-language']` 获取
- ✅ 不需要处理 query 参数
- ✅ 符合 RESTful 规范

---

## 📊 请求对比

### 优化前的请求

```http
GET /api/foods?page=1&limit=20&lang=zh-CN HTTP/1.1
Host: localhost:3000
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept-Language: zh-CN
Content-Type: application/json
```

**问题**: 语言参数同时出现在 Header 和 Query 中,冗余!

---

### 优化后的请求

```http
GET /api/foods?page=1&limit=20 HTTP/1.1
Host: localhost:3000
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept-Language: zh-CN
Content-Type: application/json
```

**优势**:
- ✅ URL 更简洁
- ✅ 参数职责清晰
- ✅ 符合标准规范

---

## 🌍 Accept-Language Header 详解

### 标准格式

```
Accept-Language: zh-CN
Accept-Language: en-US
Accept-Language: zh-CN,en;q=0.9  # 支持多个语言,带优先级
```

### 在各种场景中的应用

#### 1. **浏览器自动发送**
浏览器会根据用户系统语言自动发送 `Accept-Language`

#### 2. **CDN 缓存**
CDN 可以根据 `Accept-Language` 缓存不同语言版本

#### 3. **服务端渲染(SSR)**
Next.js, Nuxt.js 等框架都使用此 Header 进行语言检测

#### 4. **国际化标准**
W3C 推荐的多语言实现方式

---

## 🔄 完整的语言切换流程

```
┌─────────────────────────────────────────────┐
│  1. 用户在设置页面切换语言到 English        │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  2. saveLocale('en-US')                     │
│     → localStorage.setItem('locale','en-US')│
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  3. 用户进入饮食页面,点击"添加食物"         │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  4. 调用 getFoods()                         │
│     → axios.get('/api/foods')               │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  5. 请求拦截器自动处理                      │
│     locale = localStorage.getItem('locale') │
│     config.headers['Accept-Language']=locale│
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  6. 发送 HTTP 请求                          │
│     GET /api/foods?page=1&limit=20          │
│     Headers: Accept-Language: en-US         │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  7. 后端接收请求                            │
│     lang = req.headers['accept-language']   │
│     → 'en-US'                               │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  8. 根据语言查询数据库                      │
│     SELECT COALESCE(name_en, name) as name  │
│     → 返回英文数据                          │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  9. 前端显示                                │
│     { name: "Apple", category: "Fruits" }   │
└─────────────────────────────────────────────┘
```

---

## 🧪 测试验证

### 使用 curl 测试

```bash
# 测试中文
curl -H "Accept-Language: zh-CN" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:3000/api/foods

# 测试英文
curl -H "Accept-Language: en-US" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:3000/api/foods
```

### 使用浏览器开发者工具

1. 打开 H5 应用
2. F12 → Network
3. 点击"添加食物"
4. 查看 `/api/foods` 请求:

**请求头**:
```
Accept-Language: en-US
Authorization: Bearer xxx
Content-Type: application/json
```

**URL** (不包含 lang 参数):
```
http://localhost:3000/api/foods?page=1&limit=20
```

---

## 📝 更新的文件

### 前端
- ✅ `src/utils/request.ts` - 移除 query 参数,只使用 Header

### 后端
- ✅ `src/controllers/foodController.ts` - 只从 Header 读取语言

---

## 💡 最佳实践

### ✅ 推荐做法

1. **全局配置用 Header**
   - 语言、时区、认证信息

2. **业务参数用 Query/Body**
   - 分页、搜索、筛选条件

3. **敏感信息用 Header**
   - Token、API Key

### ❌ 避免做法

1. 同时在 Header 和 Query 传递相同参数
2. 把语言参数混在业务参数中
3. 在 URL 中暴露过多系统配置

---

## 🎉 总结

### 优化成果

- ✅ **URL 更简洁**: 移除冗余的 `&lang=` 参数
- ✅ **符合标准**: 使用标准的 `Accept-Language` Header
- ✅ **代码更优雅**: 前后端统一从 Header 获取
- ✅ **易于维护**: 参数职责清晰

### 兼容性

- ✅ 所有现代浏览器都支持 `Accept-Language`
- ✅ Node.js/Express 原生支持读取 Header
- ✅ 不影响现有功能

### 下一步

1. 执行数据库迁移
2. 填充英文数据
3. 重启服务
4. 测试多语言切换

**优化完成!** 🚀
