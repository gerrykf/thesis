# 权限模块实现文档

## 一、权限系统架构

### 角色定义

| 角色 | 角色代码 | role_id | 权限范围 |
|-----|---------|---------|---------|
| 普通用户 | `user` | 1 | 可登录后台查看数据,无编辑权限 |
| 管理员 | `admin` | 2 | 完整的数据管理权限,除角色管理外 |
| 超级管理员 | `super_admin` | 3 | 所有权限,包括角色和权限管理 |

### 客户端类型

- **H5客户端** (`X-Client-Type: h5`) - 面向普通用户的移动端
- **管理后台** (`X-Client-Type: admin`) - 面向管理员的后台系统

### 权限控制流程

```
请求 → JWT验证 → 客户端类型检查 → 角色权限检查 → 业务逻辑
```

## 二、数据库设计

### 角色表 (roles)

```sql
CREATE TABLE roles (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL COMMENT '角色名称',
  code VARCHAR(50) NOT NULL UNIQUE COMMENT '角色标识',
  status TINYINT DEFAULT 1 COMMENT '状态 1:启用 0:禁用',
  remark VARCHAR(255) COMMENT '备注',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 菜单表 (menus)

```sql
CREATE TABLE menus (
  id INT PRIMARY KEY AUTO_INCREMENT,
  parent_id INT DEFAULT 0 COMMENT '父菜单ID',
  title VARCHAR(50) NOT NULL COMMENT '菜单标题',
  path VARCHAR(100) COMMENT '路由路径',
  type TINYINT COMMENT '类型 1:菜单 2:按钮',
  permission VARCHAR(100) COMMENT '权限标识',
  status TINYINT DEFAULT 1 COMMENT '状态'
);
```

### 角色-菜单关联表 (role_menus)

```sql
CREATE TABLE role_menus (
  id INT PRIMARY KEY AUTO_INCREMENT,
  role_id INT NOT NULL,
  menu_id INT NOT NULL,
  UNIQUE KEY uk_role_menu (role_id, menu_id),
  FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
  FOREIGN KEY (menu_id) REFERENCES menus(id) ON DELETE CASCADE
);
```

### 用户表添加角色字段

```sql
ALTER TABLE users ADD COLUMN role_id INT DEFAULT 1;
ALTER TABLE users ADD FOREIGN KEY (role_id) REFERENCES roles(id);
```

## 三、后端实现

### 1. 认证中间件

**文件**: `src/middleware/auth.ts`

```typescript
export interface AuthRequest extends Request {
  user?: { userId: number; username: string; role: string; };
  clientType?: 'h5' | 'admin';
}

// 客户端类型检查
export const requireAdminClient = (req, res, next) => {
  if (req.clientType !== 'admin') {
    return res.status(403).json({
      success: false,
      message: '该接口仅限管理端访问'
    });
  }
  next();
};

// 角色权限检查
export const requireRole = (...roles: string[]) => {
  return (req, res, next) => {
    if (!req.user?.role || !roles.includes(req.user.role)) {
      return res.status(403).json({
        success: false,
        message: `需要${roles.join('或')}权限`
      });
    }
    next();
  };
};
```

### 2. 路由配置

**文件**: `src/routes/adminRoutes.ts`

```typescript
// 基础验证
router.use(authenticateToken);
router.use(requireAdminClient);

// 所有用户可访问
router.get('/menus', getMenus);
router.get('/foods', getAdminFoods);

// 管理员可访问
router.get('/users', requireRole('admin', 'super_admin'), getUsers);
router.put('/users/:id', requireRole('admin', 'super_admin'), updateUserById);

// 仅超级管理员
router.get('/roles', requireRole('super_admin'), getRoles);
router.put('/roles/:id/menus', requireRole('super_admin'), updateRoleMenus);
```

### 3. 核心API

**获取菜单** (所有用户可访问):
```typescript
GET /api/admin/menus
```

**获取角色列表** (仅超级管理员):
```typescript
GET /api/admin/roles
```

**更新角色权限** (仅超级管理员):
```typescript
PUT /api/admin/roles/:id/menus
Body: { menuIds: [1, 2, 3...] }
```

## 四、前端实现

### 1. 请求拦截器

```typescript
// 管理后台
request.interceptors.request.use(config => {
  config.headers["X-Client-Type"] = "admin";
  return config;
});

// H5前端
request.interceptors.request.use(config => {
  config.headers["X-Client-Type"] = "h5";
  return config;
});
```

### 2. 角色管理页面

**核心功能**:
- 角色列表管理(增删改查)
- 权限树配置(el-tree-v2)
- 状态启用/禁用

**关键实现**:
```typescript
// 只设置叶子节点,避免父节点自动选中
const leafIds = menuIds.filter(id => {
  const menu = findMenuById(treeData.value, id);
  return menu && (!menu.children || menu.children.length === 0);
});
treeRef.value.setCheckedKeys(leafIds);
```

## 五、权限控制矩阵

| 功能 | 普通用户 | 管理员 | 超级管理员 |
|-----|---------|--------|-----------|
| 登录后台 | ✅ | ✅ | ✅ |
| 查看菜单 | ✅ | ✅ | ✅ |
| 查看食物 | ✅ | ✅ | ✅ |
| 编辑食物 | ❌ | ✅ | ✅ |
| 用户管理 | ❌ | ✅ | ✅ |
| 角色管理 | ❌ | ❌ | ✅ |
| 权限配置 | ❌ | ❌ | ✅ |

## 六、安全特性

- ✅ 不能删除内置角色(id: 1, 2, 3)
- ✅ 不能修改内置角色权限
- ✅ 只有超级管理员可分配超级管理员角色
- ✅ 防止管理员修改自己的角色
- ✅ H5客户端无法访问管理接口
- ✅ 角色标识唯一性检查
- ✅ 更新权限使用数据库事务

## 七、相关文件

### 后端
- `src/middleware/auth.ts` - 认证中间件
- `src/controllers/authController.ts` - 登录控制器
- `src/controllers/adminController.ts` - 管理接口
- `src/routes/adminRoutes.ts` - 路由配置
- `migrations/rbac_system.sql` - 数据库迁移

### 前端
- `src/utils/request.ts` - 请求配置
- `src/views/role-management/` - 角色管理页面
- `src/views/user-management/` - 用户管理页面

---

**更新日期**: 2025-10-16
