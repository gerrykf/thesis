# ✅ H5端多语言功能验证清单

## 📋 前端配置检查

### 1. 请求拦截器配置 ✅

**文件**: `src/utils/request.ts`

**已实现功能**:
```typescript
// ✅ 自动读取当前语言设置
const locale = localStorage.getItem("locale") || "zh-CN";

// ✅ 添加 HTTP Header
config.headers["Accept-Language"] = locale;

// ✅ GET 请求添加 query 参数
if (config.method === "get") {
  config.params = {
    ...config.params,
    lang: locale,  // 自动添加 lang 参数
  };
}
```

**验证方式**:
打开浏览器开发者工具 → Network → 查看任意API请求:
- ✅ Headers 中应包含: `Accept-Language: zh-CN` 或 `en-US`
- ✅ GET请求 URL 应包含: `?lang=zh-CN` 或 `?lang=en-US`

---

### 2. 语言切换功能 ✅

**文件**: `src/views/my/settings.vue`

**已实现功能**:
```typescript
// ✅ 语言切换时更新多个地方
function onSelectLanguage(action: { value: SupportLocale }) {
  const newLocale = action.value;
  // 1. 更新 vue-i18n 语言
  locale.value = newLocale;
  // 2. 更新 Vant 组件库语言
  setVantLocale(newLocale);
  // 3. 保存到 localStorage
  saveLocale(newLocale);
}
```

**验证方式**:
1. 进入"我的" → "设置"
2. 点击"语言"选项
3. 切换到"English"
4. 检查 localStorage: `localStorage.getItem('locale')` 应为 `'en-US'`

---

### 3. 食物API调用 ✅

**文件**: `src/views/diet/index.vue`

**使用位置**:
```typescript
import { getFoods } from '@/api/food'

// 调用 getFoods 时,请求拦截器会自动添加语言参数
const response = await getFoods({
  page: 1,
  limit: 20
});
// 实际请求: GET /api/foods?page=1&limit=20&lang=zh-CN
```

---

## 🧪 完整测试流程

### 测试步骤 1: 验证中文模式

1. **打开H5应用并登录**
2. **确保当前语言为中文**
   - 进入"我的" → "设置" → "语言"
   - 确认选中"简体中文"
3. **打开浏览器开发者工具** (F12)
4. **进入饮食记录页面**
   - 点击"添加食物"按钮
5. **检查 Network 请求**:
   ```
   Request URL: http://localhost:3000/api/foods?page=1&limit=20&lang=zh-CN
   Request Headers:
     Accept-Language: zh-CN
     Authorization: Bearer xxx
   ```
6. **检查返回数据**:
   ```json
   {
     "foods": [
       {
         "name": "苹果",      // 应为中文
         "category": "水果"    // 应为中文
       }
     ]
   }
   ```

---

### 测试步骤 2: 验证英文模式

1. **切换语言为英文**
   - 进入"我的" → "设置" → "语言"
   - 选择"English"
2. **刷新页面或重新进入饮食记录**
3. **点击"添加食物"**
4. **检查 Network 请求**:
   ```
   Request URL: http://localhost:3000/api/foods?page=1&limit=20&lang=en-US
   Request Headers:
     Accept-Language: en-US
     Authorization: Bearer xxx
   ```
5. **检查返回数据**:
   ```json
   {
     "foods": [
       {
         "name": "Apple",     // 应为英文
         "category": "Fruits"  // 应为英文
       }
     ]
   }
   ```

---

### 测试步骤 3: 验证语言切换即时生效

1. **在饮食记录页面停留**
2. **打开"设置"页面**(新标签页或侧边栏)
3. **切换语言**
4. **返回饮食记录页面**
5. **重新点击"添加食物"**
6. **验证**: 食物列表应显示新语言的内容

---

## 📸 预期截图对比

### 中文模式
```
┌─────────────────────────┐
│   🍎 添加食物           │
├─────────────────────────┤
│ 搜索食物...             │
├─────────────────────────┤
│ 水果 (23)               │
│ 蔬菜 (45)               │
│ 肉类 (18)               │
├─────────────────────────┤
│ 苹果      52 kcal       │
│ 香蕉      89 kcal       │
│ 橙子      47 kcal       │
└─────────────────────────┘
```

### 英文模式
```
┌─────────────────────────┐
│   🍎 Add Food           │
├─────────────────────────┤
│ Search food...          │
├─────────────────────────┤
│ Fruits (23)             │
│ Vegetables (45)         │
│ Meat (18)               │
├─────────────────────────┤
│ Apple     52 kcal       │
│ Banana    89 kcal       │
│ Orange    47 kcal       │
└─────────────────────────┘
```

---

## 🔍 调试技巧

### 方法 1: 控制台查看 localStorage

```javascript
// 在浏览器控制台执行
console.log('当前语言:', localStorage.getItem('locale'));
// 应输出: 'zh-CN' 或 'en-US'
```

### 方法 2: 手动测试请求拦截器

```javascript
// 在浏览器控制台执行
fetch('/api/foods?limit=1')
  .then(res => res.json())
  .then(data => console.log('食物数据:', data));

// 检查 Network 面板,请求头应包含:
// Accept-Language: zh-CN (或 en-US)
```

### 方法 3: 使用 Vue DevTools

1. 安装 Vue DevTools 浏览器扩展
2. 打开 DevTools → Vue 标签
3. 选择当前组件
4. 查看 Setup → locale 的值
5. 应为 `'zh-CN'` 或 `'en-US'`

---

## ⚠️ 常见问题排查

### 问题 1: 切换语言后,食物仍显示中文

**原因**:
- 后端数据库英文字段为空
- 后端代码未更新

**解决方法**:
```bash
# 1. 确认数据库已添加英文字段
mysql -u root -p -e "DESCRIBE health_management.foods" | grep _en

# 2. 填充英文数据
mysql -u root -p health_management < 程序实现文档/db/sample_i18n_data.sql

# 3. 重启后端服务
cd 程序实现文档/backend/health-backend
pnpm run dev
```

---

### 问题 2: 请求头没有 Accept-Language

**原因**:
- request.ts 文件未更新
- 页面使用的是其他 axios 实例

**检查方法**:
```typescript
// 在 diet/index.vue 中查找
import { getFoods } from '@/api/food'

// 确认 @/api/food 使用的是 @/utils/request
// 查看 src/api/food.ts
import request from "@/utils/request";  // ✅ 正确
```

---

### 问题 3: 切换语言后需要刷新页面才生效

**原因**:
- 组件未响应 locale 变化
- API 数据已缓存

**解决方法**:
在组件中监听语言变化:
```typescript
import { watch } from 'vue';
import { useI18n } from 'vue-i18n';

const { locale } = useI18n();

// 监听语言变化,重新加载数据
watch(locale, () => {
  loadFoods(); // 重新调用 API
});
```

---

## ✅ 最终验证清单

完成以下所有项,确认功能正常:

- [ ] localStorage 中能正确保存选中的语言
- [ ] 切换语言后,界面文字立即更新
- [ ] API 请求头包含 `Accept-Language`
- [ ] GET 请求 URL 包含 `lang` 参数
- [ ] 中文模式下,食物名称显示中文
- [ ] 英文模式下,食物名称显示英文
- [ ] 搜索功能支持中英文关键词
- [ ] 分类筛选显示对应语言
- [ ] 刷新页面后语言设置保持不变
- [ ] 退出登录重新登录,语言设置保持不变

---

## 📞 技术支持

如果以上验证都通过,但仍有问题,请提供:

1. 浏览器控制台截图
2. Network 请求详情
3. localStorage 内容
4. 后端日志(如有)

---

## 🎉 总结

H5端已完成以下配置:

✅ **自动语言检测**
- 从 localStorage 读取当前语言
- 自动添加到请求头和参数

✅ **语言切换功能**
- 用户界面支持中英文切换
- 切换后自动保存到本地

✅ **API 集成**
- 所有 HTTP 请求自动携带语言参数
- 无需修改业务代码

🚀 **开始测试吧!**
