# 多语言数据库实施指南

## 📋 概述

本文档说明如何为健康管理系统的食物数据库添加多语言支持(中英文)。

## 🎯 实施方案

### 方案选择: 数据库字段扩展

- ✅ 为需要翻译的字段添加对应的英文字段
- ✅ 在 SQL 查询时根据语言参数选择对应字段
- ✅ 前端请求时自动携带语言参数

### 优点
- 查询性能好,无需JOIN
- 数据结构清晰
- 易于维护和扩展
- 支持字段级别的回退(英文缺失时显示中文)

## 📊 数据库变更

### 新增字段列表

在 `foods` 表中新增以下英文字段:

| 原字段 | 新增英文字段 | 类型 | 说明 |
|--------|-------------|------|------|
| `category` | `category_en` | VARCHAR(50) | 食物分类英文 |
| `sub_category` | `sub_category_en` | VARCHAR(50) | 子分类英文 |
| `description` | `description_en` | TEXT | 食物描述英文 |

**注**: `name_en` 字段已存在,无需新增。

### 新增索引

```sql
INDEX idx_name_en (name_en)
INDEX idx_category_en (category_en)
FULLTEXT INDEX ft_name_desc (name, name_en, description, description_en)
```

## 🚀 实施步骤

### 1. 备份数据库

```bash
mysqldump -u root -p health_management > health_management_backup_$(date +%Y%m%d).sql
```

### 2. 执行数据库迁移

**选项 A: 新建数据库(推荐用于开发环境)**
```bash
mysql -u root -p < 程序实现文档/db/init_database.sql
```

**选项 B: 在现有数据库上添加字段(生产环境)**
```bash
mysql -u root -p < 程序实现文档/db/migrate_add_i18n_fields.sql
```

### 3. 填充英文数据

```bash
# 使用示例数据(包含常见食物的英文翻译)
mysql -u root -p < 程序实现文档/db/sample_i18n_data.sql
```

### 4. 验证数据库更新

```sql
-- 检查表结构
DESCRIBE foods;

-- 检查英文字段是否已添加
SELECT
  name, name_en,
  category, category_en,
  sub_category, sub_category_en
FROM foods
LIMIT 5;
```

### 5. 重启后端服务

```bash
cd 程序实现文档/backend/health-backend
pnpm run dev
```

### 6. 测试多语言功能

**测试中文请求:**
```bash
curl -H "Accept-Language: zh-CN" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:3000/api/foods
```

**测试英文请求:**
```bash
curl -H "Accept-Language: en-US" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:3000/api/foods
```

## 📝 API 变更说明

### 请求参数

所有食物相关的 API 现在支持以下语言参数:

1. **HTTP Header** (推荐)
   ```
   Accept-Language: zh-CN  # 中文
   Accept-Language: en-US  # 英文
   ```

2. **Query 参数**
   ```
   GET /api/foods?lang=zh-CN  # 中文
   GET /api/foods?lang=en-US  # 英文
   ```

### 返回数据格式

**中文请求示例:**
```json
{
  "id": 1,
  "name": "苹果",
  "name_zh": "苹果",
  "name_en": "Apple",
  "category": "水果",
  "category_zh": "水果",
  "category_en": "Fruits",
  "description": "新鲜红苹果",
  "description_zh": "新鲜红苹果",
  "description_en": "Fresh red apple",
  ...
}
```

**英文请求示例:**
```json
{
  "id": 1,
  "name": "Apple",
  "name_zh": "苹果",
  "name_en": "Apple",
  "category": "Fruits",
  "category_zh": "水果",
  "category_en": "Fruits",
  "description": "Fresh red apple",
  "description_zh": "新鲜红苹果",
  "description_en": "Fresh red apple",
  ...
}
```

**说明:**
- `name`, `category`, `description` 等字段根据语言自动切换
- 同时返回 `_zh` 和 `_en` 后缀的原始字段,便于客户端使用

## 🔧 后端代码变更

### 已修改的文件

1. **foodController.ts**
   - 更新 `getFoods()` - 支持多语言查询
   - 更新 `getFoodById()` - 支持多语言查询
   - 更新 `getFoodCategories()` - 支持多语言分类
   - 移除映射表,改用数据库字段

### 核心实现逻辑

```typescript
// 根据语言参数选择字段
const lang = req.query.lang || req.headers['accept-language'] || 'zh-CN';

const nameField = lang.startsWith('en')
  ? 'COALESCE(name_en, name)'  // 英文优先,无英文时回退中文
  : 'name';                      // 直接使用中文

// SQL查询示例
SELECT
  ${nameField} as name,
  name as name_zh,
  name_en,
  ${categoryField} as category,
  category as category_zh,
  category_en
FROM foods
```

## 🎨 前端集成

### 自动语言切换

前端请求拦截器已配置,会自动携带当前语言:

```typescript
// utils/request.ts
const locale = localStorage.getItem("locale") || "zh-CN";
config.headers["Accept-Language"] = locale;
```

**用户操作流程:**
1. 用户在前端切换语言 → localStorage 更新
2. 发起 API 请求 → 自动携带语言参数
3. 后端返回对应语言的数据
4. 前端展示翻译后的内容

## 📈 数据维护

### 添加新食物

在添加新食物时,建议同时填写中英文字段:

```sql
INSERT INTO foods (
  name, name_en,
  category, category_en,
  sub_category, sub_category_en,
  description, description_en,
  calories_per_100g,
  ...
) VALUES (
  '苹果', 'Apple',
  '水果', 'Fruits',
  '新鲜水果', 'Fresh Fruits',
  '新鲜红苹果，富含维生素', 'Fresh red apple, rich in vitamins',
  52,
  ...
);
```

### 批量更新英文数据

如果有大量现有数据需要添加英文翻译,可以:

1. **使用翻译API**
   ```javascript
   // 示例: 使用翻译服务批量翻译
   const foods = await db.query('SELECT id, name, description FROM foods WHERE name_en IS NULL');

   for (const food of foods) {
     const nameEn = await translateAPI(food.name);
     const descEn = await translateAPI(food.description);
     await db.execute(
       'UPDATE foods SET name_en = ?, description_en = ? WHERE id = ?',
       [nameEn, descEn, food.id]
     );
   }
   ```

2. **手动整理Excel后导入**
   - 导出: `SELECT id, name, category, description FROM foods`
   - 在Excel中添加英文翻译
   - 使用 UPDATE 语句批量导入

## ✅ 验证清单

完成实施后,请验证以下功能:

- [ ] 数据库字段已正确添加
- [ ] 索引已创建
- [ ] 后端服务正常启动
- [ ] 中文请求返回中文数据
- [ ] 英文请求返回英文数据
- [ ] 英文缺失时正确回退到中文
- [ ] 搜索功能支持中英文
- [ ] 分类筛选支持中英文
- [ ] 前端语言切换后数据自动更新

## 🐛 常见问题

### Q1: 英文字段为空时显示什么?
A: 使用 `COALESCE` 函数自动回退到中文,确保始终有内容显示。

### Q2: 如何添加更多语言?
A: 按照相同模式添加字段(如 `name_ja`, `name_fr`),并在代码中扩展语言判断逻辑。

### Q3: 影响性能吗?
A: 字段扩展方式对性能影响很小,因为:
- 无需 JOIN 操作
- 已添加索引优化查询
- 使用 COALESCE 函数性能损耗可忽略

### Q4: 如何回滚?
A: 执行以下SQL删除新增字段:
```sql
ALTER TABLE foods
DROP COLUMN category_en,
DROP COLUMN sub_category_en,
DROP COLUMN description_en;
```

## 📞 技术支持

如遇到问题,请检查:
1. 数据库版本 >= MySQL 8.0
2. 后端 Node.js 版本 >= 18
3. 查看后端日志: `logs/access.log`
4. 使用浏览器开发者工具检查 API 请求

## 🎉 总结

通过本方案,系统现已支持:
- ✅ 中英文数据库字段
- ✅ 自动语言检测和切换
- ✅ 优雅的字段回退机制
- ✅ 高性能的查询实现
- ✅ 便于维护和扩展

祝使用愉快! 🚀
