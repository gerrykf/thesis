# 📊 健康管理系统 - 数据库表结构说明

**数据库名称**: `health_management`
**字符集**: `utf8mb4`
**排序规则**: `utf8mb4_unicode_ci`
**数据库版本**: MySQL 8.0+
**创建日期**: 2025-10-04

---

## 📑 目录

1. [用户表 (users)](#1-用户表-users)
2. [食物分类表 (food_categories)](#2-食物分类表-food_categories)
3. [食物表 (foods)](#3-食物表-foods)
4. [健康记录表 (health_records)](#4-健康记录表-health_records)
5. [饮食记录表 (diet_records)](#5-饮食记录表-diet_records)
6. [用户目标表 (user_goals)](#6-用户目标表-user_goals)
7. [系统日志表 (system_logs)](#7-系统日志表-system_logs)
8. [表关系图](#8-表关系图)

---

## 1. 用户表 (users)

**表名**: `users`
**说明**: 存储用户基本信息、身体数据和账户状态

### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | - | 用户ID（主键） |
| `username` | VARCHAR(50) | UNIQUE, NOT NULL | - | 用户名（唯一） |
| `password` | VARCHAR(255) | NOT NULL | - | 密码（bcrypt加密） |
| `nickname` | VARCHAR(50) | - | NULL | 昵称 |
| `phone` | VARCHAR(20) | - | NULL | 手机号 |
| `email` | VARCHAR(100) | - | NULL | 邮箱 |
| `gender` | ENUM('male', 'female') | - | NULL | 性别 |
| `birth_date` | DATE | - | NULL | 出生日期 |
| `height` | DECIMAL(5,2) | - | NULL | 身高（cm） |
| `target_weight` | DECIMAL(5,2) | - | NULL | 目标体重（kg） |
| `avatar` | VARCHAR(255) | - | NULL | 头像URL |
| `role` | ENUM('user', 'admin') | - | 'user' | 用户角色 |
| `is_active` | BOOLEAN | - | TRUE | 是否激活 |
| `last_login_at` | TIMESTAMP | - | NULL | 最后登录时间 |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | TIMESTAMP | ON UPDATE | CURRENT_TIMESTAMP | 更新时间 |

### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| `PRIMARY` | 主键 | `id` | 主键索引 |
| `idx_username` | 普通索引 | `username` | 用户名查询 |
| `idx_email` | 普通索引 | `email` | 邮箱查询 |
| `idx_phone` | 普通索引 | `phone` | 手机号查询 |
| `idx_created_at` | 普通索引 | `created_at` | 创建时间查询 |

### 外键关系

- 被引用表：`foods`、`health_records`、`diet_records`、`user_goals`、`system_logs`

---

## 2. 食物分类表 (food_categories)

**表名**: `food_categories`
**说明**: 食物分类管理（支持多级分类、中英文）

### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | - | 分类ID（主键） |
| `name` | VARCHAR(50) | NOT NULL | - | 分类名称（中文） |
| `name_en` | VARCHAR(50) | - | NULL | 分类名称（英文） |
| `parent_id` | INT | FOREIGN KEY | NULL | 父分类ID（自引用） |
| `level` | TINYINT | - | 1 | 分类层级 |
| `sort_order` | INT | - | 0 | 排序顺序 |
| `icon` | VARCHAR(100) | - | NULL | 分类图标 |
| `color` | VARCHAR(20) | - | NULL | 分类颜色 |
| `description` | TEXT | - | NULL | 分类描述 |
| `is_active` | BOOLEAN | - | TRUE | 是否启用 |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | TIMESTAMP | ON UPDATE | CURRENT_TIMESTAMP | 更新时间 |

### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| `PRIMARY` | 主键 | `id` | 主键索引 |
| `idx_parent_id` | 普通索引 | `parent_id` | 父分类查询 |
| `idx_level` | 普通索引 | `level` | 层级查询 |
| `idx_sort_order` | 普通索引 | `sort_order` | 排序查询 |

### 外键关系

| 外键名 | 引用字段 | 引用表 | 引用字段 | 删除规则 |
|--------|---------|--------|---------|---------|
| `fk_food_categories_parent` | `parent_id` | `food_categories` | `id` | SET NULL |

---

## 3. 食物表 (foods)

**表名**: `foods`
**说明**: 存储食物基本信息和营养成分（支持中英文多语言）

### 字段说明

#### 基本信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | - | 食物ID（主键） |
| `name` | VARCHAR(100) | NOT NULL | - | 食物名称（中文） |
| `name_en` | VARCHAR(100) | - | NULL | 食物名称（英文） |
| `category` | VARCHAR(50) | NOT NULL | - | 食物分类（中文） |
| `category_en` | VARCHAR(50) | - | NULL | 食物分类（英文） |
| `sub_category` | VARCHAR(50) | - | NULL | 子分类（中文） |
| `sub_category_en` | VARCHAR(50) | - | NULL | 子分类（英文） |
| `brand` | VARCHAR(100) | - | NULL | 品牌 |

#### 营养成分（每100g）

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `calories_per_100g` | DECIMAL(8,2) | NOT NULL | - | 每100g热量（kcal） |
| `protein_per_100g` | DECIMAL(6,2) | - | 0 | 每100g蛋白质（g） |
| `fat_per_100g` | DECIMAL(6,2) | - | 0 | 每100g脂肪（g） |
| `carbs_per_100g` | DECIMAL(6,2) | - | 0 | 每100g碳水化合物（g） |
| `fiber_per_100g` | DECIMAL(6,2) | - | 0 | 每100g纤维（g） |
| `sodium_per_100g` | DECIMAL(8,2) | - | 0 | 每100g钠（mg） |
| `sugar_per_100g` | DECIMAL(6,2) | - | 0 | 每100g糖（g） |
| `cholesterol_per_100g` | DECIMAL(6,2) | - | 0 | 每100g胆固醇（mg） |
| `vitamin_c_per_100g` | DECIMAL(6,2) | - | 0 | 每100g维生素C（mg） |
| `calcium_per_100g` | DECIMAL(6,2) | - | 0 | 每100g钙（mg） |
| `iron_per_100g` | DECIMAL(6,2) | - | 0 | 每100g铁（mg） |

#### 其他信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `image_url` | VARCHAR(255) | - | NULL | 食物图片URL |
| `barcode` | VARCHAR(50) | - | NULL | 条形码 |
| `description` | TEXT | - | NULL | 食物描述（中文） |
| `description_en` | TEXT | - | NULL | 食物描述（英文） |
| `serving_size` | DECIMAL(6,2) | - | NULL | 建议食用量（g） |

#### 状态信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `is_active` | BOOLEAN | - | TRUE | 是否启用 |
| `is_verified` | BOOLEAN | - | FALSE | 是否已验证 |
| `created_by` | INT | FOREIGN KEY | NULL | 创建者ID |
| `verified_by` | INT | FOREIGN KEY | NULL | 验证者ID |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | TIMESTAMP | ON UPDATE | CURRENT_TIMESTAMP | 更新时间 |

### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| `PRIMARY` | 主键 | `id` | 主键索引 |
| `idx_name` | 普通索引 | `name` | 中文名称查询 |
| `idx_name_en` | 普通索引 | `name_en` | 英文名称查询 |
| `idx_category` | 普通索引 | `category` | 中文分类查询 |
| `idx_category_en` | 普通索引 | `category_en` | 英文分类查询 |
| `idx_barcode` | 普通索引 | `barcode` | 条形码查询 |
| `idx_calories` | 普通索引 | `calories_per_100g` | 热量范围查询 |
| `idx_created_by` | 普通索引 | `created_by` | 创建者查询 |
| `idx_is_active` | 普通索引 | `is_active` | 状态筛选 |
| `ft_name_desc` | 全文索引 | `name, name_en, description, description_en` | 中英文全文搜索 |

### 外键关系

| 外键名 | 引用字段 | 引用表 | 引用字段 | 删除规则 |
|--------|---------|--------|---------|---------|
| - | `created_by` | `users` | `id` | SET NULL |
| - | `verified_by` | `users` | `id` | SET NULL |

---

## 4. 健康记录表 (health_records)

**表名**: `health_records`
**说明**: 用户每日健康数据记录（体重、运动、睡眠、心情）

### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID（主键） |
| `user_id` | INT | FOREIGN KEY, NOT NULL | - | 用户ID |
| `record_date` | DATE | NOT NULL | - | 记录日期 |
| `weight` | DECIMAL(5,2) | - | NULL | 体重（kg） |
| `exercise_duration` | INT | - | NULL | 运动时长（分钟） |
| `exercise_type` | VARCHAR(200) | - | NULL | 运动类型 |
| `sleep_hours` | DECIMAL(4,2) | - | NULL | 睡眠时长（小时） |
| `sleep_quality` | ENUM('excellent', 'good', 'fair', 'poor') | - | NULL | 睡眠质量 |
| `mood` | ENUM('excellent', 'good', 'fair', 'poor') | - | NULL | 心情状态 |
| `notes` | TEXT | - | NULL | 备注 |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | TIMESTAMP | ON UPDATE | CURRENT_TIMESTAMP | 更新时间 |

### 索引和约束

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| `PRIMARY` | 主键 | `id` | 主键索引 |
| `unique_user_date` | 唯一索引 | `user_id, record_date` | 每用户每日唯一记录 |
| `idx_user_date` | 普通索引 | `user_id, record_date` | 用户日期查询 |
| `idx_record_date` | 普通索引 | `record_date` | 日期查询 |
| `idx_weight` | 普通索引 | `weight` | 体重查询 |
| `idx_created_at` | 普通索引 | `created_at` | 创建时间查询 |

### 外键关系

| 外键名 | 引用字段 | 引用表 | 引用字段 | 删除规则 |
|--------|---------|--------|---------|---------|
| - | `user_id` | `users` | `id` | CASCADE |

---

## 5. 饮食记录表 (diet_records)

**表名**: `diet_records`
**说明**: 用户饮食记录（记录每餐吃了什么、吃了多少）

### 字段说明

#### 基本信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID（主键） |
| `user_id` | INT | FOREIGN KEY, NOT NULL | - | 用户ID |
| `food_id` | INT | FOREIGN KEY, NOT NULL | - | 食物ID |
| `record_date` | DATE | NOT NULL | - | 记录日期 |
| `meal_type` | ENUM('breakfast', 'lunch', 'dinner', 'snack') | NOT NULL | - | 餐次类型 |
| `meal_time` | TIME | - | NULL | 用餐时间 |
| `quantity` | DECIMAL(8,2) | NOT NULL | - | 食用量（g） |

#### 营养成分（实际摄入）

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `calories` | DECIMAL(8,2) | NOT NULL | - | 热量（kcal） |
| `protein` | DECIMAL(6,2) | - | 0 | 蛋白质（g） |
| `fat` | DECIMAL(6,2) | - | 0 | 脂肪（g） |
| `carbs` | DECIMAL(6,2) | - | 0 | 碳水化合物（g） |
| `fiber` | DECIMAL(6,2) | - | 0 | 纤维（g） |
| `sodium` | DECIMAL(8,2) | - | 0 | 钠（mg） |

#### 其他信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `notes` | VARCHAR(255) | - | NULL | 备注 |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | TIMESTAMP | ON UPDATE | CURRENT_TIMESTAMP | 更新时间 |

### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| `PRIMARY` | 主键 | `id` | 主键索引 |
| `idx_user_date` | 普通索引 | `user_id, record_date` | 用户日期查询 |
| `idx_meal_type` | 普通索引 | `meal_type` | 餐次查询 |
| `idx_food_id` | 普通索引 | `food_id` | 食物查询 |
| `idx_record_date` | 普通索引 | `record_date` | 日期查询 |
| `idx_calories` | 普通索引 | `calories` | 热量查询 |

### 外键关系

| 外键名 | 引用字段 | 引用表 | 引用字段 | 删除规则 |
|--------|---------|--------|---------|---------|
| - | `user_id` | `users` | `id` | CASCADE |
| - | `food_id` | `foods` | `id` | RESTRICT |

---

## 6. 用户目标表 (user_goals)

**表名**: `user_goals`
**说明**: 用户设定的健康目标（减重、运动、卡路里控制等）

### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | - | 目标ID（主键） |
| `user_id` | INT | FOREIGN KEY, NOT NULL | - | 用户ID |
| `goal_type` | ENUM('weight', 'exercise', 'calories', 'custom') | NOT NULL | - | 目标类型 |
| `goal_name` | VARCHAR(100) | NOT NULL | - | 目标名称 |
| `target_value` | DECIMAL(10,2) | NOT NULL | - | 目标值 |
| `current_value` | DECIMAL(10,2) | - | 0 | 当前值 |
| `unit` | VARCHAR(20) | - | NULL | 单位 |
| `start_date` | DATE | NOT NULL | - | 开始日期 |
| `target_date` | DATE | - | NULL | 目标日期 |
| `status` | ENUM('active', 'completed', 'paused', 'cancelled') | - | 'active' | 状态 |
| `description` | TEXT | - | NULL | 目标描述 |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | TIMESTAMP | ON UPDATE | CURRENT_TIMESTAMP | 更新时间 |

### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| `PRIMARY` | 主键 | `id` | 主键索引 |
| `idx_user_id` | 普通索引 | `user_id` | 用户查询 |
| `idx_goal_type` | 普通索引 | `goal_type` | 目标类型查询 |
| `idx_status` | 普通索引 | `status` | 状态查询 |
| `idx_target_date` | 普通索引 | `target_date` | 目标日期查询 |

### 外键关系

| 外键名 | 引用字段 | 引用表 | 引用字段 | 删除规则 |
|--------|---------|--------|---------|---------|
| - | `user_id` | `users` | `id` | CASCADE |

---

## 7. 系统日志表 (system_logs)

**表名**: `system_logs`
**说明**: 记录系统操作日志（用户行为、API请求、错误信息）

### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | - | 日志ID（主键） |
| `user_id` | INT | FOREIGN KEY | NULL | 用户ID |
| `action` | VARCHAR(100) | NOT NULL | - | 操作类型 |
| `resource` | VARCHAR(100) | - | NULL | 操作资源 |
| `resource_id` | INT | - | NULL | 资源ID |
| `method` | VARCHAR(10) | - | NULL | HTTP方法 |
| `url` | VARCHAR(500) | - | NULL | 请求URL |
| `ip_address` | VARCHAR(45) | - | NULL | IP地址（支持IPv6） |
| `user_agent` | TEXT | - | NULL | 用户代理 |
| `request_data` | JSON | - | NULL | 请求数据 |
| `response_status` | INT | - | NULL | 响应状态码 |
| `response_time` | INT | - | NULL | 响应时间（ms） |
| `error_message` | TEXT | - | NULL | 错误信息 |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | 创建时间 |

### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| `PRIMARY` | 主键 | `id` | 主键索引 |
| `idx_user_id` | 普通索引 | `user_id` | 用户查询 |
| `idx_action` | 普通索引 | `action` | 操作类型查询 |
| `idx_resource` | 普通索引 | `resource` | 资源查询 |
| `idx_ip_address` | 普通索引 | `ip_address` | IP地址查询 |
| `idx_created_at` | 普通索引 | `created_at` | 时间查询 |
| `idx_response_status` | 普通索引 | `response_status` | 状态码查询 |

### 外键关系

| 外键名 | 引用字段 | 引用表 | 引用字段 | 删除规则 |
|--------|---------|--------|---------|---------|
| - | `user_id` | `users` | `id` | SET NULL |

---

## 8. 表关系图

```
┌─────────────────┐
│     users       │ (用户表)
│                 │
│ • id (PK)       │
│ • username      │
│ • password      │
│ • nickname      │
│ • ...           │
└────────┬────────┘
         │
         │ 1
         │
         ├──────────────────────────────────┐
         │                                  │
         │ N                                │ N
         │                                  │
┌────────▼────────┐              ┌─────────▼─────────┐
│ health_records  │              │   diet_records    │
│                 │              │                   │
│ • id (PK)       │              │ • id (PK)         │
│ • user_id (FK)  │              │ • user_id (FK)    │
│ • record_date   │              │ • food_id (FK) ───┐
│ • weight        │              │ • meal_type       │
│ • exercise_*    │              │ • quantity        │
│ • sleep_*       │              │ • calories        │
│ • mood          │              │ • ...             │
└─────────────────┘              └───────────────────┘
                                           │
         ┌─────────────────────────────────┘
         │
         │ N
         │
         │ 1
┌────────▼────────┐
│     foods       │ (食物表)
│                 │
│ • id (PK)       │
│ • name          │
│ • name_en       │
│ • category      │
│ • category_en   │
│ • calories_*    │
│ • protein_*     │
│ • created_by ───┼──────┐
│ • verified_by ──┼──┐   │
└─────────────────┘  │   │
                     │   │
         ┌───────────┘   │
         │               │
         │ N             │ N
         │               │
         │ 1             │ 1
         └───────────────┴────────users


┌──────────────────┐
│  user_goals      │ (用户目标表)
│                  │
│ • id (PK)        │
│ • user_id (FK) ──┼──► users (1:N)
│ • goal_type      │
│ • target_value   │
│ • status         │
│ • ...            │
└──────────────────┘


┌──────────────────┐
│  system_logs     │ (系统日志表)
│                  │
│ • id (PK)        │
│ • user_id (FK) ──┼──► users (1:N)
│ • action         │
│ • url            │
│ • ip_address     │
│ • ...            │
└──────────────────┘


┌───────────────────┐
│ food_categories   │ (食物分类表)
│                   │
│ • id (PK)         │
│ • name            │
│ • name_en         │
│ • parent_id (FK) ─┼──► food_categories (自引用)
│ • level           │
│ • ...             │
└───────────────────┘
```

---

## 📌 关键特性说明

### 1. 多语言支持

**支持表**: `foods`, `food_categories`

- 中文字段: `name`, `category`, `sub_category`, `description`
- 英文字段: `name_en`, `category_en`, `sub_category_en`, `description_en`
- 使用 `COALESCE` 函数自动回退到中文

### 2. 软删除设计

部分表使用 `is_active` 字段实现软删除:
- `users.is_active`
- `foods.is_active`
- `food_categories.is_active`

### 3. 级联删除规则

| 父表 | 子表 | 删除规则 | 说明 |
|------|------|---------|------|
| users | health_records | CASCADE | 用户删除时,健康记录一并删除 |
| users | diet_records | CASCADE | 用户删除时,饮食记录一并删除 |
| users | user_goals | CASCADE | 用户删除时,目标一并删除 |
| foods | diet_records | RESTRICT | 食物被引用时,不允许删除 |
| users | system_logs | SET NULL | 用户删除时,日志保留但user_id置空 |

### 4. 唯一性约束

| 表 | 字段 | 说明 |
|----|------|------|
| users | `username` | 用户名唯一 |
| health_records | `(user_id, record_date)` | 每用户每日只能有一条健康记录 |

### 5. 自动时间戳

所有表都包含:
- `created_at`: 创建时自动设置
- `updated_at`: 更新时自动更新

### 6. JSON 数据类型

`system_logs.request_data` 使用 JSON 类型存储请求数据,支持:
- 复杂数据结构存储
- JSON 查询和索引

---

## 🔍 常用查询示例

### 查询用户今日饮食摄入

```sql
SELECT
    u.username,
    dr.meal_type,
    f.name AS food_name,
    dr.quantity,
    dr.calories
FROM diet_records dr
JOIN users u ON dr.user_id = u.id
JOIN foods f ON dr.food_id = f.id
WHERE dr.user_id = 1
  AND dr.record_date = CURDATE()
ORDER BY dr.meal_time;
```

### 查询用户一周体重变化

```sql
SELECT
    record_date,
    weight
FROM health_records
WHERE user_id = 1
  AND record_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
ORDER BY record_date;
```

### 查询热量最高的食物（TOP 10）

```sql
SELECT
    name,
    name_en,
    category,
    calories_per_100g
FROM foods
WHERE is_active = TRUE
ORDER BY calories_per_100g DESC
LIMIT 10;
```

### 查询用户活跃目标

```sql
SELECT
    goal_type,
    goal_name,
    target_value,
    current_value,
    unit,
    DATEDIFF(target_date, CURDATE()) AS days_remaining
FROM user_goals
WHERE user_id = 1
  AND status = 'active'
ORDER BY target_date;
```

---

## 📊 数据统计

### 表数量
- **总计**: 7 张表

### 表类型分类
- **用户相关**: users, user_goals
- **食物相关**: foods, food_categories
- **记录相关**: health_records, diet_records
- **系统相关**: system_logs

### 索引统计
- **主键索引**: 7 个
- **普通索引**: 40+ 个
- **唯一索引**: 2 个
- **全文索引**: 1 个
- **外键约束**: 12 个

---

## 🎯 设计原则

1. **规范化**: 符合第三范式,减少数据冗余
2. **可扩展性**: 支持多语言、多级分类
3. **性能优化**: 合理创建索引,支持高效查询
4. **数据完整性**: 使用外键约束保证数据一致性
5. **审计追踪**: 所有表包含时间戳,system_logs 记录操作
6. **安全性**: 密码加密,支持角色权限

---

**文档生成时间**: 2025-10-12
**维护人员**: Claude Code
**版本**: v1.0
