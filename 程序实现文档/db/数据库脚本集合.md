# 健康管理系统数据库脚本集合

## 1. 数据库初始化脚本

### 1.1 创建数据库和用户
```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS health_management
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE health_management;

-- 创建应用用户
CREATE USER 'health_app'@'%' IDENTIFIED BY 'HealthApp@2024';
CREATE USER 'health_readonly'@'%' IDENTIFIED BY 'ReadOnly@2024';

-- 授权
GRANT SELECT, INSERT, UPDATE, DELETE ON health_management.* TO 'health_app'@'%';
GRANT EXECUTE ON health_management.* TO 'health_app'@'%';
GRANT SELECT ON health_management.* TO 'health_readonly'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 1.2 数据表创建脚本
```sql
-- 用户表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(255) NOT NULL COMMENT '密码(bcrypt加密)',
    nickname VARCHAR(50) COMMENT '昵称',
    phone VARCHAR(20) COMMENT '手机号',
    email VARCHAR(100) COMMENT '邮箱',
    gender ENUM('male', 'female') COMMENT '性别',
    birth_date DATE COMMENT '出生日期',
    height DECIMAL(5,2) COMMENT '身高(cm)',
    target_weight DECIMAL(5,2) COMMENT '目标体重(kg)',
    avatar VARCHAR(255) COMMENT '头像URL',
    role ENUM('user', 'admin') DEFAULT 'user' COMMENT '用户角色',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否激活',
    last_login_at TIMESTAMP NULL COMMENT '最后登录时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_created_at (created_at)
) COMMENT '用户表';

-- 食物分类表
CREATE TABLE food_categories (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
    name VARCHAR(50) NOT NULL COMMENT '分类名称',
    name_en VARCHAR(50) COMMENT '英文名称',
    parent_id INT COMMENT '父分类ID',
    level TINYINT DEFAULT 1 COMMENT '分类层级',
    sort_order INT DEFAULT 0 COMMENT '排序顺序',
    icon VARCHAR(100) COMMENT '分类图标',
    color VARCHAR(20) COMMENT '分类颜色',
    description TEXT COMMENT '分类描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_parent_id (parent_id),
    INDEX idx_level (level),
    INDEX idx_sort_order (sort_order),
    FOREIGN KEY (parent_id) REFERENCES food_categories(id) ON DELETE SET NULL
) COMMENT '食物分类表';

-- 食物表
CREATE TABLE foods (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '食物ID',
    name VARCHAR(100) NOT NULL COMMENT '食物名称',
    name_en VARCHAR(100) COMMENT '英文名称',
    category VARCHAR(50) NOT NULL COMMENT '食物分类',
    sub_category VARCHAR(50) COMMENT '子分类',
    brand VARCHAR(100) COMMENT '品牌',

    -- 营养成分 (每100g)
    calories_per_100g DECIMAL(8,2) NOT NULL COMMENT '每100g热量(kcal)',
    protein_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g蛋白质(g)',
    fat_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g脂肪(g)',
    carbs_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g碳水化合物(g)',
    fiber_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g纤维(g)',
    sodium_per_100g DECIMAL(8,2) DEFAULT 0 COMMENT '每100g钠(mg)',
    sugar_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g糖(g)',
    cholesterol_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g胆固醇(mg)',

    -- 其他信息
    image_url VARCHAR(255) COMMENT '食物图片URL',
    barcode VARCHAR(50) COMMENT '条形码',
    description TEXT COMMENT '食物描述',
    serving_size DECIMAL(6,2) COMMENT '建议食用量(g)',

    -- 状态信息
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    is_verified BOOLEAN DEFAULT FALSE COMMENT '是否已验证',
    created_by INT COMMENT '创建者ID',
    verified_by INT COMMENT '验证者ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_name (name),
    INDEX idx_category (category),
    INDEX idx_barcode (barcode),
    INDEX idx_calories (calories_per_100g),
    INDEX idx_created_by (created_by),
    INDEX idx_is_active (is_active),

    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (verified_by) REFERENCES users(id) ON DELETE SET NULL,

    FULLTEXT INDEX ft_name_desc (name, description)
) COMMENT '食物表';

-- 健康记录表
CREATE TABLE health_records (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '记录ID',
    user_id INT NOT NULL COMMENT '用户ID',
    record_date DATE NOT NULL COMMENT '记录日期',
    weight DECIMAL(5,2) COMMENT '体重(kg)',
    exercise_duration INT COMMENT '运动时长(分钟)',
    exercise_type VARCHAR(50) COMMENT '运动类型',
    exercise_calories DECIMAL(8,2) COMMENT '运动消耗热量(kcal)',
    sleep_hours DECIMAL(4,2) COMMENT '睡眠时长(小时)',
    sleep_quality ENUM('excellent', 'good', 'fair', 'poor') COMMENT '睡眠质量',
    mood ENUM('excellent', 'good', 'fair', 'poor') COMMENT '心情状态',
    blood_pressure_systolic INT COMMENT '收缩压',
    blood_pressure_diastolic INT COMMENT '舒张压',
    heart_rate INT COMMENT '心率',
    body_temperature DECIMAL(4,2) COMMENT '体温(℃)',
    notes TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_date (user_id, record_date),

    INDEX idx_user_date (user_id, record_date),
    INDEX idx_record_date (record_date),
    INDEX idx_weight (weight),
    INDEX idx_created_at (created_at)
) COMMENT '健康记录表';

-- 饮食记录表
CREATE TABLE diet_records (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '记录ID',
    user_id INT NOT NULL COMMENT '用户ID',
    food_id INT NOT NULL COMMENT '食物ID',
    record_date DATE NOT NULL COMMENT '记录日期',
    meal_type ENUM('breakfast', 'lunch', 'dinner', 'snack') NOT NULL COMMENT '餐次类型',
    meal_time TIME COMMENT '用餐时间',
    quantity DECIMAL(8,2) NOT NULL COMMENT '食用量(g)',

    -- 营养成分 (实际摄入)
    calories DECIMAL(8,2) NOT NULL COMMENT '热量(kcal)',
    protein DECIMAL(6,2) DEFAULT 0 COMMENT '蛋白质(g)',
    fat DECIMAL(6,2) DEFAULT 0 COMMENT '脂肪(g)',
    carbs DECIMAL(6,2) DEFAULT 0 COMMENT '碳水化合物(g)',
    fiber DECIMAL(6,2) DEFAULT 0 COMMENT '纤维(g)',
    sodium DECIMAL(8,2) DEFAULT 0 COMMENT '钠(mg)',

    notes VARCHAR(255) COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE RESTRICT,

    INDEX idx_user_date (user_id, record_date),
    INDEX idx_meal_type (meal_type),
    INDEX idx_food_id (food_id),
    INDEX idx_record_date (record_date),
    INDEX idx_calories (calories)
) COMMENT '饮食记录表';

-- 用户目标表
CREATE TABLE user_goals (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '目标ID',
    user_id INT NOT NULL COMMENT '用户ID',
    goal_type ENUM('weight', 'exercise', 'calories', 'custom') NOT NULL COMMENT '目标类型',
    goal_name VARCHAR(100) NOT NULL COMMENT '目标名称',
    target_value DECIMAL(10,2) NOT NULL COMMENT '目标值',
    current_value DECIMAL(10,2) DEFAULT 0 COMMENT '当前值',
    unit VARCHAR(20) COMMENT '单位',
    start_date DATE NOT NULL COMMENT '开始日期',
    target_date DATE COMMENT '目标日期',
    status ENUM('active', 'completed', 'paused', 'cancelled') DEFAULT 'active' COMMENT '状态',
    description TEXT COMMENT '目标描述',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    INDEX idx_user_id (user_id),
    INDEX idx_goal_type (goal_type),
    INDEX idx_status (status),
    INDEX idx_target_date (target_date)
) COMMENT '用户目标表';

-- 系统日志表
CREATE TABLE system_logs (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    user_id INT COMMENT '用户ID',
    action VARCHAR(100) NOT NULL COMMENT '操作类型',
    resource VARCHAR(100) COMMENT '操作资源',
    resource_id INT COMMENT '资源ID',
    method VARCHAR(10) COMMENT 'HTTP方法',
    url VARCHAR(500) COMMENT '请求URL',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    request_data JSON COMMENT '请求数据',
    response_status INT COMMENT '响应状态码',
    response_time INT COMMENT '响应时间(ms)',
    error_message TEXT COMMENT '错误信息',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_resource (resource),
    INDEX idx_ip_address (ip_address),
    INDEX idx_created_at (created_at),
    INDEX idx_response_status (response_status),

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) COMMENT '系统日志表';
```

## 2. 种子数据脚本

### 2.1 插入默认管理员用户
```sql
-- 插入默认管理员（密码: admin123456）
INSERT INTO users (
    username,
    password,
    nickname,
    email,
    role,
    is_active
) VALUES (
    'admin',
    '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/Ln8xqjEJ8KjDAKRBK',
    '系统管理员',
    'admin@health-system.com',
    'admin',
    TRUE
);

-- 插入测试用户（密码: 123456）
INSERT INTO users (
    username,
    password,
    nickname,
    email,
    phone,
    gender,
    height,
    target_weight,
    role,
    is_active
) VALUES (
    'testuser',
    '$2b$12$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi',
    '测试用户',
    'test@example.com',
    '13800138000',
    'male',
    175.00,
    70.00,
    'user',
    TRUE
);
```

### 2.2 插入食物分类数据
```sql
-- 一级分类
INSERT INTO food_categories (name, name_en, level, sort_order, icon, color) VALUES
('主食', 'Staple Food', 1, 1, 'rice', '#FFA726'),
('蔬菜', 'Vegetables', 1, 2, 'vegetable', '#66BB6A'),
('水果', 'Fruits', 1, 3, 'fruit', '#EF5350'),
('肉类', 'Meat', 1, 4, 'meat', '#8D6E63'),
('蛋类', 'Eggs', 1, 5, 'egg', '#FFCA28'),
('奶制品', 'Dairy Products', 1, 6, 'milk', '#42A5F5'),
('豆制品', 'Soy Products', 1, 7, 'soy', '#26A69A'),
('坚果', 'Nuts', 1, 8, 'nut', '#AB47BC'),
('饮品', 'Beverages', 1, 9, 'drink', '#29B6F6'),
('零食', 'Snacks', 1, 10, 'snack', '#FF7043');

-- 二级分类（主食类）
INSERT INTO food_categories (name, name_en, parent_id, level, sort_order) VALUES
('米饭类', 'Rice', 1, 2, 1),
('面条类', 'Noodles', 1, 2, 2),
('面包类', 'Bread', 1, 2, 3),
('粥类', 'Porridge', 1, 2, 4);

-- 二级分类（蔬菜类）
INSERT INTO food_categories (name, name_en, parent_id, level, sort_order) VALUES
('叶菜类', 'Leafy Vegetables', 2, 2, 1),
('根茎类', 'Root Vegetables', 2, 2, 2),
('瓜果类', 'Gourds', 2, 2, 3),
('菌菇类', 'Mushrooms', 2, 2, 4);
```

### 2.3 插入常用食物数据
```sql
-- 主食类
INSERT INTO foods (name, category, calories_per_100g, protein_per_100g, fat_per_100g, carbs_per_100g, is_verified) VALUES
('米饭', '主食', 116, 2.6, 0.3, 25.9, TRUE),
('白面条', '主食', 137, 4.2, 0.5, 27.4, TRUE),
('全麦面包', '主食', 247, 12.7, 4.2, 41.3, TRUE),
('白粥', '主食', 46, 1.0, 0.1, 11.2, TRUE),
('小米粥', '主食', 46, 1.5, 0.7, 8.4, TRUE);

-- 蔬菜类
INSERT INTO foods (name, category, calories_per_100g, protein_per_100g, fat_per_100g, carbs_per_100g, fiber_per_100g, is_verified) VALUES
('白菜', '蔬菜', 17, 1.5, 0.1, 3.2, 1.0, TRUE),
('菠菜', '蔬菜', 23, 2.9, 0.4, 3.6, 2.2, TRUE),
('西红柿', '蔬菜', 19, 0.9, 0.2, 4.0, 1.2, TRUE),
('黄瓜', '蔬菜', 15, 0.7, 0.1, 3.6, 0.5, TRUE),
('胡萝卜', '蔬菜', 39, 0.9, 0.2, 9.1, 2.8, TRUE);

-- 水果类
INSERT INTO foods (name, category, calories_per_100g, protein_per_100g, fat_per_100g, carbs_per_100g, fiber_per_100g, sugar_per_100g, is_verified) VALUES
('苹果', '水果', 52, 0.3, 0.2, 13.8, 2.4, 10.4, TRUE),
('香蕉', '水果', 89, 1.1, 0.3, 22.8, 2.6, 12.2, TRUE),
('橙子', '水果', 47, 0.9, 0.1, 11.8, 2.4, 9.4, TRUE),
('草莓', '水果', 32, 0.7, 0.3, 7.7, 2.0, 4.9, TRUE),
('葡萄', '水果', 69, 0.7, 0.2, 17.2, 0.9, 16.3, TRUE);

-- 肉类
INSERT INTO foods (name, category, calories_per_100g, protein_per_100g, fat_per_100g, carbs_per_100g, cholesterol_per_100g, is_verified) VALUES
('鸡胸肉', '肉类', 165, 31.0, 3.6, 0, 85, TRUE),
('猪瘦肉', '肉类', 143, 20.3, 6.2, 1.5, 81, TRUE),
('牛肉', '肉类', 250, 26.0, 15.0, 0, 90, TRUE),
('鱼肉', '肉类', 206, 22.0, 12.0, 0, 86, TRUE);

-- 蛋类
INSERT INTO foods (name, category, calories_per_100g, protein_per_100g, fat_per_100g, carbs_per_100g, cholesterol_per_100g, is_verified) VALUES
('鸡蛋', '蛋类', 147, 13.3, 8.8, 2.8, 585, TRUE),
('鸭蛋', '蛋类', 185, 12.8, 13.0, 3.1, 565, TRUE);

-- 奶制品
INSERT INTO foods (name, category, calories_per_100g, protein_per_100g, fat_per_100g, carbs_per_100g, calcium_per_100g, is_verified) VALUES
('纯牛奶', '奶制品', 54, 3.0, 3.2, 3.4, 104, TRUE),
('酸奶', '奶制品', 72, 2.5, 2.7, 9.3, 118, TRUE),
('奶酪', '奶制品', 328, 25.0, 27.0, 2.4, 799, TRUE);

-- 豆制品
INSERT INTO foods (name, category, calories_per_100g, protein_per_100g, fat_per_100g, carbs_per_100g, is_verified) VALUES
('豆腐', '豆制品', 81, 8.1, 3.7, 4.2, TRUE),
('豆浆', '豆制品', 14, 1.8, 0.7, 1.1, TRUE),
('豆腐干', '豆制品', 140, 11.3, 5.7, 11.2, TRUE);

-- 坚果类
INSERT INTO foods (name, category, calories_per_100g, protein_per_100g, fat_per_100g, carbs_per_100g, is_verified) VALUES
('花生', '坚果', 563, 26.2, 48.7, 16.1, TRUE),
('核桃', '坚果', 654, 15.2, 65.2, 13.7, TRUE),
('杏仁', '坚果', 579, 21.2, 51.4, 19.7, TRUE);
```

## 3. 数据查询脚本

### 3.1 用户数据统计
```sql
-- 查询用户总数
SELECT COUNT(*) AS total_users FROM users WHERE is_active = TRUE;

-- 查询各角色用户数量
SELECT role, COUNT(*) AS count
FROM users
WHERE is_active = TRUE
GROUP BY role;

-- 查询最近注册的用户
SELECT username, nickname, created_at
FROM users
WHERE is_active = TRUE
ORDER BY created_at DESC
LIMIT 10;

-- 查询活跃用户（最近30天有登录）
SELECT COUNT(*) AS active_users
FROM users
WHERE is_active = TRUE
AND last_login_at >= DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 3.2 健康数据统计
```sql
-- 查询用户健康记录统计
SELECT
    u.username,
    u.nickname,
    COUNT(hr.id) AS record_count,
    AVG(hr.weight) AS avg_weight,
    AVG(hr.exercise_duration) AS avg_exercise,
    AVG(hr.sleep_hours) AS avg_sleep
FROM users u
LEFT JOIN health_records hr ON u.id = hr.user_id
WHERE u.is_active = TRUE
GROUP BY u.id, u.username, u.nickname
ORDER BY record_count DESC;

-- 查询每日记录数量趋势（最近30天）
SELECT
    record_date,
    COUNT(*) AS daily_records
FROM health_records
WHERE record_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY record_date
ORDER BY record_date;

-- 查询体重变化趋势
SELECT
    hr.record_date,
    hr.weight,
    u.username
FROM health_records hr
JOIN users u ON hr.user_id = u.id
WHERE hr.weight IS NOT NULL
AND hr.record_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
ORDER BY hr.user_id, hr.record_date;
```

### 3.3 饮食数据统计
```sql
-- 查询每日热量摄入统计
SELECT
    dr.record_date,
    dr.user_id,
    u.username,
    SUM(dr.calories) AS total_calories,
    SUM(dr.protein) AS total_protein,
    SUM(dr.fat) AS total_fat,
    SUM(dr.carbs) AS total_carbs
FROM diet_records dr
JOIN users u ON dr.user_id = u.id
WHERE dr.record_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY dr.record_date, dr.user_id, u.username
ORDER BY dr.record_date DESC, total_calories DESC;

-- 查询热门食物排行
SELECT
    f.name,
    f.category,
    COUNT(dr.id) AS usage_count,
    SUM(dr.quantity) AS total_quantity
FROM diet_records dr
JOIN foods f ON dr.food_id = f.id
WHERE dr.record_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY f.id, f.name, f.category
ORDER BY usage_count DESC
LIMIT 20;

-- 查询各餐次热量分布
SELECT
    meal_type,
    AVG(calories) AS avg_calories,
    COUNT(*) AS meal_count
FROM diet_records
WHERE record_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY meal_type
ORDER BY avg_calories DESC;
```

## 4. 数据维护脚本

### 4.1 数据清理脚本
```sql
-- 清理超过1年的系统日志
DELETE FROM system_logs
WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);

-- 清理无效的健康记录（没有任何数据的记录）
DELETE FROM health_records
WHERE weight IS NULL
AND exercise_duration IS NULL
AND sleep_hours IS NULL
AND (notes IS NULL OR notes = '');

-- 清理重复的饮食记录
DELETE dr1 FROM diet_records dr1
INNER JOIN diet_records dr2
WHERE dr1.id < dr2.id
AND dr1.user_id = dr2.user_id
AND dr1.food_id = dr2.food_id
AND dr1.record_date = dr2.record_date
AND dr1.meal_type = dr2.meal_type
AND dr1.quantity = dr2.quantity;
```

### 4.2 数据更新脚本
```sql
-- 更新食物营养数据
UPDATE foods
SET is_verified = TRUE
WHERE calories_per_100g > 0
AND protein_per_100g >= 0
AND fat_per_100g >= 0
AND carbs_per_100g >= 0;

-- 批量更新用户BMI（如果需要存储BMI字段）
UPDATE users
SET bmi = ROUND(target_weight / POW(height/100, 2), 2)
WHERE height > 0 AND target_weight > 0;

-- 更新饮食记录的营养成分
UPDATE diet_records dr
JOIN foods f ON dr.food_id = f.id
SET
    dr.protein = ROUND((f.protein_per_100g * dr.quantity / 100), 2),
    dr.fat = ROUND((f.fat_per_100g * dr.quantity / 100), 2),
    dr.carbs = ROUND((f.carbs_per_100g * dr.quantity / 100), 2),
    dr.fiber = ROUND((f.fiber_per_100g * dr.quantity / 100), 2),
    dr.sodium = ROUND((f.sodium_per_100g * dr.quantity / 100), 2)
WHERE dr.protein = 0 OR dr.fat = 0 OR dr.carbs = 0;
```

## 5. 性能优化脚本

### 5.1 索引优化
```sql
-- 分析表使用情况
ANALYZE TABLE users, health_records, foods, diet_records;

-- 检查未使用的索引
SELECT
    s.TABLE_SCHEMA,
    s.TABLE_NAME,
    s.INDEX_NAME,
    s.COLUMN_NAME
FROM INFORMATION_SCHEMA.STATISTICS s
LEFT JOIN INFORMATION_SCHEMA.INDEX_STATISTICS i
ON s.TABLE_SCHEMA = i.TABLE_SCHEMA
AND s.TABLE_NAME = i.TABLE_NAME
AND s.INDEX_NAME = i.INDEX_NAME
WHERE s.TABLE_SCHEMA = 'health_management'
AND i.INDEX_NAME IS NULL
AND s.INDEX_NAME != 'PRIMARY';

-- 添加缺失的复合索引
CREATE INDEX idx_diet_user_date_meal ON diet_records(user_id, record_date, meal_type);
CREATE INDEX idx_health_user_weight ON health_records(user_id, weight);
CREATE INDEX idx_foods_category_active ON foods(category, is_active);
```

### 5.2 查询优化
```sql
-- 创建视图简化复杂查询
CREATE VIEW v_user_daily_nutrition AS
SELECT
    dr.user_id,
    dr.record_date,
    SUM(dr.calories) AS daily_calories,
    SUM(dr.protein) AS daily_protein,
    SUM(dr.fat) AS daily_fat,
    SUM(dr.carbs) AS daily_carbs,
    COUNT(DISTINCT dr.meal_type) AS meals_count
FROM diet_records dr
GROUP BY dr.user_id, dr.record_date;

-- 创建用户健康概览视图
CREATE VIEW v_user_health_overview AS
SELECT
    u.id,
    u.username,
    u.nickname,
    u.height,
    u.target_weight,
    hr.latest_weight,
    hr.latest_record_date,
    dn.avg_daily_calories
FROM users u
LEFT JOIN (
    SELECT
        user_id,
        weight AS latest_weight,
        record_date AS latest_record_date,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY record_date DESC) AS rn
    FROM health_records
    WHERE weight IS NOT NULL
) hr ON u.id = hr.user_id AND hr.rn = 1
LEFT JOIN (
    SELECT
        user_id,
        AVG(daily_calories) AS avg_daily_calories
    FROM v_user_daily_nutrition
    WHERE record_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
    GROUP BY user_id
) dn ON u.id = dn.user_id
WHERE u.is_active = TRUE;
```

## 6. 备份和恢复脚本

### 6.1 数据备份脚本
```bash
#!/bin/bash
# backup.sh - 数据库备份脚本

# 配置变量
DB_HOST="localhost"
DB_USER="root"
DB_PASSWORD="your_password"
DB_NAME="health_management"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 完整备份
echo "开始完整备份..."
mysqldump -h$DB_HOST -u$DB_USER -p$DB_PASSWORD \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    --hex-blob \
    $DB_NAME > $BACKUP_DIR/full_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/full_backup_$DATE.sql

# 结构备份（仅表结构）
mysqldump -h$DB_HOST -u$DB_USER -p$DB_PASSWORD \
    --no-data \
    --routines \
    --triggers \
    --events \
    $DB_NAME > $BACKUP_DIR/schema_backup_$DATE.sql

gzip $BACKUP_DIR/schema_backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "备份完成: $BACKUP_DIR/full_backup_$DATE.sql.gz"
```

### 6.2 数据恢复脚本
```bash
#!/bin/bash
# restore.sh - 数据库恢复脚本

# 参数检查
if [ $# -ne 1 ]; then
    echo "使用方法: $0 <backup_file>"
    exit 1
fi

BACKUP_FILE=$1
DB_HOST="localhost"
DB_USER="root"
DB_PASSWORD="your_password"
DB_NAME="health_management"

# 检查备份文件是否存在
if [ ! -f "$BACKUP_FILE" ]; then
    echo "错误: 备份文件不存在: $BACKUP_FILE"
    exit 1
fi

# 确认恢复操作
echo "警告: 此操作将覆盖现有数据库 $DB_NAME"
read -p "确认继续? (y/N): " confirm
if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "操作已取消"
    exit 1
fi

# 解压文件（如果是压缩文件）
if [[ "$BACKUP_FILE" == *.gz ]]; then
    echo "解压备份文件..."
    gunzip -k "$BACKUP_FILE"
    BACKUP_FILE="${BACKUP_FILE%.gz}"
fi

# 恢复数据库
echo "开始恢复数据库..."
mysql -h$DB_HOST -u$DB_USER -p$DB_PASSWORD $DB_NAME < "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo "数据库恢复成功"
else
    echo "数据库恢复失败"
    exit 1
fi
```

这份数据库脚本集合提供了健康管理系统数据库的完整操作脚本，包括初始化、种子数据、查询分析、维护清理、性能优化和备份恢复等各个方面的实用脚本。