# 健康管理系统数据库设计文档

## 1. 数据库概述

### 1.1 数据库基本信息
- **数据库名称**: health_management
- **数据库引擎**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **时区**: UTC

### 1.2 设计原则
- 遵循第三范式，减少数据冗余
- 合理使用索引提升查询性能
- 考虑数据完整性约束
- 支持软删除和数据审计
- 预留扩展字段

## 2. 数据库表结构设计

### 2.1 用户表 (users)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(255) NOT NULL COMMENT '密码(bcrypt加密)',
    nickname VARCHAR(50) COMMENT '昵称',
    phone VARCHAR(20) COMMENT '手机号',
    email VARCHAR(100) COMMENT '邮箱',
    gender ENUM('male', 'female') COMMENT '性别',
    birth_date DATE COMMENT '出生日期',
    height DECIMAL(5,2) COMMENT '身高(cm)',
    target_weight DECIMAL(5,2) COMMENT '目标体重(kg)',
    avatar VARCHAR(255) COMMENT '头像URL',
    role ENUM('user', 'admin') DEFAULT 'user' COMMENT '用户角色',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否激活',
    last_login_at TIMESTAMP NULL COMMENT '最后登录时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_created_at (created_at)
) COMMENT '用户表';
```

**字段说明:**
- `id`: 主键，自增
- `username`: 用户名，唯一，3-50字符
- `password`: bcrypt加密后的密码
- `height`: 身高，单位cm，支持小数
- `target_weight`: 目标体重，单位kg
- `role`: 用户角色，普通用户或管理员
- `is_active`: 软删除标志

### 2.2 健康记录表 (health_records)
```sql
CREATE TABLE health_records (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '记录ID',
    user_id INT NOT NULL COMMENT '用户ID',
    record_date DATE NOT NULL COMMENT '记录日期',
    weight DECIMAL(5,2) COMMENT '体重(kg)',
    exercise_duration INT COMMENT '运动时长(分钟)',
    exercise_type VARCHAR(50) COMMENT '运动类型',
    sleep_hours DECIMAL(4,2) COMMENT '睡眠时长(小时)',
    sleep_quality ENUM('excellent', 'good', 'fair', 'poor') COMMENT '睡眠质量',
    mood ENUM('excellent', 'good', 'fair', 'poor') COMMENT '心情状态',
    notes TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键约束
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    -- 唯一约束：每个用户每天只能有一条记录
    UNIQUE KEY unique_user_date (user_id, record_date),

    -- 索引
    INDEX idx_user_date (user_id, record_date),
    INDEX idx_record_date (record_date),
    INDEX idx_weight (weight),
    INDEX idx_created_at (created_at)
) COMMENT '健康记录表';
```

**字段说明:**
- `record_date`: 记录日期，每个用户每天只能有一条记录
- `weight`: 体重，精确到两位小数
- `exercise_duration`: 运动时长，单位分钟
- `exercise_type`: 运动类型，如跑步、游泳等
- `sleep_hours`: 睡眠时长，支持小数
- `sleep_quality`: 睡眠质量枚举值（excellent-优秀, good-良好, fair-一般, poor-较差）
- `mood`: 心情状态枚举值（excellent-优秀, good-良好, fair-一般, poor-较差）
- `notes`: 备注信息

### 2.3 食物表 (foods)
```sql
CREATE TABLE foods (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '食物ID',
    name VARCHAR(100) NOT NULL COMMENT '食物名称',
    name_en VARCHAR(100) COMMENT '英文名称',
    category VARCHAR(50) NOT NULL COMMENT '食物分类',
    sub_category VARCHAR(50) COMMENT '子分类',
    brand VARCHAR(100) COMMENT '品牌',

    -- 营养成分 (每100g)
    calories_per_100g DECIMAL(8,2) NOT NULL COMMENT '每100g热量(kcal)',
    protein_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g蛋白质(g)',
    fat_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g脂肪(g)',
    carbs_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g碳水化合物(g)',
    fiber_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g纤维(g)',
    sodium_per_100g DECIMAL(8,2) DEFAULT 0 COMMENT '每100g钠(mg)',
    sugar_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g糖(g)',
    cholesterol_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g胆固醇(mg)',
    vitamin_c_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g维生素C(mg)',
    calcium_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g钙(mg)',
    iron_per_100g DECIMAL(6,2) DEFAULT 0 COMMENT '每100g铁(mg)',

    -- 其他信息
    image_url VARCHAR(255) COMMENT '食物图片URL',
    barcode VARCHAR(50) COMMENT '条形码',
    description TEXT COMMENT '食物描述',
    serving_size DECIMAL(6,2) COMMENT '建议食用量(g)',

    -- 状态信息
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    is_verified BOOLEAN DEFAULT FALSE COMMENT '是否已验证',
    created_by INT COMMENT '创建者ID',
    verified_by INT COMMENT '验证者ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_name (name),
    INDEX idx_category (category),
    INDEX idx_barcode (barcode),
    INDEX idx_calories (calories_per_100g),
    INDEX idx_created_by (created_by),
    INDEX idx_is_active (is_active),

    -- 外键约束
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (verified_by) REFERENCES users(id) ON DELETE SET NULL,

    -- 全文索引
    FULLTEXT INDEX ft_name_desc (name, description)
) COMMENT '食物表';
```

**字段说明:**
- `category`: 主分类，如主食、蔬菜、水果、肉类等
- `sub_category`: 子分类，更细化的分类
- `calories_per_100g`: 每100g热量，必填字段
- `is_verified`: 数据是否经过验证
- `serving_size`: 建议单次食用量

### 2.4 饮食记录表 (diet_records)
```sql
CREATE TABLE diet_records (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '记录ID',
    user_id INT NOT NULL COMMENT '用户ID',
    food_id INT NOT NULL COMMENT '食物ID',
    record_date DATE NOT NULL COMMENT '记录日期',
    meal_type ENUM('breakfast', 'lunch', 'dinner', 'snack') NOT NULL COMMENT '餐次类型',
    meal_time TIME COMMENT '用餐时间',
    quantity DECIMAL(8,2) NOT NULL COMMENT '食用量(g)',

    -- 营养成分 (实际摄入)
    calories DECIMAL(8,2) NOT NULL COMMENT '热量(kcal)',
    protein DECIMAL(6,2) DEFAULT 0 COMMENT '蛋白质(g)',
    fat DECIMAL(6,2) DEFAULT 0 COMMENT '脂肪(g)',
    carbs DECIMAL(6,2) DEFAULT 0 COMMENT '碳水化合物(g)',
    fiber DECIMAL(6,2) DEFAULT 0 COMMENT '纤维(g)',
    sodium DECIMAL(8,2) DEFAULT 0 COMMENT '钠(mg)',

    -- 其他信息
    notes VARCHAR(255) COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键约束
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE RESTRICT,

    -- 索引
    INDEX idx_user_date (user_id, record_date),
    INDEX idx_meal_type (meal_type),
    INDEX idx_food_id (food_id),
    INDEX idx_record_date (record_date),
    INDEX idx_calories (calories)
) COMMENT '饮食记录表';
```

**字段说明:**
- `meal_type`: 餐次类型，早餐/午餐/晚餐/加餐
- `meal_time`: 具体用餐时间
- `quantity`: 实际食用量，单位克
- `calories`: 根据食用量计算的实际热量

### 2.5 食物分类表 (food_categories)
```sql
CREATE TABLE food_categories (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
    name VARCHAR(50) NOT NULL COMMENT '分类名称',
    name_en VARCHAR(50) COMMENT '英文名称',
    parent_id INT COMMENT '父分类ID',
    level TINYINT DEFAULT 1 COMMENT '分类层级',
    sort_order INT DEFAULT 0 COMMENT '排序顺序',
    icon VARCHAR(100) COMMENT '分类图标',
    color VARCHAR(20) COMMENT '分类颜色',
    description TEXT COMMENT '分类描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_parent_id (parent_id),
    INDEX idx_level (level),
    INDEX idx_sort_order (sort_order),

    -- 外键约束
    FOREIGN KEY (parent_id) REFERENCES food_categories(id) ON DELETE SET NULL
) COMMENT '食物分类表';
```

### 2.6 用户目标表 (user_goals)
```sql
CREATE TABLE user_goals (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '目标ID',
    user_id INT NOT NULL COMMENT '用户ID',
    goal_type ENUM('weight', 'exercise', 'calories', 'custom') NOT NULL COMMENT '目标类型',
    goal_name VARCHAR(100) NOT NULL COMMENT '目标名称',
    target_value DECIMAL(10,2) NOT NULL COMMENT '目标值',
    current_value DECIMAL(10,2) DEFAULT 0 COMMENT '当前值',
    unit VARCHAR(20) COMMENT '单位',
    start_date DATE NOT NULL COMMENT '开始日期',
    target_date DATE COMMENT '目标日期',
    status ENUM('active', 'completed', 'paused', 'cancelled') DEFAULT 'active' COMMENT '状态',
    description TEXT COMMENT '目标描述',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键约束
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_goal_type (goal_type),
    INDEX idx_status (status),
    INDEX idx_target_date (target_date)
) COMMENT '用户目标表';
```

### 2.7 系统日志表 (system_logs)
```sql
CREATE TABLE system_logs (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    user_id INT COMMENT '用户ID',
    action VARCHAR(100) NOT NULL COMMENT '操作类型',
    resource VARCHAR(100) COMMENT '操作资源',
    resource_id INT COMMENT '资源ID',
    method VARCHAR(10) COMMENT 'HTTP方法',
    url VARCHAR(500) COMMENT '请求URL',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    request_data JSON COMMENT '请求数据',
    response_status INT COMMENT '响应状态码',
    response_time INT COMMENT '响应时间(ms)',
    error_message TEXT COMMENT '错误信息',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_resource (resource),
    INDEX idx_ip_address (ip_address),
    INDEX idx_created_at (created_at),
    INDEX idx_response_status (response_status),

    -- 外键约束
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) COMMENT '系统日志表';
```

## 3. 数据库索引策略

### 3.1 主要索引
```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 健康记录表索引
CREATE INDEX idx_health_user_date ON health_records(user_id, record_date);
CREATE INDEX idx_health_date ON health_records(record_date);
CREATE INDEX idx_health_weight ON health_records(weight);

-- 食物表索引
CREATE INDEX idx_foods_name ON foods(name);
CREATE INDEX idx_foods_category ON foods(category);
CREATE INDEX idx_foods_calories ON foods(calories_per_100g);
CREATE FULLTEXT INDEX ft_foods_search ON foods(name, description);

-- 饮食记录表索引
CREATE INDEX idx_diet_user_date ON diet_records(user_id, record_date);
CREATE INDEX idx_diet_meal_type ON diet_records(meal_type);
CREATE INDEX idx_diet_calories ON diet_records(calories);

-- 复合索引
CREATE INDEX idx_health_user_date_weight ON health_records(user_id, record_date, weight);
CREATE INDEX idx_diet_user_date_meal ON diet_records(user_id, record_date, meal_type);
```

### 3.2 性能优化建议
1. **分区策略**: 按日期分区健康记录和饮食记录表
2. **归档策略**: 定期归档历史日志数据
3. **缓存策略**: 热点数据使用Redis缓存
4. **读写分离**: 主从复制，读写分离

## 4. 数据字典

### 4.1 枚举值定义
```sql
-- 性别
ENUM('male', 'female') -- 男性, 女性

-- 用户角色
ENUM('user', 'admin') -- 普通用户, 管理员

-- 餐次类型
ENUM('breakfast', 'lunch', 'dinner', 'snack') -- 早餐, 午餐, 晚餐, 加餐

-- 睡眠质量
ENUM('excellent', 'good', 'fair', 'poor') -- 优秀, 良好, 一般, 较差

-- 心情状态
ENUM('excellent', 'good', 'fair', 'poor') -- 优秀, 良好, 一般, 较差

-- 目标状态
ENUM('active', 'completed', 'paused', 'cancelled') -- 进行中, 已完成, 已暂停, 已取消
```

### 4.2 常用食物分类
```sql
INSERT INTO food_categories (name, name_en, level, sort_order) VALUES
('主食', 'Staple Food', 1, 1),
('蔬菜', 'Vegetables', 1, 2),
('水果', 'Fruits', 1, 3),
('肉类', 'Meat', 1, 4),
('蛋类', 'Eggs', 1, 5),
('奶制品', 'Dairy Products', 1, 6),
('豆制品', 'Soy Products', 1, 7),
('坚果', 'Nuts', 1, 8),
('饮品', 'Beverages', 1, 9),
('零食', 'Snacks', 1, 10);
```

## 5. 数据安全策略

### 5.1 数据加密
- 用户密码使用bcrypt加密
- 敏感字段如手机号、邮箱可考虑AES加密
- 数据传输使用HTTPS

### 5.2 备份策略
```bash
# 每日备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="health_management"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
mysqldump -u$DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/health_management_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/health_management_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

### 5.3 权限控制
```sql
-- 创建应用用户
CREATE USER 'health_app'@'%' IDENTIFIED BY 'strong_password';

-- 授权
GRANT SELECT, INSERT, UPDATE, DELETE ON health_management.* TO 'health_app'@'%';
GRANT EXECUTE ON health_management.* TO 'health_app'@'%';

-- 只读用户（用于报表查询）
CREATE USER 'health_readonly'@'%' IDENTIFIED BY 'readonly_password';
GRANT SELECT ON health_management.* TO 'health_readonly'@'%';
```

## 6. 数据库监控

### 6.1 性能监控指标
- 连接数监控
- 慢查询监控
- 磁盘空间监控
- 缓存命中率监控

### 6.2 监控SQL示例
```sql
-- 查看当前连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看慢查询
SHOW STATUS LIKE 'Slow_queries';

-- 查看缓存命中率
SHOW STATUS LIKE 'Qcache_hits';
SHOW STATUS LIKE 'Qcache_inserts';

-- 查看表大小
SELECT
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'DB Size MB'
FROM information_schema.tables
WHERE table_schema = 'health_management'
ORDER BY (data_length + index_length) DESC;
```

这份数据库设计文档提供了健康管理系统完整的数据库结构设计，包含了表结构、索引策略、安全措施和监控方案。