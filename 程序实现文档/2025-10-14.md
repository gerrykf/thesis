# 后台需求

## 服务端

- ✅ 更新用户信息接口报错

```
API请求: PUT /api/admin/users/63
Admin路由收到请求: PUT /api/admin/users/63 -> /users/63
更新用户信息错误: Error: Incorrect date value: '2020-01-31T17:00:00.000Z' for column 'birth_date' at row 1
    at PromisePool.execute (/Users/gerry/LearnSpace/thesis/程序实现文档/backend/health-backend/node_modules/.pnpm/mysql2@3.15.1/node_modules/mysql2/lib/promise/pool.js:54:22)
    at updateUserById (/Users/gerry/LearnSpace/thesis/程序实现文档/backend/health-backend/src/controllers/adminController.ts:714:14)
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  code: 'ER_TRUNCATED_WRONG_VALUE',
  errno: 1292,
  sql: 'UPDATE users SET nickname = ?, email = ?, phone = ?, gender = ?, birth_date = ?, height = ?, target_weight = ? WHERE id = ?',
  sqlState: '22007',
  sqlMessage: "Incorrect date value: '2020-01-31T17:00:00.000Z' for column 'birth_date' at row 1"
}
PUT /api/admin/users/63 500 31.361 ms - 51
[2025-10-14T03:06:03.104Z] PUT /api/admin/users/63 500 - 31ms
```

- ✅ 删除用户接口报错

```
Admin路由收到请求: DELETE /api/admin/users/63 -> /users/63
删除用户错误: Error: This command is not supported in the prepared statement protocol yet
    at PromisePool.execute (/Users/gerry/LearnSpace/thesis/程序实现文档/backend/health-backend/node_modules/.pnpm/mysql2@3.15.1/node_modules/mysql2/lib/promise/pool.js:54:22)
    at deleteUser (/Users/gerry/LearnSpace/thesis/程序实现文档/backend/health-backend/src/controllers/adminController.ts:803:14)
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  code: 'ER_UNSUPPORTED_PS',
  errno: 1295,
  sql: 'START TRANSACTION',
  sqlState: 'HY000',
  sqlMessage: 'This command is not supported in the prepared statement protocol yet'
}
DELETE /api/admin/users/63 500 9.243 ms - 130
[2025-10-14T03:10:06.690Z] DELETE /api/admin/users/63 500 - 10ms
```

- ✅ 获取 ById 用户的健康记录接口报错

```
Admin路由收到请求: GET /api/admin/users/63/health-records?page=1&pageSize=10 -> /users/63/health-records
获取用户健康记录错误: Error: Incorrect arguments to mysqld_stmt_execute
    at PromisePool.execute (/Users/gerry/LearnSpace/thesis/程序实现文档/backend/health-backend/node_modules/.pnpm/mysql2@3.15.1/node_modules/mysql2/lib/promise/pool.js:54:22)
    at getUserHealthRecords (/Users/gerry/LearnSpace/thesis/程序实现文档/backend/health-backend/src/controllers/adminController.ts:1016:32)
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  code: 'ER_WRONG_ARGUMENTS',
  errno: 1210,
  sql: 'SELECT * FROM health_records WHERE user_id = ? ORDER BY record_date DESC LIMIT ? OFFSET ?',
  sqlState: 'HY000',
  sqlMessage: 'Incorrect arguments to mysqld_stmt_execute'
}
GET /api/admin/users/63/health-records?page=1&pageSize=10 500 21.127 ms - 51
[2025-10-14T03:10:56.161Z] GET /api/admin/users/63/health-records?page=1&pageSize=10 500 - 21ms
```

## 后台管理端

现在分成 用户列表 和 食物列表 两个模块

### 当前

### 用户列表

现在已经开发完成 用户列表 信息读取 解决我上面的接口报错问题

#### 用户详情

- 健康数据统计部分

1. ⏳ 点击 健康记录 完成显示该用户的完整健康打卡记录
2. ⏳ 点击 饮食记录 完成显示该用户的完整饮食打卡记录
3. ⏳ 点击 活跃目标 完成显示该用户的完整目标记录
4. ⏳ 点击 活跃天数 显示打卡天数

**注意**: 后端已添加 Swagger 文档,需要重新生成前端 API 函数
5. ✅ 程序实现文档/frontend/health-manage/src/views/user-management/list/index.vue

```
:total="pagination.total"
```

这里总条数显示的 0 但是我接口返回的确实是正确的总条数 但是分页器没有正确显示

6. ✅ 用户列表查询条件这里 http://localhost:8848/api/admin/users?page=1&pageSize=20&is_active=false
   根据用户状态查询 false 也没有正确显示
7. ✅ 根据用户名查询 数据显示的全部数据 昵称同样 需要调试 这里查询条件

### 食物列表

- ⏳ 食物列表信息读取
- ⏳ 食物信息的新增
- ⏳ 食物信息的修改
- ⏳ 食物信息的删除

## 完成情况总结

### ✅ 已完成
1. 修复服务端更新用户信息日期格式错误
2. 修复服务端删除用户事务错误
3. 修复服务端获取用户健康记录参数错误
4. 修复前端分页器总条数显示问题
5. 修复前端用户状态筛选功能
6. 修复前端用户名和昵称搜索功能
7. 为后端 API 添加 Swagger 文档:
   - `/api/admin/stats/users` - 获取用户统计
   - `/api/admin/users/{id}/health-stats` - 获取用户健康统计
   - `/api/admin/users/{id}/health-records` - 获取用户健康记录
8. 为 User schema 添加 is_active 字段
9. 重新生成前端 API 函数
10. 更新 hooks.ts 使用自动生成的 API 函数:
    - 使用 `getAdminUsers` 替代手动创建的 `getUserList`
    - 使用 `getAdminStatsUsers` 替代 `getUserStats`
    - 使用 `getAdminUsersId` 替代 `getUserDetail`
    - 使用 `getAdminUsersIdHealthStats` 替代 `getUserHealthStats`
    - 使用 `getAdminUsersIdHealthRecords` 替代 `getUserHealthRecords`
    - 使用 `patchAdminUsersIdToggleStatus` 替代 `updateUserStatus`
11. 创建类型安全的 `unwrap` 工具函数 (`src/utils/api.ts`):
    - 解决响应拦截器解包导致的 TypeScript 类型错误
    - 提供类型安全的 API 响应处理
    - 避免使用 `as any` 类型断言
12. 更新 detail/index.vue 使用自动生成的 API 函数:
    - 所有 API 调用改为使用 `@/api/admin` 中的函数
    - 使用 `unwrap` 函数确保类型安全
13. 修复所有 TypeScript 编译错误 (0 diagnostics)
14. 修复用户列表日期筛选功能:
    - 修复最后登录时间筛选（处理 `last_login_at` 为 NULL 的情况）
    - 添加查询条件调试日志
15. 实现用户详情页面健康统计卡片点击功能:
    - ✅ 健康记录卡片点击显示完整健康记录列表（带分页）
    - ✅ 饮食记录卡片点击显示对话框（占位符，等待后端 API）
    - ✅ 活跃目标卡片点击显示对话框（占位符，等待后端 API）
    - ✅ 活跃天数卡片点击显示统计数据（占位符，等待后端 API）
    - ✅ 添加卡片悬停效果和点击样式
16. 修复健康记录接口错误:
    - 问题: `GET /api/admin/users/{id}/health-records` 返回 500 错误
    - 原因: MySQL prepared statements 不支持在 LIMIT/OFFSET 中使用占位符 `?`
    - 解决: 将 `LIMIT ? OFFSET ?` 改为直接插值 `LIMIT ${pageSize} OFFSET ${offset}`
    - 位置: `adminController.ts:1220`
17. 实现食物管理模块:
    - ✅ 创建食物管理目录结构 (`src/views/food-management/`)
    - ✅ 创建食物管理 hooks (`utils/hooks.ts`):
      - `useFoodList`: 食物列表管理
      - `useFoodCategories`: 食物分类管理
      - `useFoodActions`: 食物操作(删除)
    - ✅ 创建食物列表页面 (`list/index.vue`):
      - 食物列表展示(ID、名称、分类、品牌、营养成分、状态)
      - 搜索功能(名称、分类筛选)
      - 分页功能
      - 新增食物对话框(包含所有字段和营养成分)
      - 编辑食物对话框
      - 删除食物功能
      - 表单验证
    - ✅ 添加食物管理路由 (`router/modules/food-management.ts`)
    - 使用自动生成的 API 函数 (`@/api/food.ts`):
      - `getFoods`: 获取食物列表
      - `postFoods`: 创建食物
      - `putFoodsId`: 更新食物
      - `deleteFoodsId`: 删除食物
      - `getFoodsCategories`: 获取分类列表

### ⏳ 待完成
1. 后端 API 开发:
   - 用户饮食记录查询接口 (GET /api/admin/users/{id}/diet-records)
   - 用户活跃目标查询接口 (GET /api/admin/users/{id}/goals)
   - 用户活跃天数详情接口 (GET /api/admin/users/{id}/active-days)

## 技术说明

### API 调用方式更新
前端已从手动创建的 API 函数迁移到使用 openapi2ts 自动生成的函数。

**类型安全解决方案**：
由于响应拦截器已经解包了 AxiosResponse（`return data`），但 TypeScript 类型定义还认为返回 `AxiosResponse<T>`，我们创建了 `unwrap` 工具函数来解决这个类型不匹配问题。

```typescript
// src/utils/api.ts
export function unwrap<T>(promise: Promise<T>): Promise<UnwrapAxiosResponse<Awaited<T>>> {
  return promise as Promise<UnwrapAxiosResponse<Awaited<T>>>;
}

// 使用示例
const response = await unwrap(getAdminUsers(params));
if (response?.success && response.data) {
  // TypeScript 完全理解 response 的类型
}
```

**优势**：
- ✅ 类型安全，无需使用 `as any`
- ✅ 符合实际运行时行为
- ✅ 可在所有页面复用
- ✅ 有完整的 JSDoc 文档说明

### 搜索参数处理
由于后端 Swagger 中使用的是统一的 `search` 参数（用于搜索用户名或昵称），前端在调用时会将 `username` 或 `nickname` 映射到 `search` 参数。


## bug 前后端联调

1. 卡路里接口500
请求网址
http://localhost:8848/api/foods/categories
请求方法
GET
状态代码
500 Internal Server Error
远程地址
127.0.0.1:8848
引荐来源网址政策
strict-origin-when-cross-origin

2. 食物列表接口500 
请求网址
http://localhost:8848/api/foods?page=1&limit=20
请求方法
GET
状态代码
500 Internal Server Error
远程地址
127.0.0.1:8848
引荐来源网址政策
strict-origin-when-cross-origin