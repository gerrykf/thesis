# 权限树静态路由功能测试文档

## 测试日期
2025-10-18

## 测试目标
验证权限树能够正确显示静态路由和动态菜单，并且用户登录时只获取动态菜单。

---

## 一、环境准备

### 1.1 启动后端服务

```bash
cd /Users/gerry/LearnSpace/thesis/程序实现文档/backend/health-backend
pnpm run dev
```

**预期结果：**
- ✅ 服务启动在 http://localhost:3000
- ✅ 数据库连接成功
- ✅ 没有报错信息

### 1.2 启动前端服务

```bash
cd /Users/gerry/LearnSpace/thesis/程序实现文档/frontend/health-manage
pnpm run dev
```

**预期结果：**
- ✅ 前端启动在 http://localhost:5173
- ✅ 编译成功，没有TS错误
- ✅ 可以正常访问登录页

---

## 二、数据验证

### 2.1 验证数据库静态路由数据

```bash
mysql -u root -p000000 health_management
```

执行查询：

```sql
-- 查看静态路由统计
SELECT
  CASE menu_type
    WHEN 0 THEN '目录'
    WHEN 1 THEN '菜单'
    WHEN 2 THEN '按钮'
  END AS menu_type_name,
  COUNT(*) as count
FROM menus
WHERE is_static = 1 AND router_source = 'local'
GROUP BY menu_type;

-- 查看所有静态路由
SELECT id, parent_id, menu_type, title, name, path, auths, is_static, router_source
FROM menus
WHERE is_static = 1 AND router_source = 'local'
ORDER BY `rank` ASC, id ASC;

-- 查看动态菜单
SELECT id, parent_id, menu_type, title, name, path, is_static, router_source
FROM menus
WHERE is_static = 0
ORDER BY `rank` ASC;
```

**预期结果：**
- ✅ 静态路由数量：目录8条、菜单11条、按钮18条
- ✅ 动态菜单数量：7条（系统监控、角色管理等）
- ✅ 所有静态路由的 `is_static=1` 且 `router_source='local'`
- ✅ 所有动态菜单的 `is_static=0` 且 `router_source='database'`

---

## 三、功能测试

### 3.1 测试1：超级管理员查看权限树

**测试步骤：**

1. 使用超级管理员账号登录
   - 用户名：`sadmin`
   - 密码：`sadmin666`

2. 导航到 **系统管理 -> 角色管理**

3. 点击任意角色的"权限"按钮

4. 观察权限树显示

**预期结果：**
- ✅ 权限树加载成功，显示所有菜单
- ✅ 看到蓝色"静态"标签标识的节点
- ✅ 看到绿色"目录"标签
- ✅ 看到黄色"按钮"标签
- ✅ 看到灰色"(本地)"文本标识
- ✅ 控制台输出：`menu data (包含静态路由):`
- ✅ 树节点总数应该 > 40（包含静态+动态）

**示例截图位置：**
```
首页 [静态] [目录] (本地)
  └─ 数据趋势 [静态] (本地)

用户管理 [静态] [目录] (本地)
  ├─ 用户管理 [静态] (本地)
  │   ├─ 查看 [静态] [按钮] (本地)
  │   ├─ 新增 [静态] [按钮] (本地)
  │   ├─ 编辑 [静态] [按钮] (本地)
  │   ├─ 删除 [静态] [按钮] (本地)
  │   └─ 修改角色 [静态] [按钮] (本地)
  └─ 用户详情 [静态] (本地)

食物管理 [静态] [目录] (本地)
  └─ 食物管理 [静态] (本地)
      ├─ 查看 [静态] [按钮] (本地)
      ├─ 新增 [静态] [按钮] (本地)
      ├─ 编辑 [静态] [按钮] (本地)
      └─ 删除 [静态] [按钮] (本地)

系统监控 [目录]
  ├─ 在线用户 (无标签，动态菜单)
  ├─ 登录日志 (无标签，动态菜单)
  └─ 操作日志 (无标签，动态菜单)
```

---

### 3.2 测试2：验证API返回数据

**测试步骤：**

1. 打开浏览器开发者工具 -> Network 标签

2. 在角色管理页面点击"权限"按钮

3. 查看网络请求

**预期结果：**
- ✅ 看到请求：`GET /api/admin/menus?include_static=true`
- ✅ 响应包含 `is_static: 1` 的节点（静态路由）
- ✅ 响应包含 `is_static: 0` 的节点（动态菜单）
- ✅ 响应包含 `router_source: 'local'` 和 `router_source: 'database'`

**验证方法（curl）：**

```bash
# 获取超级管理员token
TOKEN="你的登录token"

# 测试1：获取所有菜单（包括静态路由）
curl -s "http://localhost:3000/api/admin/menus?include_static=true" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Client-Type: admin" | jq '.data[] | {title, is_static, router_source}'

# 预期：看到 is_static=1 的数据

# 测试2：获取动态菜单（排除静态路由）
curl -s "http://localhost:3000/api/admin/menus" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Client-Type: admin" | jq '.data[] | {title, is_static, router_source}'

# 预期：所有数据 is_static=0 或 null
```

---

### 3.3 测试3：角色权限分配

**测试步骤：**

1. 在角色管理页面，选择"普通用户"角色

2. 点击"权限"按钮

3. 勾选一些静态路由权限（如"首页 -> 数据趋势"）

4. 点击保存

5. 查看数据库 `role_menus` 表

```sql
-- 查看普通用户角色的权限
SELECT rm.role_id, rm.menu_id, m.title, m.is_static, m.router_source
FROM role_menus rm
LEFT JOIN menus m ON rm.menu_id = m.id
WHERE rm.role_id = 1
ORDER BY m.`rank`;
```

**预期结果：**
- ✅ 保存成功提示
- ✅ 数据库中看到新增的权限记录
- ✅ 包含静态路由的 menu_id
- ✅ 刷新权限树，勾选状态正确保留

---

### 3.4 测试4：用户登录获取菜单（动态路由）

**测试步骤：**

1. 退出当前登录

2. 使用普通用户登录（如果没有，先创建一个）
   - 用户名：`test01`
   - 密码：根据实际

3. 登录后查看侧边栏菜单

4. 打开开发者工具 -> Network

5. 查找 `/api/get-async-routes` 或 `/api/admin/menus` 请求

**预期结果：**
- ✅ 侧边栏只显示从数据库获取的动态菜单
- ✅ 静态路由（首页、用户管理、食物管理）由本地 `router/modules/` 文件定义
- ✅ API 请求 **不包含** `include_static` 参数（或为false）
- ✅ 响应数据中所有菜单的 `is_static=0`

**验证方法（curl）：**

```bash
# 使用普通用户token
TOKEN="普通用户登录后的token"

# 获取异步路由
curl -s "http://localhost:3000/api/get-async-routes" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Client-Type: admin" | jq '.'

# 预期：返回的路由都是动态的，不包含静态路由
```

---

### 3.5 测试5：搜索过滤功能

**测试步骤：**

1. 在权限树页面，输入搜索关键词"静态"

2. 输入搜索关键词"用户"

3. 清空搜索

**预期结果：**
- ✅ 搜索"静态"时，无结果（因为搜索的是title，不是标签）
- ✅ 搜索"用户"时，显示所有包含"用户"的菜单（静态+动态）
- ✅ 清空搜索后恢复所有节点

---

### 3.6 测试6：展开/折叠和全选功能

**测试步骤：**

1. 点击"展开/折叠"复选框

2. 点击"全选"复选框

3. 取消全选

**预期结果：**
- ✅ 展开时所有节点展开，折叠时所有节点折叠
- ✅ 全选时所有节点被勾选（包括静态路由）
- ✅ 取消全选时所有节点取消勾选
- ✅ 部分勾选时，全选复选框显示为半选状态

---

## 四、边界情况测试

### 4.1 测试：新角色默认权限

**测试步骤：**

1. 创建一个新角色（如"测试角色"）

2. 查看该角色的权限树

**预期结果：**
- ✅ 默认无任何勾选
- ✅ 显示所有可选菜单（静态+动态）

---

### 4.2 测试：禁用的菜单不显示

**测试步骤：**

1. 在数据库中禁用一个静态路由

```sql
UPDATE menus SET status = 0 WHERE id = 35 LIMIT 1;
```

2. 刷新权限树

**预期结果：**
- ✅ 被禁用的菜单不显示在权限树中

3. 恢复状态

```sql
UPDATE menus SET status = 1 WHERE id = 35 LIMIT 1;
```

---

### 4.3 测试：大量数据性能

**测试步骤：**

1. 插入更多测试数据（可选）

2. 打开权限树

3. 观察加载速度和流畅度

**预期结果：**
- ✅ 加载时间 < 2秒
- ✅ 展开/折叠流畅
- ✅ 勾选响应及时

---

## 五、数据一致性验证

### 5.1 验证静态路由权限保存

```sql
-- 查看所有角色对静态路由的权限分配
SELECT
  r.name AS role_name,
  m.title AS menu_title,
  m.is_static,
  m.router_source
FROM role_menus rm
LEFT JOIN roles r ON rm.role_id = r.id
LEFT JOIN menus m ON rm.menu_id = m.id
WHERE m.is_static = 1
ORDER BY r.id, m.`rank`;
```

**预期结果：**
- ✅ 超级管理员拥有所有静态路由权限
- ✅ 管理员拥有大部分静态路由权限（不含按钮）
- ✅ 普通用户拥有基础查看权限

---

### 5.2 验证动态路由不受影响

```sql
-- 查看动态菜单数据
SELECT id, title, path, is_static, router_source
FROM menus
WHERE is_static = 0 OR is_static IS NULL
ORDER BY `rank`;
```

**预期结果：**
- ✅ 原有的7条动态菜单数据完整
- ✅ 系统监控、角色管理等功能正常

---

## 六、回归测试

### 6.1 原有功能验证

**测试项目：**
1. ✅ 菜单管理页面正常
2. ✅ 角色管理列表正常
3. ✅ 用户管理功能正常
4. ✅ 权限分配保存成功
5. ✅ 用户登录后菜单正确显示

---

## 七、问题排查

### 常见问题1：权限树不显示静态路由

**原因：** API调用缺少 `include_static=true` 参数

**解决：** 检查 `hooks.tsx:471` 是否正确添加参数

```typescript
const { data } = await getAdminMenus({ include_static: 'true' } as any);
```

---

### 常见问题2：标签不显示

**原因：** 数据字段不匹配

**解决：** 检查 `index.vue:388-414` 模板代码

```vue
<el-tag v-if="data.is_static === 1" size="small" type="info">
  静态
</el-tag>
```

---

### 常见问题3：用户登录后看到静态路由

**原因：** 后端API未正确排除

**解决：** 检查 `adminController.ts:2959` 是否添加过滤条件

```typescript
const staticCondition = includeStatic ? '' : 'AND is_static = 0';
```

---

## 八、测试检查清单

- [ ] 后端服务启动成功
- [ ] 前端服务启动成功
- [ ] 数据库静态路由数据正确
- [ ] 权限树显示所有菜单（静态+动态）
- [ ] 静态路由有蓝色"静态"标签
- [ ] 菜单类型标签正确显示
- [ ] 路由来源标识正确
- [ ] API参数 `include_static=true` 生效
- [ ] 用户登录获取动态菜单（排除静态）
- [ ] 角色权限分配功能正常
- [ ] 全选/展开功能正常
- [ ] 搜索过滤功能正常
- [ ] 数据保存到数据库成功
- [ ] 原有功能未受影响

---

## 九、测试报告模板

### 测试环境
- 操作系统：macOS
- Node版本：v18+
- 数据库：MySQL 8.0
- 浏览器：Chrome 最新版

### 测试结果
| 测试项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 权限树显示静态路由 | 显示蓝色标签 | | ⏳ |
| API参数传递 | include_static=true | | ⏳ |
| 用户登录获取菜单 | 只返回动态菜单 | | ⏳ |
| 权限分配保存 | 成功保存到数据库 | | ⏳ |
| 全选功能 | 所有节点勾选 | | ⏳ |

### 发现的问题
1.
2.

### 改进建议
1.
2.

---

## 十、下一步计划

1. [ ] 添加更多静态路由模块（系统管理等）
2. [ ] 清理数据库重复数据
3. [ ] 优化权限树性能（虚拟滚动）
4. [ ] 添加权限导入导出功能
5. [ ] 编写自动化测试脚本

---

**测试完成后请将结果填写在上方表格中，并报告任何发现的问题。**
