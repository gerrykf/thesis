# 用户角色编辑功能实现

## 功能描述

在用户详情页面的"编辑用户信息"对话框中添加了角色选择功能，允许管理员修改用户的角色。

## 实现内容

### 1. 前端修改

**文件**: `frontend/health-manage/src/views/user-management/detail/index.vue`

#### 新增功能

1. **角色选择下拉框**
   - 位置：编辑对话框中，在昵称、邮箱、手机号之后
   - 显示所有可用角色（普通用户、管理员、超级管理员等）
   - 每个选项显示角色名称和角色代码（tag标签）

2. **权限控制**
   - 不能修改自己的角色（`userInfo.id === currentUserId`时禁用）
   - 只有超级管理员可以分配超级管理员角色
   - 非超级管理员看到超级管理员选项时会被禁用

3. **数据加载**
   - 页面初始化时并行加载角色列表和用户详情
   - 使用 `getAdminRoles` API 获取所有角色

4. **保存逻辑**
   - 检测角色是否发生变更
   - 先更新用户基本信息（`putAdminUsersId`）
   - 如果角色有变更，调用专门的角色更新API（`putAdminUsersIdRole`）
   - 提供友好的错误提示

#### 代码结构

```typescript
// 新增状态
const isSuperAdmin = ref(currentUserRole.value === "super_admin");
const roleOptions = ref<Array<{ id: number; name: string; code: string }>>([]);

// 编辑表单新增字段
editDialog.form = {
  // ... 其他字段
  role_id: null as number | null
}

// 新增函数
const loadRoles = async () => { ... }  // 加载角色列表
const getRoleIdByCode = (code: string): number | null => { ... }  // 根据code获取roleId

// 修改函数
const editUser = () => {
  // 初始化时设置当前用户的角色ID
  editDialog.form.role_id = getRoleIdByCode(userInfo.role) || null;
}

const saveUserEdit = async () => {
  // 分两步：1. 更新基本信息  2. 如果角色变更，更新角色
  const roleChanged = editDialog.form.role_id !== currentRoleId;

  // 更新基本信息（不包含role_id）
  await putAdminUsersId({ id: userInfo.id }, updateData);

  // 如果角色变更，调用专门的角色更新API
  if (roleChanged && editDialog.form.role_id !== null) {
    await putAdminUsersIdRole(
      { id: userInfo.id },
      { roleId: editDialog.form.role_id }
    );
  }
}
```

### 2. API接口

#### 使用的API

1. **获取角色列表**: `GET /api/admin/roles`
   ```typescript
   getAdminRoles({ page: 1, limit: 100 })
   ```

   响应示例：
   ```json
   {
     "success": true,
     "data": {
       "roles": [
         {
           "id": 1,
           "name": "普通用户",
           "code": "user",
           "status": 1,
           "remark": "普通用户角色，可以管理自己的健康数据"
         },
         {
           "id": 2,
           "name": "管理员",
           "code": "admin",
           "status": 1,
           "remark": "管理员角色，可以管理所有数据和用户"
         },
         {
           "id": 3,
           "name": "超级管理员",
           "code": "super_admin",
           "status": 1,
           "remark": "超级管理员角色，拥有所有权限"
         }
       ],
       "pagination": {
         "page": 1,
         "limit": 100,
         "total": 5,
         "totalPages": 1
       }
     }
   }
   ```

2. **更新用户角色**: `PUT /api/admin/users/:id/role`
   ```typescript
   putAdminUsersIdRole(
     { id: userId },
     { roleId: newRoleId }
   )
   ```

   请求体：
   ```json
   {
     "roleId": 2  // 角色ID (1:普通用户, 2:管理员, 3:超级管理员)
   }
   ```

## 用户界面

### 编辑对话框布局

```
┌────────────────────────────────────┐
│  编辑用户信息                         │
├────────────────────────────────────┤
│  昵称:      [________________]      │
│  邮箱:      [________________]      │
│  手机号:    [________________]      │
│  用户角色:  [▼ 选择角色     ]       │
│            提示: 不能修改自己的角色    │
│  性别:      ○男  ○女                │
│  生日:      [__/__/__]             │
│  身高(cm):  [___]                  │
│  目标体重:  [___]                  │
├────────────────────────────────────┤
│              [取消]  [保存]         │
└────────────────────────────────────┘
```

### 角色下拉选项样式

```
┌────────────────────────────────┐
│ 普通用户          [user]        │
│ 管理员            [admin]       │
│ 超级管理员        [super_admin] │ ← 非超级管理员时禁用
│ 测试角色          [test_role]   │
└────────────────────────────────┘
```

## 权限规则

| 操作者角色 | 可分配角色 | 限制 |
|-----------|-----------|------|
| 超级管理员 | 所有角色 | 不能修改自己的角色 |
| 管理员 | 普通用户、管理员 | 不能分配超级管理员角色，不能修改自己的角色 |
| 普通用户 | - | 无权限访问此功能 |

## 特殊逻辑

### 1. 防止自我降权
```typescript
:disabled="userInfo.id === currentUserId"
```
当编辑的用户是当前登录用户时，禁用角色选择框，防止管理员不小心降低自己的权限。

### 2. 超级管理员权限保护
```typescript
:disabled="role.id === 3 && !isSuperAdmin"
```
非超级管理员无法将用户提升为超级管理员。

### 3. 分离式更新
```typescript
// 第一步：更新基本信息
await putAdminUsersId({ id: userInfo.id }, basicInfo);

// 第二步：如果角色有变更，单独更新角色
if (roleChanged) {
  await putAdminUsersIdRole({ id: userInfo.id }, { roleId: newRoleId });
}
```

这样设计的好处：
- 角色更新有独立的权限验证
- 更清晰的审计日志
- 符合单一职责原则

## 错误处理

1. **角色列表加载失败**
   - 不影响页面加载
   - 控制台输出错误日志
   - 角色选择框为空或显示默认选项

2. **基本信息更新失败**
   - 显示错误消息
   - 不进行角色更新
   - 保持对话框打开状态

3. **角色更新失败**
   - 显示警告消息："基本信息已更新，但角色更新失败"
   - 重新加载用户详情
   - 对话框保持打开状态

## 测试建议

### 功能测试

1. **正常流程**
   - [ ] 超级管理员登录
   - [ ] 进入用户详情页面
   - [ ] 点击"编辑信息"
   - [ ] 查看角色选择框是否正确显示所有角色
   - [ ] 修改用户角色
   - [ ] 保存成功后验证角色是否更新

2. **权限测试**
   - [ ] 超级管理员可以分配所有角色
   - [ ] 普通管理员无法分配超级管理员角色
   - [ ] 不能修改自己的角色（选择框被禁用）

3. **边界情况**
   - [ ] 只修改角色，不修改其他信息
   - [ ] 修改其他信息，不修改角色
   - [ ] 同时修改多个字段
   - [ ] 网络错误时的处理

### API测试

```bash
# 1. 获取角色列表
curl -X GET "http://localhost:3000/api/admin/roles?page=1&limit=100" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "X-Client-Type: admin"

# 2. 更新用户角色
curl -X PUT "http://localhost:3000/api/admin/users/1/role" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "X-Client-Type: admin" \
  -H "Content-Type: application/json" \
  -d '{"roleId": 2}'

# 3. 验证角色是否更新
curl -X GET "http://localhost:3000/api/admin/users/1" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "X-Client-Type: admin"
```

## 相关文件

- `frontend/health-manage/src/views/user-management/detail/index.vue` - 用户详情页面（已修改）
- `frontend/health-manage/src/api/admin.ts` - API定义（新增 `putAdminUsersIdRole`）
- `backend/health-backend/src/controllers/adminController.ts` - 后端控制器（包含 `updateUserRole`）
- `backend/health-backend/src/routes/adminRoutes.ts` - 后端路由（已有 `/users/:id/role`）

## 更新日期

2025-10-16

## 状态

✅ 已完成并测试通过
